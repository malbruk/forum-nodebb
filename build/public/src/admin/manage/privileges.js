"use strict";define("admin/manage/privileges",["api","autocomplete","bootbox","translator","categorySelector","mousetrap","admin/modules/checkboxRowSelector"],function(e,a,t,i,r,n,o){var l={};var s;l.init=function(){s=isNaN(parseInt(ajaxify.data.selectedCategory.cid,10))?"admin":ajaxify.data.selectedCategory.cid;o.init(".privilege-table-container");r.init($('[component="category-selector"]'),{onSelect:function(e){s=parseInt(e.cid,10);s=isNaN(s)?"admin":s;l.refreshPrivilegeTable();ajaxify.updateHistory("admin/manage/privileges/"+(s||""))},localCategories:ajaxify.data.categories,privilege:"find",showLinks:true});l.setupPrivilegeTable();u()};l.setupPrivilegeTable=function(){$(".privilege-table-container").on("change",'input[type="checkbox"]:not(.checkbox-helper)',function(){var e=$(this);var a=e.parent();var i=a.attr("data-privilege");var r=e.prop("checked");var n=e.parents("tr");var s=n.attr("data-group-name")||n.attr("data-uid");var c=parseInt(n.attr("data-private")||0,10);var d=n.attr("data-group-name")!==undefined;var p=d&&n.attr("data-group-name")==="banned-users"||n.attr("data-banned")!==undefined;var u=e.prop("checked")===(a.attr("data-value")==="true")?null:r;if(s){if(d&&i==="groups:moderate"&&!c&&r){t.confirm("[[admin/manage/privileges:alert.confirm-moderate]]",function(t){if(t){a.attr("data-delta",u);l.exposeAssumedPrivileges(p)}else{e.prop("checked",!e.prop("checked"))}})}else if(i.endsWith("admin:admins-mods")&&r){t.confirm("[[admin/manage/privileges:alert.confirm-admins-mods]]",function(t){if(t){a.attr("data-delta",u);l.exposeAssumedPrivileges()}else{e.prop("checked",!e.prop("checked"))}})}else{a.attr("data-delta",u);l.exposeAssumedPrivileges(p)}o.updateState(e)}else{app.alertError("[[error:invalid-data]]")}});l.exposeAssumedPrivileges();o.updateAll();l.addEvents()};l.addEvents=function(){document.getElementById("save").addEventListener("click",function(){a("save",l.commit)});document.getElementById("discard").addEventListener("click",function(){a("discard",l.discard)});const e=document.querySelector(".privilege-table-container");e.addEventListener("change",a=>{const t=a.target.closest("td[data-privilege] input");if(t){document.getElementById("discard").style.display=e.querySelectorAll("td[data-delta]").length?"unset":"none"}});$(".privilege-table-container").on("click",'[data-action="search.user"]',l.addUserToPrivilegeTable);$(".privilege-table-container").on("click",'[data-action="search.group"]',l.addGroupToPrivilegeTable);$(".privilege-table-container").on("click",'[data-action="copyToChildren"]',function(){a("copyToChildren",l.copyPrivilegesToChildren.bind(null,s,""))});$(".privilege-table-container").on("click",'[data-action="copyToChildrenGroup"]',function(){var e=$(this).parents("[data-group-name]").attr("data-group-name");a("copyToChildrenGroup",l.copyPrivilegesToChildren.bind(null,s,e))});$(".privilege-table-container").on("click",'[data-action="copyPrivilegesFrom"]',function(){l.copyPrivilegesFromCategory(s,"")});$(".privilege-table-container").on("click",'[data-action="copyPrivilegesFromGroup"]',function(){var e=$(this).parents("[data-group-name]").attr("data-group-name");l.copyPrivilegesFromCategory(s,e)});$(".privilege-table-container").on("click",'[data-action="copyToAll"]',function(){a("copyToAll",l.copyPrivilegesToAllCategories.bind(null,s,""))});$(".privilege-table-container").on("click",'[data-action="copyToAllGroup"]',function(){var e=$(this).parents("[data-group-name]").attr("data-group-name");a("copyToAllGroup",l.copyPrivilegesToAllCategories.bind(null,s,e))});n.bind("ctrl+s",function(e){a("save",l.commit);e.preventDefault()});function a(e,a){t.confirm("[[admin/manage/privileges:alert.confirm-"+e+"]]<br /><br />[[admin/manage/privileges:alert.no-undo]]",function(e){if(e){a.call()}})}};l.commit=function(){var e=document.querySelector(".privilege-table-container");var a=$.map(e.querySelectorAll("td[data-delta]"),function(e){var a=e.getAttribute("data-privilege");var t=e.parentNode;var i=t.getAttribute("data-group-name")||t.getAttribute("data-uid");var r=e.getAttribute("data-delta")==="true"?1:0;return l.setPrivilege(i,a,r)});Promise.allSettled(a).then(e=>{l.refreshPrivilegeTable();const a=e.filter(e=>e.status==="rejected");if(a.length){a.forEach(e=>{app.alertError(e.reason)})}else{app.alertSuccess("[[admin/manage/privileges:alert.saved]]")}})};l.discard=function(){l.refreshPrivilegeTable();app.alertSuccess("[[admin/manage/privileges:alert.discarded]]")};l.refreshPrivilegeTable=function(a){e.get(`/categories/${s}/privileges`,{}).then(e=>{ajaxify.data.privileges={...ajaxify.data.privileges,...e};var t=parseInt(s,10)?"admin/partials/privileges/category":"admin/partials/privileges/global";app.parseAndTranslate(t,{privileges:e}).then(e=>{$(".privilege-table-container").html(e);l.exposeAssumedPrivileges();o.updateAll();p("data-group-name",a)})}).catch(app.alertError)};l.exposeAssumedPrivileges=function(e){if(e===undefined||e===true){const a=(e,a)=>`.privilege-table tr[data-banned] td[data-privilege="${e[a]}"] input`;const t=c("banned-users");d(t,a);if(e===true){return}}const a=(e,a)=>`.privilege-table tr[data-group-name]:not([data-group-name="registered-users"],[data-group-name="banned-users"],[data-group-name="guests"],[data-group-name="spiders"]) td[data-privilege="${e[a]}"] input, .privilege-table tr[data-uid]:not([data-banned]) td[data-privilege="${e[a]}"] input`;const t=c("registered-users");d(t,a)};l.setPrivilege=((a,t,i)=>e[i?"put":"delete"](`/categories/${isNaN(s)?0:s}/privileges/${t}`,{member:a}));l.addUserToPrivilegeTable=function(){var e=t.dialog({title:"[[admin/manage/categories:alert.find-user]]",message:'<input class="form-control input-lg" placeholder="[[admin/manage/categories:alert.user-search]]" />',show:true});e.on("shown.bs.modal",function(){var t=e.find("input");t.focus();a.user(t,function(a,t){m(t.item.user,function(){e.modal("hide")})})})};l.addGroupToPrivilegeTable=function(){var e=t.dialog({title:"[[admin/manage/categories:alert.find-group]]",message:'<input class="form-control input-lg" placeholder="[[admin/manage/categories:alert.group-search]]" />',show:true});e.on("shown.bs.modal",function(){var t=e.find("input");t.focus();a.group(t,function(a,t){if(t.item.group.name==="administrators"){return app.alert({type:"warning",message:"[[admin/manage/privileges:alert.admin-warning]]"})}g(t.item.group.name,function(){e.modal("hide")})})})};l.copyPrivilegesToChildren=function(e,a){socket.emit("admin.categories.copyPrivilegesToChildren",{cid:e,group:a},function(e){if(e){return app.alertError(e.message)}app.alertSuccess("[[admin/manage/categories:privileges.copy-success]]")})};l.copyPrivilegesFromCategory=function(e,a){r.modal({localCategories:[],showLinks:true,onSubmit:function(t){socket.emit("admin.categories.copyPrivilegesFrom",{toCid:e,fromCid:t.cid,group:a},function(e){if(e){return app.alertError(e.message)}ajaxify.refresh()})}})};l.copyPrivilegesToAllCategories=function(e,a){socket.emit("admin.categories.copyPrivilegesToAllCategories",{cid:e,group:a},function(e){if(e){return app.alertError(e.message)}app.alertSuccess("[[admin/manage/categories:privileges.copy-success]]")})};function c(e){const a=[];$(`.privilege-table tr[data-group-name="${e}"] td input[type="checkbox"]:not(.checkbox-helper)`).parent().each(function(e,t){if($(t).find("input").prop("checked")){a.push(t.getAttribute("data-privilege"))}});return a.concat(a.map(function(e){if(e.startsWith("groups:")){return e.slice(7)}return false})).filter(Boolean)}function d(e,a){for(let t=0,i=e.length;t<i;t+=1){const i=$(a(e,t));i.each(function(e,a){if(!a.checked){a.indeterminate=true}})}}function p(e,a){if(a){var t=$("["+e+"]").filter(function(){return $(this).attr(e)===String(a)});if(t.length){t.addClass("selected");return true}}return false}function u(){if(ajaxify.data.group){if(p("data-group-name",ajaxify.data.group)){return}g(ajaxify.data.group)}}function g(e,a){a=a||function(){};var t=document.querySelector('.privilege-table [data-group-name="'+e+'"]');if(t){p("data-group-name",e);return a()}var r=ajaxify.data.privileges.keys.groups.reduce(function(e,a){e[a]=false;return e},{});app.parseAndTranslate("admin/partials/privileges/"+(isNaN(s)||s===0?"global":"category"),"privileges.groups",{privileges:{groups:[{name:e,nameEscaped:i.escape(e),privileges:r}]}},function(t){var i=document.querySelector(".privilege-table tbody");i.append(t.get(0));l.exposeAssumedPrivileges();p("data-group-name",e);a()})}async function m(e,a){a=a||function(){};var t=document.querySelector('.privilege-table [data-uid="'+e.uid+'"]');if(t){p("data-uid",e.uid);return a()}var i=ajaxify.data.privileges.keys.users.reduce(function(e,a){e[a]=false;return e},{});const r=await app.parseAndTranslate("admin/partials/privileges/"+(isNaN(s)?"global":"category"),"privileges.users",{privileges:{users:[{picture:e.picture,username:e.username,banned:e.banned,uid:e.uid,"icon:text":e["icon:text"],"icon:bgColor":e["icon:bgColor"],privileges:i}]}});var n=document.querySelectorAll(".privilege-table tbody");n[1].append(r.get(0));l.exposeAssumedPrivileges();p("data-uid",e.uid);a()}return l});
//# sourceMappingURL=privileges.js.map