{"version":3,"sources":["public/src/admin/manage/privileges.js"],"names":["define","api","autocomplete","bootbox","translator","categorySelector","mousetrap","checkboxRowSelector","Privileges","cid","init","isNaN","parseInt","ajaxify","data","selectedCategory","$","onSelect","category","refreshPrivilegeTable","updateHistory","localCategories","categories","privilege","showLinks","setupPrivilegeTable","highlightRow","on","checkboxEl","this","wrapperEl","parent","attr","state","prop","rowEl","parents","member","isPrivate","isGroup","undefined","isBanned","delta","confirm","exposeAssumedPrivileges","endsWith","updateState","app","alertError","updateAll","addEvents","document","getElementById","addEventListener","throwConfirmModal","commit","discard","containerEl","querySelector","e","subselector","target","closest","style","display","querySelectorAll","length","addUserToPrivilegeTable","addGroupToPrivilegeTable","copyPrivilegesToChildren","bind","groupName","copyPrivilegesFromCategory","copyPrivilegesToAllCategories","ev","preventDefault","method","onConfirm","ok","call","tableEl","requests","map","el","getAttribute","parentNode","setPrivilege","Promise","allSettled","then","results","rejects","filter","r","status","forEach","result","reason","alertSuccess","groupToHighlight","get","privileges","tpl","parseAndTranslate","html","hightlightRowByDataAttr","catch","getBannedUsersInputSelector","privs","i","bannedUsersPrivs","getPrivilegesFromRow","applyPrivileges","getRegisteredUsersInputSelector","registeredUsersPrivs","modal","dialog","title","message","show","inputEl","find","focus","user","ui","addUserToCategory","item","group","name","alert","type","addGroupToCategory","socket","emit","err","onSubmit","toCid","fromCid","refresh","sourceGroupName","each","idx","push","concat","priv","startsWith","slice","Boolean","inputSelectorFn","x","numPrivs","inputs","checked","indeterminate","attrName","attrValue","String","addClass","cb","groupRow","privilegeSet","keys","groups","reduce","memo","cur","nameEscaped","escape","tbodyEl","append","async","userRow","uid","users","picture","username","banned","icon:text","icon:bgColor"],"mappings":"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","file":"public/src/admin/manage/privileges.js","sourcesContent":["'use strict';\r\n\r\ndefine('admin/manage/privileges', [\r\n\t'api',\r\n\t'autocomplete',\r\n\t'bootbox',\r\n\t'translator',\r\n\t'categorySelector',\r\n\t'mousetrap',\r\n\t'admin/modules/checkboxRowSelector',\r\n], function (api, autocomplete, bootbox, translator, categorySelector, mousetrap, checkboxRowSelector) {\r\n\tvar Privileges = {};\r\n\r\n\tvar cid;\r\n\r\n\tPrivileges.init = function () {\r\n\t\tcid = isNaN(parseInt(ajaxify.data.selectedCategory.cid, 10)) ? 'admin' : ajaxify.data.selectedCategory.cid;\r\n\r\n\t\tcheckboxRowSelector.init('.privilege-table-container');\r\n\r\n\t\tcategorySelector.init($('[component=\"category-selector\"]'), {\r\n\t\t\tonSelect: function (category) {\r\n\t\t\t\tcid = parseInt(category.cid, 10);\r\n\t\t\t\tcid = isNaN(cid) ? 'admin' : cid;\r\n\t\t\t\tPrivileges.refreshPrivilegeTable();\r\n\t\t\t\tajaxify.updateHistory('admin/manage/privileges/' + (cid || ''));\r\n\t\t\t},\r\n\t\t\tlocalCategories: ajaxify.data.categories,\r\n\t\t\tprivilege: 'find',\r\n\t\t\tshowLinks: true,\r\n\t\t});\r\n\r\n\t\tPrivileges.setupPrivilegeTable();\r\n\r\n\t\thighlightRow();\r\n\t};\r\n\r\n\tPrivileges.setupPrivilegeTable = function () {\r\n\t\t$('.privilege-table-container').on('change', 'input[type=\"checkbox\"]:not(.checkbox-helper)', function () {\r\n\t\t\tvar checkboxEl = $(this);\r\n\t\t\tvar wrapperEl = checkboxEl.parent();\r\n\t\t\tvar privilege = wrapperEl.attr('data-privilege');\r\n\t\t\tvar state = checkboxEl.prop('checked');\r\n\t\t\tvar rowEl = checkboxEl.parents('tr');\r\n\t\t\tvar member = rowEl.attr('data-group-name') || rowEl.attr('data-uid');\r\n\t\t\tvar isPrivate = parseInt(rowEl.attr('data-private') || 0, 10);\r\n\t\t\tvar isGroup = rowEl.attr('data-group-name') !== undefined;\r\n\t\t\tvar isBanned = (isGroup && rowEl.attr('data-group-name') === 'banned-users') || rowEl.attr('data-banned') !== undefined;\r\n\t\t\tvar delta = checkboxEl.prop('checked') === (wrapperEl.attr('data-value') === 'true') ? null : state;\r\n\r\n\t\t\tif (member) {\r\n\t\t\t\tif (isGroup && privilege === 'groups:moderate' && !isPrivate && state) {\r\n\t\t\t\t\tbootbox.confirm('[[admin/manage/privileges:alert.confirm-moderate]]', function (confirm) {\r\n\t\t\t\t\t\tif (confirm) {\r\n\t\t\t\t\t\t\twrapperEl.attr('data-delta', delta);\r\n\t\t\t\t\t\t\tPrivileges.exposeAssumedPrivileges(isBanned);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tcheckboxEl.prop('checked', !checkboxEl.prop('checked'));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (privilege.endsWith('admin:admins-mods') && state) {\r\n\t\t\t\t\tbootbox.confirm('[[admin/manage/privileges:alert.confirm-admins-mods]]', function (confirm) {\r\n\t\t\t\t\t\tif (confirm) {\r\n\t\t\t\t\t\t\twrapperEl.attr('data-delta', delta);\r\n\t\t\t\t\t\t\tPrivileges.exposeAssumedPrivileges();\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tcheckboxEl.prop('checked', !checkboxEl.prop('checked'));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\twrapperEl.attr('data-delta', delta);\r\n\t\t\t\t\tPrivileges.exposeAssumedPrivileges(isBanned);\r\n\t\t\t\t}\r\n\t\t\t\tcheckboxRowSelector.updateState(checkboxEl);\r\n\t\t\t} else {\r\n\t\t\t\tapp.alertError('[[error:invalid-data]]');\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tPrivileges.exposeAssumedPrivileges();\r\n\t\tcheckboxRowSelector.updateAll();\r\n\t\tPrivileges.addEvents();\t// events with confirmation modals\r\n\t};\r\n\r\n\tPrivileges.addEvents = function () {\r\n\t\tdocument.getElementById('save').addEventListener('click', function () {\r\n\t\t\tthrowConfirmModal('save', Privileges.commit);\r\n\t\t});\r\n\r\n\t\tdocument.getElementById('discard').addEventListener('click', function () {\r\n\t\t\tthrowConfirmModal('discard', Privileges.discard);\r\n\t\t});\r\n\r\n\t\t// Expose discard button as necessary\r\n\t\tconst containerEl = document.querySelector('.privilege-table-container');\r\n\t\tcontainerEl.addEventListener('change', (e) => {\r\n\t\t\tconst subselector = e.target.closest('td[data-privilege] input');\r\n\t\t\tif (subselector) {\r\n\t\t\t\tdocument.getElementById('discard').style.display = containerEl.querySelectorAll('td[data-delta]').length ? 'unset' : 'none';\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$('.privilege-table-container').on('click', '[data-action=\"search.user\"]', Privileges.addUserToPrivilegeTable);\r\n\t\t$('.privilege-table-container').on('click', '[data-action=\"search.group\"]', Privileges.addGroupToPrivilegeTable);\r\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyToChildren\"]', function () {\r\n\t\t\tthrowConfirmModal('copyToChildren', Privileges.copyPrivilegesToChildren.bind(null, cid, ''));\r\n\t\t});\r\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyToChildrenGroup\"]', function () {\r\n\t\t\tvar groupName = $(this).parents('[data-group-name]').attr('data-group-name');\r\n\t\t\tthrowConfirmModal('copyToChildrenGroup', Privileges.copyPrivilegesToChildren.bind(null, cid, groupName));\r\n\t\t});\r\n\r\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyPrivilegesFrom\"]', function () {\r\n\t\t\tPrivileges.copyPrivilegesFromCategory(cid, '');\r\n\t\t});\r\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyPrivilegesFromGroup\"]', function () {\r\n\t\t\tvar groupName = $(this).parents('[data-group-name]').attr('data-group-name');\r\n\t\t\tPrivileges.copyPrivilegesFromCategory(cid, groupName);\r\n\t\t});\r\n\r\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyToAll\"]', function () {\r\n\t\t\tthrowConfirmModal('copyToAll', Privileges.copyPrivilegesToAllCategories.bind(null, cid, ''));\r\n\t\t});\r\n\t\t$('.privilege-table-container').on('click', '[data-action=\"copyToAllGroup\"]', function () {\r\n\t\t\tvar groupName = $(this).parents('[data-group-name]').attr('data-group-name');\r\n\t\t\tthrowConfirmModal('copyToAllGroup', Privileges.copyPrivilegesToAllCategories.bind(null, cid, groupName));\r\n\t\t});\r\n\r\n\t\tmousetrap.bind('ctrl+s', function (ev) {\r\n\t\t\tthrowConfirmModal('save', Privileges.commit);\r\n\t\t\tev.preventDefault();\r\n\t\t});\r\n\r\n\t\tfunction throwConfirmModal(method, onConfirm) {\r\n\t\t\tbootbox.confirm('[[admin/manage/privileges:alert.confirm-' + method + ']]<br /><br />[[admin/manage/privileges:alert.no-undo]]', function (ok) {\r\n\t\t\t\tif (ok) {\r\n\t\t\t\t\tonConfirm.call();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n\r\n\tPrivileges.commit = function () {\r\n\t\tvar tableEl = document.querySelector('.privilege-table-container');\r\n\t\tvar requests = $.map(tableEl.querySelectorAll('td[data-delta]'), function (el) {\r\n\t\t\tvar privilege = el.getAttribute('data-privilege');\r\n\t\t\tvar rowEl = el.parentNode;\r\n\t\t\tvar member = rowEl.getAttribute('data-group-name') || rowEl.getAttribute('data-uid');\r\n\t\t\tvar state = el.getAttribute('data-delta') === 'true' ? 1 : 0;\r\n\r\n\t\t\treturn Privileges.setPrivilege(member, privilege, state);\r\n\t\t});\r\n\r\n\t\tPromise.allSettled(requests).then((results) => {\r\n\t\t\tPrivileges.refreshPrivilegeTable();\r\n\r\n\t\t\tconst rejects = results.filter(r => r.status === 'rejected');\r\n\t\t\tif (rejects.length) {\r\n\t\t\t\trejects.forEach((result) => {\r\n\t\t\t\t\tapp.alertError(result.reason);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tapp.alertSuccess('[[admin/manage/privileges:alert.saved]]');\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tPrivileges.discard = function () {\r\n\t\tPrivileges.refreshPrivilegeTable();\r\n\t\tapp.alertSuccess('[[admin/manage/privileges:alert.discarded]]');\r\n\t};\r\n\r\n\tPrivileges.refreshPrivilegeTable = function (groupToHighlight) {\r\n\t\tapi.get(`/categories/${cid}/privileges`, {}).then((privileges) => {\r\n\t\t\tajaxify.data.privileges = { ...ajaxify.data.privileges, ...privileges };\r\n\t\t\tvar tpl = parseInt(cid, 10) ? 'admin/partials/privileges/category' : 'admin/partials/privileges/global';\r\n\t\t\tapp.parseAndTranslate(tpl, { privileges }).then((html) => {\r\n\t\t\t\t$('.privilege-table-container').html(html);\r\n\t\t\t\tPrivileges.exposeAssumedPrivileges();\r\n\t\t\t\tcheckboxRowSelector.updateAll();\r\n\r\n\t\t\t\thightlightRowByDataAttr('data-group-name', groupToHighlight);\r\n\t\t\t});\r\n\t\t}).catch(app.alertError);\r\n\t};\r\n\r\n\tPrivileges.exposeAssumedPrivileges = function (isBanned) {\r\n\t\t/*\r\n\t\t\tIf registered-users has a privilege enabled, then all users and groups of that privilege\r\n\t\t\tshould be assumed to have that privilege as well, even if not set in the db, so reflect\r\n\t\t\tthis arrangement in the table\r\n\t\t*/\r\n\r\n\t\t// As such, individual banned users inherits privileges from banned-users group\r\n\t\t// Running this block only when needed\r\n\t\tif (isBanned === undefined || isBanned === true) {\r\n\t\t\tconst getBannedUsersInputSelector = (privs, i) => `.privilege-table tr[data-banned] td[data-privilege=\"${privs[i]}\"] input`;\r\n\t\t\tconst bannedUsersPrivs = getPrivilegesFromRow('banned-users');\r\n\t\t\tapplyPrivileges(bannedUsersPrivs, getBannedUsersInputSelector);\r\n\t\t\tif (isBanned === true) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst getRegisteredUsersInputSelector = (privs, i) => `.privilege-table tr[data-group-name]:not([data-group-name=\"registered-users\"],[data-group-name=\"banned-users\"],[data-group-name=\"guests\"],[data-group-name=\"spiders\"]) td[data-privilege=\"${privs[i]}\"] input, .privilege-table tr[data-uid]:not([data-banned]) td[data-privilege=\"${privs[i]}\"] input`;\r\n\t\tconst registeredUsersPrivs = getPrivilegesFromRow('registered-users');\r\n\t\tapplyPrivileges(registeredUsersPrivs, getRegisteredUsersInputSelector);\r\n\t};\r\n\r\n\tPrivileges.setPrivilege = (member, privilege, state) => api[state ? 'put' : 'delete'](`/categories/${isNaN(cid) ? 0 : cid}/privileges/${privilege}`, { member });\r\n\r\n\tPrivileges.addUserToPrivilegeTable = function () {\r\n\t\tvar modal = bootbox.dialog({\r\n\t\t\ttitle: '[[admin/manage/categories:alert.find-user]]',\r\n\t\t\tmessage: '<input class=\"form-control input-lg\" placeholder=\"[[admin/manage/categories:alert.user-search]]\" />',\r\n\t\t\tshow: true,\r\n\t\t});\r\n\r\n\t\tmodal.on('shown.bs.modal', function () {\r\n\t\t\tvar inputEl = modal.find('input');\r\n\t\t\tinputEl.focus();\r\n\r\n\t\t\tautocomplete.user(inputEl, function (ev, ui) {\r\n\t\t\t\taddUserToCategory(ui.item.user, function () {\r\n\t\t\t\t\tmodal.modal('hide');\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tPrivileges.addGroupToPrivilegeTable = function () {\r\n\t\tvar modal = bootbox.dialog({\r\n\t\t\ttitle: '[[admin/manage/categories:alert.find-group]]',\r\n\t\t\tmessage: '<input class=\"form-control input-lg\" placeholder=\"[[admin/manage/categories:alert.group-search]]\" />',\r\n\t\t\tshow: true,\r\n\t\t});\r\n\r\n\t\tmodal.on('shown.bs.modal', function () {\r\n\t\t\tvar inputEl = modal.find('input');\r\n\t\t\tinputEl.focus();\r\n\r\n\t\t\tautocomplete.group(inputEl, function (ev, ui) {\r\n\t\t\t\tif (ui.item.group.name === 'administrators') {\r\n\t\t\t\t\treturn app.alert({\r\n\t\t\t\t\t\ttype: 'warning',\r\n\t\t\t\t\t\tmessage: '[[admin/manage/privileges:alert.admin-warning]]',\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\taddGroupToCategory(ui.item.group.name, function () {\r\n\t\t\t\t\tmodal.modal('hide');\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tPrivileges.copyPrivilegesToChildren = function (cid, group) {\r\n\t\tsocket.emit('admin.categories.copyPrivilegesToChildren', { cid: cid, group: group }, function (err) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\t\t\tapp.alertSuccess('[[admin/manage/categories:privileges.copy-success]]');\r\n\t\t});\r\n\t};\r\n\r\n\tPrivileges.copyPrivilegesFromCategory = function (cid, group) {\r\n\t\tcategorySelector.modal({\r\n\t\t\tlocalCategories: [],\r\n\t\t\tshowLinks: true,\r\n\t\t\tonSubmit: function (selectedCategory) {\r\n\t\t\t\tsocket.emit('admin.categories.copyPrivilegesFrom', {\r\n\t\t\t\t\ttoCid: cid,\r\n\t\t\t\t\tfromCid: selectedCategory.cid,\r\n\t\t\t\t\tgroup: group,\r\n\t\t\t\t}, function (err) {\r\n\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tajaxify.refresh();\r\n\t\t\t\t});\r\n\t\t\t},\r\n\t\t});\r\n\t};\r\n\r\n\tPrivileges.copyPrivilegesToAllCategories = function (cid, group) {\r\n\t\tsocket.emit('admin.categories.copyPrivilegesToAllCategories', { cid: cid, group: group }, function (err) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\t\t\tapp.alertSuccess('[[admin/manage/categories:privileges.copy-success]]');\r\n\t\t});\r\n\t};\r\n\r\n\tfunction getPrivilegesFromRow(sourceGroupName) {\r\n\t\tconst privs = [];\r\n\t\t$(`.privilege-table tr[data-group-name=\"${sourceGroupName}\"] td input[type=\"checkbox\"]:not(.checkbox-helper)`)\r\n\t\t\t.parent()\r\n\t\t\t.each(function (idx, el) {\r\n\t\t\t\tif ($(el).find('input').prop('checked')) {\r\n\t\t\t\t\tprivs.push(el.getAttribute('data-privilege'));\r\n\t\t\t\t}\r\n\t\t\t});\r\n\r\n\t\t// Also apply to non-group privileges\r\n\t\treturn privs.concat(privs.map(function (priv) {\r\n\t\t\tif (priv.startsWith('groups:')) {\r\n\t\t\t\treturn priv.slice(7);\r\n\t\t\t}\r\n\r\n\t\t\treturn false;\r\n\t\t})).filter(Boolean);\r\n\t}\r\n\r\n\tfunction applyPrivileges(privs, inputSelectorFn) {\r\n\t\tfor (let x = 0, numPrivs = privs.length; x < numPrivs; x += 1) {\r\n\t\t\tconst inputs = $(inputSelectorFn(privs, x));\r\n\t\t\tinputs.each(function (idx, el) {\r\n\t\t\t\tif (!el.checked) {\r\n\t\t\t\t\tel.indeterminate = true;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tfunction hightlightRowByDataAttr(attrName, attrValue) {\r\n\t\tif (attrValue) {\r\n\t\t\tvar el = $('[' + attrName + ']').filter(function () {\r\n\t\t\t\treturn $(this).attr(attrName) === String(attrValue);\r\n\t\t\t});\r\n\r\n\t\t\tif (el.length) {\r\n\t\t\t\tel.addClass('selected');\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\tfunction highlightRow() {\r\n\t\tif (ajaxify.data.group) {\r\n\t\t\tif (hightlightRowByDataAttr('data-group-name', ajaxify.data.group)) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\taddGroupToCategory(ajaxify.data.group);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction addGroupToCategory(group, cb) {\r\n\t\tcb = cb || function () {};\r\n\t\tvar groupRow = document.querySelector('.privilege-table [data-group-name=\"' + group + '\"]');\r\n\t\tif (groupRow) {\r\n\t\t\thightlightRowByDataAttr('data-group-name', group);\r\n\t\t\treturn cb();\r\n\t\t}\r\n\t\t// Generate data for new row\r\n\t\tvar privilegeSet = ajaxify.data.privileges.keys.groups.reduce(function (memo, cur) {\r\n\t\t\tmemo[cur] = false;\r\n\t\t\treturn memo;\r\n\t\t}, {});\r\n\r\n\t\tapp.parseAndTranslate('admin/partials/privileges/' + ((isNaN(cid) || cid === 0) ? 'global' : 'category'), 'privileges.groups', {\r\n\t\t\tprivileges: {\r\n\t\t\t\tgroups: [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tname: group,\r\n\t\t\t\t\t\tnameEscaped: translator.escape(group),\r\n\t\t\t\t\t\tprivileges: privilegeSet,\r\n\t\t\t\t\t},\r\n\t\t\t\t],\r\n\t\t\t},\r\n\t\t}, function (html) {\r\n\t\t\tvar tbodyEl = document.querySelector('.privilege-table tbody');\r\n\t\t\ttbodyEl.append(html.get(0));\r\n\t\t\tPrivileges.exposeAssumedPrivileges();\r\n\t\t\thightlightRowByDataAttr('data-group-name', group);\r\n\t\t\tcb();\r\n\t\t});\r\n\t}\r\n\r\n\tasync function addUserToCategory(user, cb) {\r\n\t\tcb = cb || function () {};\r\n\t\tvar userRow = document.querySelector('.privilege-table [data-uid=\"' + user.uid + '\"]');\r\n\t\tif (userRow) {\r\n\t\t\thightlightRowByDataAttr('data-uid', user.uid);\r\n\t\t\treturn cb();\r\n\t\t}\r\n\t\t// Generate data for new row\r\n\t\tvar privilegeSet = ajaxify.data.privileges.keys.users.reduce(function (memo, cur) {\r\n\t\t\tmemo[cur] = false;\r\n\t\t\treturn memo;\r\n\t\t}, {});\r\n\r\n\t\tconst html = await app.parseAndTranslate('admin/partials/privileges/' + (isNaN(cid) ? 'global' : 'category'), 'privileges.users', {\r\n\t\t\tprivileges: {\r\n\t\t\t\tusers: [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tpicture: user.picture,\r\n\t\t\t\t\t\tusername: user.username,\r\n\t\t\t\t\t\tbanned: user.banned,\r\n\t\t\t\t\t\tuid: user.uid,\r\n\t\t\t\t\t\t'icon:text': user['icon:text'],\r\n\t\t\t\t\t\t'icon:bgColor': user['icon:bgColor'],\r\n\t\t\t\t\t\tprivileges: privilegeSet,\r\n\t\t\t\t\t},\r\n\t\t\t\t],\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tvar tbodyEl = document.querySelectorAll('.privilege-table tbody');\r\n\t\ttbodyEl[1].append(html.get(0));\r\n\t\tPrivileges.exposeAssumedPrivileges();\r\n\t\thightlightRowByDataAttr('data-uid', user.uid);\r\n\t\tcb();\r\n\t}\r\n\r\n\treturn Privileges;\r\n});\r\n"]}