{"version":3,"sources":["public/src/admin/modules/search.js"],"names":["define","mousetrap","search","find","dict","term","html","filter","elem","translations","toLowerCase","includes","map","params","namespace","title","escaped","utils","escapeRegexChars","results","replace","RegExp","trim","config","relative_path","join","init","app","user","privileges","socket","emit","err","alertError","setupACPSearch","dropdown","$","menu","input","searchEnabled","addClass","on","parents","ev","selected","attr","length","first","href","escape","val","ajaxify","go","setTimeout","removeClass","blur","preventDefault","bind","select","key","next","parent","prev","children","last","getBoundingClientRect","top","scrollIntoView","bottom","prevValue","value","remove","len","test","toggleClass","prepend","not","text"],"mappings":"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","file":"public/src/admin/modules/search.js","sourcesContent":["'use strict';\r\n\r\ndefine('admin/modules/search', ['mousetrap'], function (mousetrap) {\r\n\tvar search = {};\r\n\r\n\tfunction find(dict, term) {\r\n\t\tvar html = dict.filter(function (elem) {\r\n\t\t\treturn elem.translations.toLowerCase().includes(term);\r\n\t\t}).map(function (params) {\r\n\t\t\tvar namespace = params.namespace;\r\n\t\t\tvar translations = params.translations;\r\n\t\t\tvar title = params.title;\r\n\t\t\tvar escaped = utils.escapeRegexChars(term);\r\n\r\n\t\t\tvar results = translations\r\n\t\t\t\t// remove all lines without a match\r\n\t\t\t\t.replace(new RegExp('^(?:(?!' + escaped + ').)*$', 'gmi'), '')\r\n\t\t\t\t// remove lines that only match the title\r\n\t\t\t\t.replace(new RegExp('(^|\\\\n).*?' + title + '.*?(\\\\n|$)', 'g'), '')\r\n\t\t\t\t// get up to 25 characters of context on both sides of the match\r\n\t\t\t\t// and wrap the match in a `.search-match` element\r\n\t\t\t\t.replace(\r\n\t\t\t\t\tnew RegExp('^[\\\\s\\\\S]*?(.{0,25})(' + escaped + ')(.{0,25})[\\\\s\\\\S]*?$', 'gmi'),\r\n\t\t\t\t\t'...$1<span class=\"search-match\">$2</span>$3...<br>'\r\n\t\t\t\t)\r\n\t\t\t\t// collapse whitespace\r\n\t\t\t\t.replace(/(?:\\n ?)+/g, '\\n')\r\n\t\t\t\t.trim();\r\n\r\n\t\t\ttitle = title.replace(\r\n\t\t\t\tnew RegExp('(^.*?)(' + escaped + ')(.*?$)', 'gi'),\r\n\t\t\t\t'$1<span class=\"search-match\">$2</span>$3'\r\n\t\t\t);\r\n\r\n\t\t\treturn '<li role=\"presentation\" class=\"result\">' +\r\n\t\t\t\t'<a role= \"menuitem\" href= \"' + config.relative_path + '/' + namespace + '\" >' +\r\n\t\t\t\t\ttitle +\r\n\t\t\t\t\t'<br>' + (!results ? '' :\r\n\t\t\t\t('<small><code>' +\r\n\t\t\t\t\t\tresults +\r\n\t\t\t\t\t'</small></code>')) +\r\n\t\t\t\t'</a>' +\r\n\t\t\t'</li>';\r\n\t\t}).join('');\r\n\t\treturn html;\r\n\t}\r\n\r\n\tsearch.init = function () {\r\n\t\tif (!app.user.privileges['admin:settings']) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tsocket.emit('admin.getSearchDict', {}, function (err, dict) {\r\n\t\t\tif (err) {\r\n\t\t\t\tapp.alertError(err);\r\n\t\t\t\tthrow err;\r\n\t\t\t}\r\n\t\t\tsetupACPSearch(dict);\r\n\t\t});\r\n\t};\r\n\r\n\tfunction setupACPSearch(dict) {\r\n\t\tvar dropdown = $('#acp-search .dropdown');\r\n\t\tvar menu = $('#acp-search .dropdown-menu');\r\n\t\tvar input = $('#acp-search input');\r\n\r\n\t\tif (!config.searchEnabled) {\r\n\t\t\tmenu.addClass('search-disabled');\r\n\t\t}\r\n\r\n\t\tinput.on('keyup', function () {\r\n\t\t\tdropdown.addClass('open');\r\n\t\t});\r\n\r\n\t\t$('#acp-search').parents('form').on('submit', function (ev) {\r\n\t\t\tvar selected = menu.find('li.result > a.focus').attr('href');\r\n\t\t\tif (!selected.length) {\r\n\t\t\t\tselected = menu.find('li.result > a').first().attr('href');\r\n\t\t\t}\r\n\t\t\tvar href = selected || config.relative_path + '/search?in=titlesposts&term=' + escape(input.val());\r\n\r\n\t\t\tajaxify.go(href.replace(/^\\//, ''));\r\n\r\n\t\t\tsetTimeout(function () {\r\n\t\t\t\tdropdown.removeClass('open');\r\n\t\t\t\tinput.blur();\r\n\t\t\t}, 150);\r\n\r\n\t\t\tev.preventDefault();\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tmousetrap.bind('/', function (ev) {\r\n\t\t\tinput.select();\r\n\t\t\tev.preventDefault();\r\n\t\t});\r\n\r\n\t\tmousetrap(input[0]).bind(['up', 'down'], function (ev, key) {\r\n\t\t\tvar next;\r\n\t\t\tif (key === 'up') {\r\n\t\t\t\tnext = menu.find('li.result > a.focus').removeClass('focus').parent().prev('.result')\r\n\t\t\t\t\t.children();\r\n\t\t\t\tif (!next.length) {\r\n\t\t\t\t\tnext = menu.find('li.result > a').last();\r\n\t\t\t\t}\r\n\t\t\t\tnext.addClass('focus');\r\n\t\t\t\tif (menu[0].getBoundingClientRect().top > next[0].getBoundingClientRect().top) {\r\n\t\t\t\t\tnext[0].scrollIntoView(true);\r\n\t\t\t\t}\r\n\t\t\t} else if (key === 'down') {\r\n\t\t\t\tnext = menu.find('li.result > a.focus').removeClass('focus').parent().next('.result')\r\n\t\t\t\t\t.children();\r\n\t\t\t\tif (!next.length) {\r\n\t\t\t\t\tnext = menu.find('li.result > a').first();\r\n\t\t\t\t}\r\n\t\t\t\tnext.addClass('focus');\r\n\t\t\t\tif (menu[0].getBoundingClientRect().bottom < next[0].getBoundingClientRect().bottom) {\r\n\t\t\t\t\tnext[0].scrollIntoView(false);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tev.preventDefault();\r\n\t\t});\r\n\r\n\t\tvar prevValue;\r\n\r\n\t\tinput.on('keyup focus', function () {\r\n\t\t\tvar value = input.val().toLowerCase();\r\n\r\n\t\t\tif (value === prevValue) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tprevValue = value;\r\n\r\n\t\t\tmenu.children('.result').remove();\r\n\r\n\t\t\tvar len = /\\W/.test(value) ? 3 : value.length;\r\n\t\t\tvar results;\r\n\r\n\t\t\tmenu.toggleClass('state-start-typing', len === 0);\r\n\t\t\tmenu.toggleClass('state-keep-typing', len > 0 && len < 3);\r\n\r\n\t\t\tif (len >= 3) {\r\n\t\t\t\tmenu.prepend(find(dict, value));\r\n\r\n\t\t\t\tresults = menu.children('.result').length;\r\n\r\n\t\t\t\tmenu.toggleClass('state-no-results', !results);\r\n\t\t\t\tmenu.toggleClass('state-yes-results', !!results);\r\n\r\n\t\t\t\tmenu.find('.search-forum')\r\n\t\t\t\t\t.not('.divider')\r\n\t\t\t\t\t.find('a')\r\n\t\t\t\t\t.attr('href', config.relative_path + '/search?in=titlesposts&term=' + escape(value))\r\n\t\t\t\t\t.find('strong')\r\n\t\t\t\t\t.text(value);\r\n\t\t\t} else {\r\n\t\t\t\tmenu.removeClass('state-no-results state-yes-results');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\treturn search;\r\n});\r\n"]}