{"version":3,"sources":["public/src/client/category/tools.js"],"names":["define","topicSelect","threadTools","components","translator","api","bootbox","CategoryTools","init","updateDropdownOptions","handlePinnedTopicSort","get","on","categoryCommand","onDeletePurgeComplete","onCommandComplete","tids","getSelectedTids","length","app","alertError","socket","emit","err","message","alertSuccess","forEach","tid","$","addClass","require","move","cid","ajaxify","data","template","category","refresh","merge","addTopic","removeListeners","setDeleteState","onTopicPurged","setLockedState","setPinnedState","onTopicMoved","method","path","command","onComplete","body","execute","ok","Promise","all","map","then","catch","confirm","requestPinExpiry","bind","removeListener","closeDropDown","find","trigger","unselectAll","isAnyDeleted","isAny","isTopicDeleted","areAllDeleted","areAll","isAnyPinned","isTopicPinned","isAnyLocked","isTopicLocked","isAnyScheduled","isTopicScheduled","areAllScheduled","toggleClass","i","getTopicEl","hasClass","topic","isDeleted","isPinned","isLocked","remove","topics","numPinned","reduce","memo","pinned","user","isAdmin","isMod","loadJQueryUI","topicListEl","filter","e","parents","sortable","handle","items","update","pinnedTopics","each","index","element","push","attr","order"],"mappings":"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","file":"public/src/client/category/tools.js","sourcesContent":["\r\n'use strict';\r\n\r\n\r\ndefine('forum/category/tools', [\r\n\t'topicSelect',\r\n\t'forum/topic/threadTools',\r\n\t'components',\r\n\t'translator',\r\n\t'api',\r\n\t'bootbox',\r\n], function (topicSelect, threadTools, components, translator, api, bootbox) {\r\n\tvar CategoryTools = {};\r\n\r\n\tCategoryTools.init = function () {\r\n\t\ttopicSelect.init(updateDropdownOptions);\r\n\r\n\t\thandlePinnedTopicSort();\r\n\r\n\t\tcomponents.get('topic/delete').on('click', function () {\r\n\t\t\tcategoryCommand('del', '/state', 'delete', onDeletePurgeComplete);\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tcomponents.get('topic/restore').on('click', function () {\r\n\t\t\tcategoryCommand('put', '/state', 'restore', onDeletePurgeComplete);\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tcomponents.get('topic/purge').on('click', function () {\r\n\t\t\tcategoryCommand('del', '', 'purge', onDeletePurgeComplete);\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tcomponents.get('topic/lock').on('click', function () {\r\n\t\t\tcategoryCommand('put', '/lock', 'lock', onCommandComplete);\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tcomponents.get('topic/unlock').on('click', function () {\r\n\t\t\tcategoryCommand('del', '/lock', 'unlock', onCommandComplete);\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tcomponents.get('topic/pin').on('click', function () {\r\n\t\t\tcategoryCommand('put', '/pin', 'pin', onCommandComplete);\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tcomponents.get('topic/unpin').on('click', function () {\r\n\t\t\tcategoryCommand('del', '/pin', 'unpin', onCommandComplete);\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\t// todo: should also use categoryCommand, but no write api call exists for this yet\r\n\t\tcomponents.get('topic/mark-unread-for-all').on('click', function () {\r\n\t\t\tvar tids = topicSelect.getSelectedTids();\r\n\t\t\tif (!tids.length) {\r\n\t\t\t\treturn app.alertError('[[error:no-topics-selected]]');\r\n\t\t\t}\r\n\t\t\tsocket.emit('topics.markAsUnreadForAll', tids, function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\t\t\t\tapp.alertSuccess('[[topic:markAsUnreadForAll.success]]');\r\n\t\t\t\ttids.forEach(function (tid) {\r\n\t\t\t\t\t$('[component=\"category/topic\"][data-tid=\"' + tid + '\"]').addClass('unread');\r\n\t\t\t\t});\r\n\t\t\t\tonCommandComplete();\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tcomponents.get('topic/move').on('click', function () {\r\n\t\t\trequire(['forum/topic/move'], function (move) {\r\n\t\t\t\tvar tids = topicSelect.getSelectedTids();\r\n\r\n\t\t\t\tif (!tids.length) {\r\n\t\t\t\t\treturn app.alertError('[[error:no-topics-selected]]');\r\n\t\t\t\t}\r\n\t\t\t\tmove.init(tids, null, onCommandComplete);\r\n\t\t\t});\r\n\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tcomponents.get('topic/move-all').on('click', function () {\r\n\t\t\tvar cid = ajaxify.data.cid;\r\n\t\t\tif (!ajaxify.data.template.category) {\r\n\t\t\t\treturn app.alertError('[[error:invalid-data]]');\r\n\t\t\t}\r\n\t\t\trequire(['forum/topic/move'], function (move) {\r\n\t\t\t\tmove.init(null, cid, function (err) {\r\n\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tajaxify.refresh();\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tcomponents.get('topic/merge').on('click', function () {\r\n\t\t\tvar tids = topicSelect.getSelectedTids();\r\n\t\t\trequire(['forum/topic/merge'], function (merge) {\r\n\t\t\t\tmerge.init(function () {\r\n\t\t\t\t\tif (tids.length) {\r\n\t\t\t\t\t\ttids.forEach(function (tid) {\r\n\t\t\t\t\t\t\tmerge.addTopic(tid);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tCategoryTools.removeListeners();\r\n\t\tsocket.on('event:topic_deleted', setDeleteState);\r\n\t\tsocket.on('event:topic_restored', setDeleteState);\r\n\t\tsocket.on('event:topic_purged', onTopicPurged);\r\n\t\tsocket.on('event:topic_locked', setLockedState);\r\n\t\tsocket.on('event:topic_unlocked', setLockedState);\r\n\t\tsocket.on('event:topic_pinned', setPinnedState);\r\n\t\tsocket.on('event:topic_unpinned', setPinnedState);\r\n\t\tsocket.on('event:topic_moved', onTopicMoved);\r\n\t};\r\n\r\n\tfunction categoryCommand(method, path, command, onComplete) {\r\n\t\tif (!onComplete) {\r\n\t\t\tonComplete = function () {};\r\n\t\t}\r\n\t\tconst tids = topicSelect.getSelectedTids();\r\n\t\tconst body = {};\r\n\t\tconst execute = function (ok) {\r\n\t\t\tif (ok) {\r\n\t\t\t\tPromise.all(tids.map(tid => api[method](`/topics/${tid}${path}`, body)))\r\n\t\t\t\t\t.then(onComplete)\r\n\t\t\t\t\t.catch(app.alertError);\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tif (!tids.length) {\r\n\t\t\treturn app.alertError('[[error:no-topics-selected]]');\r\n\t\t}\r\n\r\n\t\tswitch (command) {\r\n\t\t\tcase 'delete':\r\n\t\t\tcase 'restore':\r\n\t\t\tcase 'purge':\r\n\t\t\t\tbootbox.confirm(`[[topic:thread_tools.${command}_confirm]]`, execute);\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'pin':\r\n\t\t\t\tthreadTools.requestPinExpiry(body, execute.bind(null, true));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\t\t\t\texecute(true);\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\tCategoryTools.removeListeners = function () {\r\n\t\tsocket.removeListener('event:topic_deleted', setDeleteState);\r\n\t\tsocket.removeListener('event:topic_restored', setDeleteState);\r\n\t\tsocket.removeListener('event:topic_purged', onTopicPurged);\r\n\t\tsocket.removeListener('event:topic_locked', setLockedState);\r\n\t\tsocket.removeListener('event:topic_unlocked', setLockedState);\r\n\t\tsocket.removeListener('event:topic_pinned', setPinnedState);\r\n\t\tsocket.removeListener('event:topic_unpinned', setPinnedState);\r\n\t\tsocket.removeListener('event:topic_moved', onTopicMoved);\r\n\t};\r\n\r\n\tfunction closeDropDown() {\r\n\t\t$('.thread-tools.open').find('.dropdown-toggle').trigger('click');\r\n\t}\r\n\r\n\tfunction onCommandComplete() {\r\n\t\tcloseDropDown();\r\n\t\ttopicSelect.unselectAll();\r\n\t}\r\n\r\n\tfunction onDeletePurgeComplete() {\r\n\t\tcloseDropDown();\r\n\t\tupdateDropdownOptions();\r\n\t}\r\n\r\n\tfunction updateDropdownOptions() {\r\n\t\tvar tids = topicSelect.getSelectedTids();\r\n\t\tvar isAnyDeleted = isAny(isTopicDeleted, tids);\r\n\t\tvar areAllDeleted = areAll(isTopicDeleted, tids);\r\n\t\tvar isAnyPinned = isAny(isTopicPinned, tids);\r\n\t\tvar isAnyLocked = isAny(isTopicLocked, tids);\r\n\t\tconst isAnyScheduled = isAny(isTopicScheduled, tids);\r\n\t\tconst areAllScheduled = areAll(isTopicScheduled, tids);\r\n\r\n\t\tcomponents.get('topic/delete').toggleClass('hidden', isAnyDeleted);\r\n\t\tcomponents.get('topic/restore').toggleClass('hidden', isAnyScheduled || !isAnyDeleted);\r\n\t\tcomponents.get('topic/purge').toggleClass('hidden', !areAllDeleted);\r\n\r\n\t\tcomponents.get('topic/lock').toggleClass('hidden', isAnyLocked);\r\n\t\tcomponents.get('topic/unlock').toggleClass('hidden', !isAnyLocked);\r\n\r\n\t\tcomponents.get('topic/pin').toggleClass('hidden', areAllScheduled || isAnyPinned);\r\n\t\tcomponents.get('topic/unpin').toggleClass('hidden', areAllScheduled || !isAnyPinned);\r\n\r\n\t\tcomponents.get('topic/merge').toggleClass('hidden', isAnyScheduled);\r\n\t}\r\n\r\n\tfunction isAny(method, tids) {\r\n\t\tfor (var i = 0; i < tids.length; i += 1) {\r\n\t\t\tif (method(tids[i])) {\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\tfunction areAll(method, tids) {\r\n\t\tfor (var i = 0; i < tids.length; i += 1) {\r\n\t\t\tif (!method(tids[i])) {\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn true;\r\n\t}\r\n\r\n\tfunction isTopicDeleted(tid) {\r\n\t\treturn getTopicEl(tid).hasClass('deleted');\r\n\t}\r\n\r\n\tfunction isTopicLocked(tid) {\r\n\t\treturn getTopicEl(tid).hasClass('locked');\r\n\t}\r\n\r\n\tfunction isTopicPinned(tid) {\r\n\t\treturn getTopicEl(tid).hasClass('pinned');\r\n\t}\r\n\r\n\tfunction isTopicScheduled(tid) {\r\n\t\treturn getTopicEl(tid).hasClass('scheduled');\r\n\t}\r\n\r\n\tfunction getTopicEl(tid) {\r\n\t\treturn components.get('category/topic', 'tid', tid);\r\n\t}\r\n\r\n\tfunction setDeleteState(data) {\r\n\t\tvar topic = getTopicEl(data.tid);\r\n\t\ttopic.toggleClass('deleted', data.isDeleted);\r\n\t\ttopic.find('[component=\"topic/locked\"]').toggleClass('hide', !data.isDeleted);\r\n\t}\r\n\r\n\tfunction setPinnedState(data) {\r\n\t\tvar topic = getTopicEl(data.tid);\r\n\t\ttopic.toggleClass('pinned', data.isPinned);\r\n\t\ttopic.find('[component=\"topic/pinned\"]').toggleClass('hide', !data.isPinned);\r\n\t\tajaxify.refresh();\r\n\t}\r\n\r\n\tfunction setLockedState(data) {\r\n\t\tvar topic = getTopicEl(data.tid);\r\n\t\ttopic.toggleClass('locked', data.isLocked);\r\n\t\ttopic.find('[component=\"topic/locked\"]').toggleClass('hide', !data.isLocked);\r\n\t}\r\n\r\n\tfunction onTopicMoved(data) {\r\n\t\tgetTopicEl(data.tid).remove();\r\n\t}\r\n\r\n\tfunction onTopicPurged(data) {\r\n\t\tgetTopicEl(data.tid).remove();\r\n\t}\r\n\r\n\tfunction handlePinnedTopicSort() {\r\n\t\tif (!ajaxify.data.topics || !ajaxify.data.template.category) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tvar numPinned = ajaxify.data.topics.reduce(function (memo, topic) {\r\n\t\t\tmemo = topic.pinned ? memo += 1 : memo;\r\n\t\t\treturn memo;\r\n\t\t}, 0);\r\n\r\n\t\tif ((!app.user.isAdmin && !app.user.isMod) || numPinned < 2) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tapp.loadJQueryUI(function () {\r\n\t\t\tvar topicListEl = $('[component=\"category\"]').filter(function (i, e) {\r\n\t\t\t\treturn !$(e).parents('[widget-area],[data-widget-area]').length;\r\n\t\t\t});\r\n\t\t\ttopicListEl.sortable({\r\n\t\t\t\thandle: '[component=\"topic/pinned\"]',\r\n\t\t\t\titems: '[component=\"category/topic\"].pinned',\r\n\t\t\t\tupdate: function () {\r\n\t\t\t\t\tvar data = [];\r\n\r\n\t\t\t\t\tvar pinnedTopics = topicListEl.find('[component=\"category/topic\"].pinned');\r\n\t\t\t\t\tpinnedTopics.each(function (index, element) {\r\n\t\t\t\t\t\tdata.push({ tid: $(element).attr('data-tid'), order: pinnedTopics.length - index - 1 });\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tsocket.emit('topics.orderPinnedTopics', data, function (err) {\r\n\t\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\treturn CategoryTools;\r\n});\r\n"]}