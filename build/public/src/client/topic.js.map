{"version":3,"sources":["public/src/client/topic.js"],"names":["define","infinitescroll","threadTools","postTools","events","posts","images","navigator","sort","components","storage","Topic","currentUrl","$","window","on","ev","data","replaceURLTimeout","clearTimeout","removeListeners","String","url","startsWith","disable","get","find","text","hide","app","removeAlert","require","search","topicDOM","active","end","init","tid","ajaxify","currentPage","trigger","enterRoom","onTopicPageLoad","postcount","toTop","toBottom","navigatorCallback","handleSort","slug","config","usePagination","loadMorePosts","addBlockQuoteHandler","addParentHandler","addDropupHandler","addRepliesHandler","handleBookmark","updateTopicTitle","handleTopicSearch","off","prev","next","topicSearchEnabled","mousetrap","bind","e","match","preventDefault","val","prepareSearch","scrollTop","socket","emit","err","postCount","alertError","message","scrollBottom","location","hash","el","utils","escapeHTML","length","scrollToElement","bookmark","getItem","postIndex","scrollToPostIndex","pagination","bookmarkThreshold","alert","alert_id","timeout","type","clickfn","scrollToIndex","parseInt","closefn","removeItem","setTimeout","blockQuote","this","parent","toggle","toggleClass","collapsed","hasClass","toPid","attr","toPost","target","dropUp","getBoundingClientRect","top","height","btn","replies","span","html","title","removeClass","addClass","index","elementCount","path","removeRelativePath","pathname","slice","scrollActive","newUrl","user","uid","updateUserBookmark","updateUrlWithPostIndex","history","replaceState","test","protocol","host","relative_path","bookmarkKey","currentBookmark","topicPostSort","Math","max","setItem"],"mappings":"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","file":"public/src/client/topic.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/topic', [\r\n\t'forum/infinitescroll',\r\n\t'forum/topic/threadTools',\r\n\t'forum/topic/postTools',\r\n\t'forum/topic/events',\r\n\t'forum/topic/posts',\r\n\t'forum/topic/images',\r\n\t'navigator',\r\n\t'sort',\r\n\t'components',\r\n\t'storage',\r\n], function (infinitescroll, threadTools, postTools, events, posts, images, navigator, sort, components, storage) {\r\n\tvar\tTopic = {};\r\n\tvar currentUrl = '';\r\n\r\n\t$(window).on('action:ajaxify.start', function (ev, data) {\r\n\t\tif (Topic.replaceURLTimeout) {\r\n\t\t\tclearTimeout(Topic.replaceURLTimeout);\r\n\t\t\tTopic.replaceURLTimeout = 0;\r\n\t\t}\r\n\t\tevents.removeListeners();\r\n\r\n\t\tif (!String(data.url).startsWith('topic/')) {\r\n\t\t\tnavigator.disable();\r\n\t\t\tcomponents.get('navbar/title').find('span').text('').hide();\r\n\t\t\tapp.removeAlert('bookmark');\r\n\r\n\t\t\trequire(['search'], function (search) {\r\n\t\t\t\tif (search.topicDOM.active) {\r\n\t\t\t\t\tsearch.topicDOM.end();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t});\r\n\r\n\tTopic.init = function () {\r\n\t\tvar tid = ajaxify.data.tid;\r\n\t\tcurrentUrl = ajaxify.currentPage;\r\n\t\t$(window).trigger('action:topic.loading');\r\n\r\n\t\tapp.enterRoom('topic_' + tid);\r\n\r\n\t\tposts.onTopicPageLoad(components.get('post'));\r\n\r\n\t\tnavigator.init('[component=\"post\"]', ajaxify.data.postcount, Topic.toTop, Topic.toBottom, Topic.navigatorCallback);\r\n\r\n\t\tpostTools.init(tid);\r\n\t\tthreadTools.init(tid, $('.topic'));\r\n\t\tevents.init();\r\n\r\n\t\tsort.handleSort('topicPostSort', 'topic/' + ajaxify.data.slug);\r\n\r\n\t\tif (!config.usePagination) {\r\n\t\t\tinfinitescroll.init($('[component=\"topic\"]'), posts.loadMorePosts);\r\n\t\t}\r\n\r\n\t\taddBlockQuoteHandler();\r\n\t\taddParentHandler();\r\n\t\taddDropupHandler();\r\n\t\taddRepliesHandler();\r\n\r\n\r\n\r\n\t\thandleBookmark(tid);\r\n\r\n\t\t$(window).on('scroll', updateTopicTitle);\r\n\r\n\t\thandleTopicSearch();\r\n\r\n\t\t$(window).trigger('action:topic.loaded', ajaxify.data);\r\n\t};\r\n\r\n\tfunction handleTopicSearch() {\r\n\t\t$('.topic-search').off('click')\r\n\t\t\t.on('click', '.prev', function () {\r\n\t\t\t\trequire(['search'], function (search) {\r\n\t\t\t\t\tsearch.topicDOM.prev();\r\n\t\t\t\t});\r\n\t\t\t})\r\n\t\t\t.on('click', '.next', function () {\r\n\t\t\t\trequire(['search'], function (search) {\r\n\t\t\t\t\tsearch.topicDOM.next();\r\n\t\t\t\t});\r\n\t\t\t});\r\n\r\n\t\tif (config.topicSearchEnabled) {\r\n\t\t\trequire(['mousetrap'], function (mousetrap) {\r\n\t\t\t\tmousetrap.bind(['command+f', 'ctrl+f'], function (e) {\r\n\t\t\t\t\tvar match = ajaxify.currentPage.match(/^topic\\/([\\d]+)/);\r\n\t\t\t\t\tvar tid;\r\n\t\t\t\t\tif (match) {\r\n\t\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\t\ttid = match[1];\r\n\t\t\t\t\t\t$('#search-fields input').val('in:topic-' + tid + ' ');\r\n\t\t\t\t\t\tapp.prepareSearch();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tTopic.toTop = function () {\r\n\t\tnavigator.scrollTop(0);\r\n\t};\r\n\r\n\tTopic.toBottom = function () {\r\n\t\tsocket.emit('topics.postcount', ajaxify.data.tid, function (err, postCount) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tnavigator.scrollBottom(postCount - 1);\r\n\t\t});\r\n\t};\r\n\r\n\tfunction handleBookmark(tid) {\r\n\t\tif (window.location.hash) {\r\n\t\t\tvar el = $(utils.escapeHTML(window.location.hash));\r\n\t\t\tif (el.length) {\r\n\t\t\t\treturn navigator.scrollToElement(el, true, 0);\r\n\t\t\t}\r\n\t\t}\r\n\t\tvar bookmark = ajaxify.data.bookmark || storage.getItem('topic:' + tid + ':bookmark');\r\n\t\tvar postIndex = ajaxify.data.postIndex;\r\n\r\n\t\tif (postIndex > 1) {\r\n\t\t\tif (components.get('post/anchor', postIndex - 1).length) {\r\n\t\t\t\treturn navigator.scrollToPostIndex(postIndex - 1, true, 0);\r\n\t\t\t}\r\n\t\t} else if (bookmark && (\r\n\t\t\t!config.usePagination ||\r\n\t\t\t(config.usePagination && ajaxify.data.pagination.currentPage === 1)\r\n\t\t) && ajaxify.data.postcount > ajaxify.data.bookmarkThreshold) {\r\n\t\t\tapp.alert({\r\n\t\t\t\talert_id: 'bookmark',\r\n\t\t\t\tmessage: '[[topic:bookmark_instructions]]',\r\n\t\t\t\ttimeout: 0,\r\n\t\t\t\ttype: 'info',\r\n\t\t\t\tclickfn: function () {\r\n\t\t\t\t\tnavigator.scrollToIndex(parseInt(bookmark, 10), true);\r\n\t\t\t\t},\r\n\t\t\t\tclosefn: function () {\r\n\t\t\t\t\tstorage.removeItem('topic:' + tid + ':bookmark');\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t\tsetTimeout(function () {\r\n\t\t\t\tapp.removeAlert('bookmark');\r\n\t\t\t}, 10000);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction addBlockQuoteHandler() {\r\n\t\tcomponents.get('topic').on('click', 'blockquote .toggle', function () {\r\n\t\t\tvar blockQuote = $(this).parent('blockquote');\r\n\t\t\tvar toggle = $(this);\r\n\t\t\tblockQuote.toggleClass('uncollapsed');\r\n\t\t\tvar collapsed = !blockQuote.hasClass('uncollapsed');\r\n\t\t\ttoggle.toggleClass('fa-angle-down', collapsed).toggleClass('fa-angle-up', !collapsed);\r\n\t\t});\r\n\t}\r\n\r\n\tfunction addParentHandler() {\r\n\t\tcomponents.get('topic').on('click', '[component=\"post/parent\"]', function (e) {\r\n\t\t\tvar toPid = $(this).attr('data-topid');\r\n\r\n\t\t\tvar toPost = $('[component=\"topic\"]>[component=\"post\"][data-pid=\"' + toPid + '\"]');\r\n\t\t\tif (toPost.length) {\r\n\t\t\t\te.preventDefault();\r\n\t\t\t\tnavigator.scrollToIndex(toPost.attr('data-index'), true);\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction addDropupHandler() {\r\n\t\t// Locate all dropdowns\r\n\t\tvar target = $('#content .dropdown-menu').parent();\r\n\r\n\t\t// Toggle dropup if past 50% of screen\r\n\t\t$(target).on('show.bs.dropdown', function () {\r\n\t\t\tvar dropUp = this.getBoundingClientRect().top > ($(window).height() / 2);\r\n\t\t\t$(this).toggleClass('dropup', dropUp);\r\n\t\t});\r\n\t}\r\n\r\n\tfunction addRepliesHandler() {\r\n\t\t$('[component=\"topic\"]').on('click', '[component=\"post/reply-count\"]', function () {\r\n\t\t\tvar btn = $(this);\r\n\t\t\trequire(['forum/topic/replies'], function (replies) {\r\n\t\t\t\treplies.init(btn);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tfunction updateTopicTitle() {\r\n\t\tvar span = components.get('navbar/title').find('span');\r\n\t\tif ($(window).scrollTop() > 50 && span.hasClass('hidden')) {\r\n\t\t\tspan.html(ajaxify.data.title).removeClass('hidden');\r\n\t\t} else if ($(window).scrollTop() <= 50 && !span.hasClass('hidden')) {\r\n\t\t\tspan.html('').addClass('hidden');\r\n\t\t}\r\n\t\tif ($(window).scrollTop() > 300) {\r\n\t\t\tapp.removeAlert('bookmark');\r\n\t\t}\r\n\t}\r\n\r\n\tTopic.navigatorCallback = function (index, elementCount) {\r\n\t\tvar path = ajaxify.removeRelativePath(window.location.pathname.slice(1));\r\n\t\tif (!path.startsWith('topic')) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (navigator.scrollActive) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar newUrl = 'topic/' + ajaxify.data.slug + (index > 1 ? ('/' + index) : '');\r\n\t\tif (newUrl !== currentUrl) {\r\n\t\t\tif (Topic.replaceURLTimeout) {\r\n\t\t\t\tclearTimeout(Topic.replaceURLTimeout);\r\n\t\t\t\tTopic.replaceURLTimeout = 0;\r\n\t\t\t}\r\n\t\t\tcurrentUrl = newUrl;\r\n\t\t\tTopic.replaceURLTimeout = setTimeout(function () {\r\n\t\t\t\tif (index >= elementCount && app.user.uid) {\r\n\t\t\t\t\tsocket.emit('topics.markAsRead', [ajaxify.data.tid]);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tupdateUserBookmark(index);\r\n\r\n\t\t\t\tTopic.replaceURLTimeout = 0;\r\n\t\t\t\tif (ajaxify.data.updateUrlWithPostIndex && history.replaceState) {\r\n\t\t\t\t\tvar search = window.location.search || '';\r\n\t\t\t\t\tif (!config.usePagination) {\r\n\t\t\t\t\t\tsearch = (search && !/^\\?page=\\d+$/.test(search) ? search : '');\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\thistory.replaceState({\r\n\t\t\t\t\t\turl: newUrl + search,\r\n\t\t\t\t\t}, null, window.location.protocol + '//' + window.location.host + config.relative_path + '/' + newUrl + search);\r\n\t\t\t\t}\r\n\t\t\t}, 500);\r\n\t\t}\r\n\t};\r\n\r\n\tfunction updateUserBookmark(index) {\r\n\t\tvar bookmarkKey = 'topic:' + ajaxify.data.tid + ':bookmark';\r\n\t\tvar currentBookmark = ajaxify.data.bookmark || storage.getItem(bookmarkKey);\r\n\t\tif (config.topicPostSort === 'newest_to_oldest') {\r\n\t\t\tindex = Math.max(1, ajaxify.data.postcount - index + 2);\r\n\t\t}\r\n\r\n\t\tif (\r\n\t\t\tajaxify.data.postcount > ajaxify.data.bookmarkThreshold &&\r\n\t\t\t(\r\n\t\t\t\t!currentBookmark ||\r\n\t\t\t\tparseInt(index, 10) > parseInt(currentBookmark, 10) ||\r\n\t\t\t\tajaxify.data.postcount < parseInt(currentBookmark, 10)\r\n\t\t\t)\r\n\t\t) {\r\n\t\t\tif (app.user.uid) {\r\n\t\t\t\tsocket.emit('topics.bookmark', {\r\n\t\t\t\t\ttid: ajaxify.data.tid,\r\n\t\t\t\t\tindex: index,\r\n\t\t\t\t}, function (err) {\r\n\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tajaxify.data.bookmark = index + 1;\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tstorage.setItem(bookmarkKey, index);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// removes the bookmark alert when we get to / past the bookmark\r\n\t\tif (!currentBookmark || parseInt(index, 10) >= parseInt(currentBookmark, 10)) {\r\n\t\t\tapp.removeAlert('bookmark');\r\n\t\t}\r\n\t}\r\n\r\n\r\n\treturn Topic;\r\n});\r\n"]}