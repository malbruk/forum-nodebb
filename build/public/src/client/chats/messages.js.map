{"version":3,"sources":["public/src/client/chats/messages.js"],"names":["define","components","translator","Benchpress","messages","sendMessage","roomId","inputEl","msg","val","mid","attr","trim","length","removeAttr","updateRemainingLength","parent","$","window","trigger","message","socket","emit","err","app","showEmailConfirmWarning","alert","alert_id","title","type","timeout","alertError","element","find","text","config","maximumChatMessageLength","appendChatMessage","chatContentEl","data","lastSpeaker","parseInt","last","lasttimestamp","Array","isArray","newSet","fromuid","timestamp","parseMessage","html","onMessagesParsed","newMessage","isAtBottom","appendTo","timeago","addClass","scrollToBottom","messageEl","callback","done","translate","render","then","system","containerEl","threshold","distanceToBottom","scrollHeight","outerHeight","scrollTop","height","toggleScrollUpAlert","toggleClass","prepEdit","messageId","raw","focus","addSocketListeners","removeListener","onChatMessageEdited","on","onChatMessageDeleted","onChatMessageRestored","forEach","self","user","uid","body","get","replaceWith","translateHtml","content","delete","translated","bootbox","confirm","ok","restore"],"mappings":"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","file":"public/src/client/chats/messages.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/chats/messages', ['components', 'translator', 'benchpress'], function (components, translator, Benchpress) {\r\n\tvar messages = {};\r\n\r\n\tmessages.sendMessage = function (roomId, inputEl) {\r\n\t\tvar msg = inputEl.val();\r\n\t\tvar mid = inputEl.attr('data-mid');\r\n\r\n\t\tif (!msg.trim().length) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tinputEl.val('');\r\n\t\tinputEl.removeAttr('data-mid');\r\n\t\tmessages.updateRemainingLength(inputEl.parent());\r\n\t\t$(window).trigger('action:chat.sent', {\r\n\t\t\troomId: roomId,\r\n\t\t\tmessage: msg,\r\n\t\t\tmid: mid,\r\n\t\t});\r\n\r\n\t\tif (!mid) {\r\n\t\t\tsocket.emit('modules.chats.send', {\r\n\t\t\t\troomId: roomId,\r\n\t\t\t\tmessage: msg,\r\n\t\t\t}, function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\tinputEl.val(msg);\r\n\t\t\t\t\tmessages.updateRemainingLength(inputEl.parent());\r\n\t\t\t\t\tif (err.message === '[[error:email-not-confirmed-chat]]') {\r\n\t\t\t\t\t\treturn app.showEmailConfirmWarning(err);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn app.alert({\r\n\t\t\t\t\t\talert_id: 'chat_spam_error',\r\n\t\t\t\t\t\ttitle: '[[global:alert.error]]',\r\n\t\t\t\t\t\tmessage: err.message,\r\n\t\t\t\t\t\ttype: 'danger',\r\n\t\t\t\t\t\ttimeout: 10000,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tsocket.emit('modules.chats.edit', {\r\n\t\t\t\troomId: roomId,\r\n\t\t\t\tmid: mid,\r\n\t\t\t\tmessage: msg,\r\n\t\t\t}, function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\tinputEl.val(msg);\r\n\t\t\t\t\tinputEl.attr('data-mid', mid);\r\n\t\t\t\t\tmessages.updateRemainingLength(inputEl.parent());\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n\r\n\tmessages.updateRemainingLength = function (parent) {\r\n\t\tvar element = parent.find('[component=\"chat/input\"]');\r\n\t\tparent.find('[component=\"chat/message/length\"]').text(element.val().length);\r\n\t\tparent.find('[component=\"chat/message/remaining\"]').text(config.maximumChatMessageLength - element.val().length);\r\n\t\t$(window).trigger('action:chat.updateRemainingLength', {\r\n\t\t\tparent: parent,\r\n\t\t});\r\n\t};\r\n\r\n\tmessages.appendChatMessage = function (chatContentEl, data) {\r\n\t\tvar lastSpeaker = parseInt(chatContentEl.find('.chat-message').last().attr('data-uid'), 10);\r\n\t\tvar lasttimestamp = parseInt(chatContentEl.find('.chat-message').last().attr('data-timestamp'), 10);\r\n\t\tif (!Array.isArray(data)) {\r\n\t\t\tdata.newSet = lastSpeaker !== parseInt(data.fromuid, 10) ||\r\n\t\t\t\tparseInt(data.timestamp, 10) > parseInt(lasttimestamp, 10) + (1000 * 60 * 3);\r\n\t\t}\r\n\r\n\t\tmessages.parseMessage(data, function (html) {\r\n\t\t\tonMessagesParsed(chatContentEl, html);\r\n\t\t});\r\n\t};\r\n\r\n\tfunction onMessagesParsed(chatContentEl, html) {\r\n\t\tvar newMessage = $(html);\r\n\t\tvar isAtBottom = messages.isAtBottom(chatContentEl);\r\n\t\tnewMessage.appendTo(chatContentEl);\r\n\t\tnewMessage.find('.timeago').timeago();\r\n\t\tnewMessage.find('img:not(.not-responsive)').addClass('img-responsive');\r\n\t\tif (isAtBottom) {\r\n\t\t\tmessages.scrollToBottom(chatContentEl);\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:chat.received', {\r\n\t\t\tmessageEl: newMessage,\r\n\t\t});\r\n\t}\r\n\r\n\r\n\tmessages.parseMessage = function (data, callback) {\r\n\t\tfunction done(html) {\r\n\t\t\ttranslator.translate(html, callback);\r\n\t\t}\r\n\r\n\t\tif (Array.isArray(data)) {\r\n\t\t\tBenchpress.render('partials/chats/message' + (Array.isArray(data) ? 's' : ''), {\r\n\t\t\t\tmessages: data,\r\n\t\t\t}).then(done);\r\n\t\t} else {\r\n\t\t\tBenchpress.render('partials/chats/' + (data.system ? 'system-message' : 'message'), {\r\n\t\t\t\tmessages: data,\r\n\t\t\t}).then(done);\r\n\t\t}\r\n\t};\r\n\r\n\tmessages.isAtBottom = function (containerEl, threshold) {\r\n\t\tif (containerEl.length) {\r\n\t\t\tvar distanceToBottom = containerEl[0].scrollHeight - (\r\n\t\t\t\tcontainerEl.outerHeight() + containerEl.scrollTop()\r\n\t\t\t);\r\n\t\t\treturn distanceToBottom < (threshold || 100);\r\n\t\t}\r\n\t};\r\n\r\n\tmessages.scrollToBottom = function (containerEl) {\r\n\t\tif (containerEl && containerEl.length) {\r\n\t\t\tcontainerEl.scrollTop(containerEl[0].scrollHeight - containerEl.height());\r\n\t\t\tcontainerEl.parent()\r\n\t\t\t\t.find('[component=\"chat/messages/scroll-up-alert\"]')\r\n\t\t\t\t.addClass('hidden');\r\n\t\t}\r\n\t};\r\n\r\n\tmessages.toggleScrollUpAlert = function (containerEl) {\r\n\t\tvar isAtBottom = messages.isAtBottom(containerEl, 300);\r\n\t\tcontainerEl.parent()\r\n\t\t\t.find('[component=\"chat/messages/scroll-up-alert\"]')\r\n\t\t\t.toggleClass('hidden', isAtBottom);\r\n\t};\r\n\r\n\tmessages.prepEdit = function (inputEl, messageId, roomId) {\r\n\t\tsocket.emit('modules.chats.getRaw', { mid: messageId, roomId: roomId }, function (err, raw) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\t\t\t// Populate the input field with the raw message content\r\n\t\t\tif (inputEl.val().length === 0) {\r\n\t\t\t\t// By setting the `data-mid` attribute, I tell the chat code that I am editing a\r\n\t\t\t\t// message, instead of posting a new one.\r\n\t\t\t\tinputEl.attr('data-mid', messageId).addClass('editing');\r\n\t\t\t\tinputEl.val(raw).focus();\r\n\r\n\t\t\t\t$(window).trigger('action:chat.prepEdit', {\r\n\t\t\t\t\tinputEl: inputEl,\r\n\t\t\t\t\tmessageId: messageId,\r\n\t\t\t\t\troomId: roomId,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tmessages.addSocketListeners = function () {\r\n\t\tsocket.removeListener('event:chats.edit', onChatMessageEdited);\r\n\t\tsocket.on('event:chats.edit', onChatMessageEdited);\r\n\r\n\t\tsocket.removeListener('event:chats.delete', onChatMessageDeleted);\r\n\t\tsocket.on('event:chats.delete', onChatMessageDeleted);\r\n\r\n\t\tsocket.removeListener('event:chats.restore', onChatMessageRestored);\r\n\t\tsocket.on('event:chats.restore', onChatMessageRestored);\r\n\t};\r\n\r\n\tfunction onChatMessageEdited(data) {\r\n\t\tdata.messages.forEach(function (message) {\r\n\t\t\tvar self = parseInt(message.fromuid, 10) === parseInt(app.user.uid, 10);\r\n\t\t\tmessage.self = self ? 1 : 0;\r\n\t\t\tmessages.parseMessage(message, function (html) {\r\n\t\t\t\tvar body = components.get('chat/message', message.messageId);\r\n\t\t\t\tif (body.length) {\r\n\t\t\t\t\tbody.replaceWith(html);\r\n\t\t\t\t\tcomponents.get('chat/message', message.messageId).find('.timeago').timeago();\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tfunction onChatMessageDeleted(messageId) {\r\n\t\tcomponents.get('chat/message', messageId)\r\n\t\t\t.toggleClass('deleted', true)\r\n\t\t\t.find('[component=\"chat/message/body\"]').translateHtml('[[modules:chat.message-deleted]]');\r\n\t}\r\n\r\n\tfunction onChatMessageRestored(message) {\r\n\t\tcomponents.get('chat/message', message.messageId)\r\n\t\t\t.toggleClass('deleted', false)\r\n\t\t\t.find('[component=\"chat/message/body\"]').html(message.content);\r\n\t}\r\n\r\n\tmessages.delete = function (messageId, roomId) {\r\n\t\ttranslator.translate('[[modules:chat.delete_message_confirm]]', function (translated) {\r\n\t\t\tbootbox.confirm(translated, function (ok) {\r\n\t\t\t\tif (!ok) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tsocket.emit('modules.chats.delete', {\r\n\t\t\t\t\tmessageId: messageId,\r\n\t\t\t\t\troomId: roomId,\r\n\t\t\t\t}, function (err) {\r\n\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tcomponents.get('chat/message', messageId).toggleClass('deleted', true);\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tmessages.restore = function (messageId, roomId) {\r\n\t\tsocket.emit('modules.chats.restore', {\r\n\t\t\tmessageId: messageId,\r\n\t\t\troomId: roomId,\r\n\t\t}, function (err) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tcomponents.get('chat/message', messageId).toggleClass('deleted', false);\r\n\t\t});\r\n\t};\r\n\r\n\treturn messages;\r\n});\r\n"]}