{"version":3,"sources":["public/src/client/flags/list.js"],"names":["define","components","Chart","categoryFilter","autocomplete","Flags","selectedCids","init","enableFilterForm","enableCheckboxes","handleBulkActions","ajaxify","data","filters","hasOwnProperty","Array","isArray","cid","$","privilege","onHidden","get","on","e","includes","target","nodeName","flagId","this","getAttribute","go","one","handleGraphs","user","ev","ui","setTimeout","value","item","uid","$filtersEl","filter","find","val","sort","document","getElementById","addEventListener","payload","serializeArray","forEach","push","name","length","param","click","textVariant","setAttribute","textContent","firstChild","flagsList","querySelector","checkboxes","querySelectorAll","bulkEl","lastClicked","state","checked","el","disabled","subselector","closest","stopImmediatePropagation","shiftKey","started","some","ref","prototype","call","action","flagIds","getSelected","promises","Promise","resolve","reject","handler","err","arguments","socket","emit","app","allSettled","then","results","fulfilled","res","status","errors","alertSuccess","refresh","alertError","reason","dailyCanvas","dailyLabels","utils","getDaysArray","map","text","idx","isMobile","defaults","global","tooltips","enabled","flags:daily","labels","datasets","label","backgroundColor","borderColor","pointBackgroundColor","pointHoverBackgroundColor","pointBorderColor","pointHoverBorderColor","analytics","width","parent","getContext","type","options","responsive","animation","legend","display","scales","yAxes","ticks","beginAtZero","precision"],"mappings":"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","file":"public/src/client/flags/list.js","sourcesContent":["'use strict';\r\n\r\ndefine('forum/flags/list', ['components', 'Chart', 'categoryFilter', 'autocomplete'], function (components, Chart, categoryFilter, autocomplete) {\r\n\tvar Flags = {};\r\n\r\n\tvar selectedCids;\r\n\r\n\tFlags.init = function () {\r\n\t\tFlags.enableFilterForm();\r\n\t\tFlags.enableCheckboxes();\r\n\t\tFlags.handleBulkActions();\r\n\r\n\t\tselectedCids = [];\r\n\t\tif (ajaxify.data.filters.hasOwnProperty('cid')) {\r\n\t\t\tselectedCids = Array.isArray(ajaxify.data.filters.cid) ?\r\n\t\t\t\tajaxify.data.filters.cid : [ajaxify.data.filters.cid];\r\n\t\t}\r\n\r\n\t\tcategoryFilter.init($('[component=\"category/dropdown\"]'), {\r\n\t\t\tprivilege: 'moderate',\r\n\t\t\tselectedCids: selectedCids,\r\n\t\t\tonHidden: function (data) {\r\n\t\t\t\tselectedCids = data.selectedCids;\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tcomponents.get('flags/list')\r\n\t\t\t.on('click', '[data-flag-id]', function (e) {\r\n\t\t\t\tif (['BUTTON', 'A'].includes(e.target.nodeName)) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar flagId = this.getAttribute('data-flag-id');\r\n\t\t\t\tajaxify.go('flags/' + flagId);\r\n\t\t\t});\r\n\r\n\t\t$('#flags-daily-wrapper').one('shown.bs.collapse', function () {\r\n\t\t\tFlags.handleGraphs();\r\n\t\t});\r\n\r\n\t\tautocomplete.user($('#filter-assignee, #filter-targetUid, #filter-reporterId'), (ev, ui) => {\r\n\t\t\tsetTimeout(() => { ev.target.value = ui.item.user.uid; });\r\n\t\t});\r\n\t};\r\n\r\n\tFlags.enableFilterForm = function () {\r\n\t\tconst $filtersEl = components.get('flags/filters');\r\n\r\n\t\t// Parse ajaxify data to set form values to reflect current filters\r\n\t\tfor (const filter in ajaxify.data.filters) {\r\n\t\t\tif (ajaxify.data.filters.hasOwnProperty(filter)) {\r\n\t\t\t\t$filtersEl.find('[name=\"' + filter + '\"]').val(ajaxify.data.filters[filter]);\r\n\t\t\t}\r\n\t\t}\r\n\t\t$filtersEl.find('[name=\"sort\"]').val(ajaxify.data.sort);\r\n\r\n\t\tdocument.getElementById('apply-filters').addEventListener('click', function () {\r\n\t\t\tconst payload = $filtersEl.serializeArray();\r\n\t\t\t// cid is special comes from categoryFilter module\r\n\t\t\tselectedCids.forEach(function (cid) {\r\n\t\t\t\tpayload.push({ name: 'cid', value: cid });\r\n\t\t\t});\r\n\r\n\t\t\tajaxify.go('flags?' + (payload.length ? $.param(payload) : 'reset=1'));\r\n\t\t});\r\n\r\n\t\t$filtersEl.find('button[data-target=\"#more-filters\"]').click((ev) => {\r\n\t\t\tconst textVariant = ev.target.getAttribute('data-text-variant');\r\n\t\t\tif (!textVariant) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tev.target.setAttribute('data-text-variant', ev.target.textContent);\r\n\t\t\tev.target.firstChild.textContent = textVariant;\r\n\t\t});\r\n\t};\r\n\r\n\tFlags.enableCheckboxes = function () {\r\n\t\tvar flagsList = document.querySelector('[component=\"flags/list\"]');\r\n\t\tvar checkboxes = flagsList.querySelectorAll('[data-flag-id] input[type=\"checkbox\"]');\r\n\t\tvar bulkEl = document.querySelector('[component=\"flags/bulk-actions\"] button');\r\n\t\tvar lastClicked;\r\n\r\n\t\tdocument.querySelector('[data-action=\"toggle-all\"]').addEventListener('click', function () {\r\n\t\t\tvar state = this.checked;\r\n\r\n\t\t\tcheckboxes.forEach(function (el) {\r\n\t\t\t\tel.checked = state;\r\n\t\t\t});\r\n\t\t\tbulkEl.disabled = !state;\r\n\t\t});\r\n\r\n\t\tflagsList.addEventListener('click', function (e) {\r\n\t\t\tvar subselector = e.target.closest('input[type=\"checkbox\"]');\r\n\t\t\tif (subselector) {\r\n\t\t\t\t// Stop checkbox clicks from going into the flag details\r\n\t\t\t\te.stopImmediatePropagation();\r\n\r\n\t\t\t\tif (lastClicked && e.shiftKey && lastClicked !== subselector) {\r\n\t\t\t\t\t// Select all the checkboxes in between\r\n\t\t\t\t\tvar state = subselector.checked;\r\n\t\t\t\t\tvar started = false;\r\n\r\n\t\t\t\t\tcheckboxes.forEach(function (el) {\r\n\t\t\t\t\t\tif ([subselector, lastClicked].some(function (ref) {\r\n\t\t\t\t\t\t\treturn ref === el;\r\n\t\t\t\t\t\t})) {\r\n\t\t\t\t\t\t\tstarted = !started;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (started) {\r\n\t\t\t\t\t\t\tel.checked = state;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// (De)activate bulk actions button based on checkboxes' state\r\n\t\t\t\tbulkEl.disabled = !Array.prototype.some.call(checkboxes, function (el) {\r\n\t\t\t\t\treturn el.checked;\r\n\t\t\t\t});\r\n\r\n\t\t\t\tlastClicked = subselector;\r\n\t\t\t}\r\n\r\n\t\t\t// If you miss the checkbox, don't descend into the flag details, either\r\n\t\t\tif (e.target.querySelector('input[type=\"checkbox\"]')) {\r\n\t\t\t\te.stopImmediatePropagation();\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tFlags.handleBulkActions = function () {\r\n\t\tdocument.querySelector('[component=\"flags/bulk-actions\"]').addEventListener('click', function (e) {\r\n\t\t\tvar subselector = e.target.closest('[data-action]');\r\n\t\t\tif (subselector) {\r\n\t\t\t\tvar action = subselector.getAttribute('data-action');\r\n\t\t\t\tvar flagIds = Flags.getSelected();\r\n\t\t\t\tvar promises = [];\r\n\r\n\t\t\t\t// TODO: this can be better done with flagIds.map to return promises\r\n\t\t\t\tflagIds.forEach(function (flagId) {\r\n\t\t\t\t\tpromises.push(new Promise(function (resolve, reject) {\r\n\t\t\t\t\t\tvar handler = function (err) {\r\n\t\t\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\t\t\treject(err);\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\tresolve(arguments[1]);\r\n\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\tswitch (action) {\r\n\t\t\t\t\t\t\tcase 'bulk-assign':\r\n\t\t\t\t\t\t\t\tsocket.emit('flags.update', {\r\n\t\t\t\t\t\t\t\t\tflagId: flagId,\r\n\t\t\t\t\t\t\t\t\tdata: [\r\n\t\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\tname: 'assignee',\r\n\t\t\t\t\t\t\t\t\t\t\tvalue: app.user.uid,\r\n\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t],\r\n\t\t\t\t\t\t\t\t}, handler);\r\n\t\t\t\t\t\t\t\tbreak;\r\n\r\n\t\t\t\t\t\t\tcase 'bulk-mark-resolved':\r\n\t\t\t\t\t\t\t\tsocket.emit('flags.update', {\r\n\t\t\t\t\t\t\t\t\tflagId: flagId,\r\n\t\t\t\t\t\t\t\t\tdata: [\r\n\t\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\t\tname: 'state',\r\n\t\t\t\t\t\t\t\t\t\t\tvalue: 'resolved',\r\n\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t],\r\n\t\t\t\t\t\t\t\t}, handler);\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}));\r\n\t\t\t\t});\r\n\r\n\t\t\t\tPromise.allSettled(promises).then(function (results) {\r\n\t\t\t\t\tvar fulfilled = results.filter(function (res) {\r\n\t\t\t\t\t\treturn res.status === 'fulfilled';\r\n\t\t\t\t\t}).length;\r\n\t\t\t\t\tvar errors = results.filter(function (res) {\r\n\t\t\t\t\t\treturn res.status === 'rejected';\r\n\t\t\t\t\t});\r\n\t\t\t\t\tif (fulfilled) {\r\n\t\t\t\t\t\tapp.alertSuccess('[[flags:bulk-success, ' + fulfilled + ']]');\r\n\t\t\t\t\t\tajaxify.refresh();\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\terrors.forEach(function (res) {\r\n\t\t\t\t\t\tapp.alertError(res.reason);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tFlags.getSelected = function () {\r\n\t\tvar checkboxes = document.querySelectorAll('[component=\"flags/list\"] [data-flag-id] input[type=\"checkbox\"]');\r\n\t\tvar payload = [];\r\n\t\tcheckboxes.forEach(function (el) {\r\n\t\t\tif (el.checked) {\r\n\t\t\t\tpayload.push(el.closest('[data-flag-id]').getAttribute('data-flag-id'));\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\treturn payload;\r\n\t};\r\n\r\n\tFlags.handleGraphs = function () {\r\n\t\tvar dailyCanvas = document.getElementById('flags:daily');\r\n\t\tvar dailyLabels = utils.getDaysArray().map(function (text, idx) {\r\n\t\t\treturn idx % 3 ? '' : text;\r\n\t\t});\r\n\r\n\t\tif (utils.isMobile()) {\r\n\t\t\tChart.defaults.global.tooltips.enabled = false;\r\n\t\t}\r\n\t\tvar data = {\r\n\t\t\t'flags:daily': {\r\n\t\t\t\tlabels: dailyLabels,\r\n\t\t\t\tdatasets: [\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tlabel: '',\r\n\t\t\t\t\t\tbackgroundColor: 'rgba(151,187,205,0.2)',\r\n\t\t\t\t\t\tborderColor: 'rgba(151,187,205,1)',\r\n\t\t\t\t\t\tpointBackgroundColor: 'rgba(151,187,205,1)',\r\n\t\t\t\t\t\tpointHoverBackgroundColor: '#fff',\r\n\t\t\t\t\t\tpointBorderColor: '#fff',\r\n\t\t\t\t\t\tpointHoverBorderColor: 'rgba(151,187,205,1)',\r\n\t\t\t\t\t\tdata: ajaxify.data.analytics,\r\n\t\t\t\t\t},\r\n\t\t\t\t],\r\n\t\t\t},\r\n\t\t};\r\n\r\n\t\tdailyCanvas.width = $(dailyCanvas).parent().width();\r\n\t\tnew Chart(dailyCanvas.getContext('2d'), {\r\n\t\t\ttype: 'line',\r\n\t\t\tdata: data['flags:daily'],\r\n\t\t\toptions: {\r\n\t\t\t\tresponsive: true,\r\n\t\t\t\tanimation: false,\r\n\t\t\t\tlegend: {\r\n\t\t\t\t\tdisplay: false,\r\n\t\t\t\t},\r\n\t\t\t\tscales: {\r\n\t\t\t\t\tyAxes: [{\r\n\t\t\t\t\t\tticks: {\r\n\t\t\t\t\t\t\tbeginAtZero: true,\r\n\t\t\t\t\t\t\tprecision: 0,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t}],\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t});\r\n\t};\r\n\r\n\treturn Flags;\r\n});\r\n"]}