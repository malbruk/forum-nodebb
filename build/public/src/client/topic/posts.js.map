{"version":3,"sources":["public/src/client/topic/posts.js"],"names":["define","pagination","infinitescroll","postTools","images","navigator","components","translator","Posts","onNewPost","data","posts","length","parseInt","tid","ajaxify","loggedIn","app","user","uid","privileges","timestamp","topic","scheduled","Date","now","timestampISO","utils","toISOString","modifyPostsByPrivileges","updatePostCounts","updatePostIndices","postcount","updatePostCount","config","usePagination","onNewPostPagination","onNewPostInfiniteScroll","require","replies","forEach","post","selfPost","topicOwnerPost","display_edit_tools","isAdminOrMod","display_delete_tools","display_moderator_tools","display_move_tools","display_post_menu","locked","deleted","deleterUid","postSharing","i","cmp","get","html","attr","addCommasToNumbers","topicPostSort","index","not","each","newIndex","$","this","scrollToPost","scrollToPostIfSelf","pageCount","Math","max","ceil","postsPerPage","direction","isPostVisible","currentPage","createNewPosts","scrollToMyPost","setTimeout","loadPage","updatePagination","relative_path","page","paginationData","parseAndTranslate","after","remove","isPreviousPostAdded","go","pid","addClass","scrollBottom","repliesSelector","userScrolled","callback","removeAlreadyAddedPosts","newPosts","allSamePids","el","removeClass","p","hasClass","filter","before","last","first","window","trigger","Object","assign","insertAfter","height","document","scrollTop","insertBefore","append","removeExtra","onNewPostsAddedToDom","loadMorePosts","scrollActive","find","afterEl","isNumber","indicatorEl","is","fadeIn","loadMore","count","done","fadeOut","update","onTopicPageLoad","handlePrivateUploads","wrapImagesInLinks","showBottomPostBar","addBlockquoteEllipses","hidePostToolsForDeletedPosts","addTopicEvents","addNecroPostMessage","events","Array","isArray","eventIdsInDOM","from","querySelectorAll","map","getAttribute","event","includes","id","postTimestamps","reverse","slice","Promise","all","beforeIdx","findIndex","postEl","querySelector","resolve","then","timeago","necroThreshold","prev","diff","abs","suffixAgo","settings","strings","prefixAgo","suffixFromNow","prefixFromNow","translationText","inWords","text","privateUploads","loginEl","createElement","className","href","translate","translated","appendChild","createTextNode","idx","imgEl","startsWith","upload_url","replaceWith","cloneNode","createUserTooltips","makeNumbersHumanReadable","mainPost","placeHolder","clone","toggle","blockquotes","$this"],"mappings":"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","file":"public/src/client/topic/posts.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/topic/posts', [\r\n\t'forum/pagination',\r\n\t'forum/infinitescroll',\r\n\t'forum/topic/postTools',\r\n\t'forum/topic/images',\r\n\t'navigator',\r\n\t'components',\r\n\t'translator',\r\n], function (pagination, infinitescroll, postTools, images, navigator, components, translator) {\r\n\tvar Posts = { };\r\n\r\n\tPosts.onNewPost = function (data) {\r\n\t\tif (\r\n\t\t\t!data ||\r\n\t\t\t!data.posts ||\r\n\t\t\t!data.posts.length ||\r\n\t\t\tparseInt(data.posts[0].tid, 10) !== parseInt(ajaxify.data.tid, 10)\r\n\t\t) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tdata.loggedIn = !!app.user.uid;\r\n\t\tdata.privileges = ajaxify.data.privileges;\r\n\r\n\t\t// if not a scheduled topic, prevent timeago in future by setting timestamp to 1 sec behind now\r\n\t\tdata.posts[0].timestamp = data.posts[0].topic.scheduled ? data.posts[0].timestamp : Date.now() - 1000;\r\n\t\tdata.posts[0].timestampISO = utils.toISOString(data.posts[0].timestamp);\r\n\r\n\t\tPosts.modifyPostsByPrivileges(data.posts);\r\n\r\n\t\tupdatePostCounts(data.posts);\r\n\r\n\t\tupdatePostIndices(data.posts);\r\n\r\n\t\tajaxify.data.postcount += 1;\r\n\t\tpostTools.updatePostCount(ajaxify.data.postcount);\r\n\r\n\t\tif (config.usePagination) {\r\n\t\t\tonNewPostPagination(data);\r\n\t\t} else {\r\n\t\t\tonNewPostInfiniteScroll(data);\r\n\t\t}\r\n\r\n\t\trequire(['forum/topic/replies'], function (replies) {\r\n\t\t\treplies.onNewPost(data);\r\n\t\t});\r\n\t};\r\n\r\n\tPosts.modifyPostsByPrivileges = function (posts) {\r\n\t\tposts.forEach(function (post) {\r\n\t\t\tpost.selfPost = !!app.user.uid && parseInt(post.uid, 10) === parseInt(app.user.uid, 10);\r\n\t\t\tpost.topicOwnerPost = parseInt(post.uid, 10) === parseInt(ajaxify.data.uid, 10);\r\n\r\n\t\t\tpost.display_edit_tools = (ajaxify.data.privileges['posts:edit'] && post.selfPost) || ajaxify.data.privileges.isAdminOrMod;\r\n\t\t\tpost.display_delete_tools = (ajaxify.data.privileges['posts:delete'] && post.selfPost) || ajaxify.data.privileges.isAdminOrMod;\r\n\t\t\tpost.display_moderator_tools = post.display_edit_tools || post.display_delete_tools;\r\n\t\t\tpost.display_move_tools = ajaxify.data.privileges.isAdminOrMod;\r\n\t\t\tpost.display_post_menu = ajaxify.data.privileges.isAdminOrMod ||\r\n\t\t\t\t(post.selfPost && !ajaxify.data.locked && !post.deleted) ||\r\n\t\t\t\t(post.selfPost && post.deleted && parseInt(post.deleterUid, 10) === parseInt(app.user.uid, 10)) ||\r\n\t\t\t\t((app.user.uid || ajaxify.data.postSharing.length) && !post.deleted);\r\n\t\t});\r\n\t};\r\n\r\n\tfunction updatePostCounts(posts) {\r\n\t\tfor (var i = 0; i < posts.length; i += 1) {\r\n\t\t\tvar cmp = components.get('user/postcount', posts[i].uid);\r\n\t\t\tcmp.html(parseInt(cmp.attr('data-postcount'), 10) + 1);\r\n\t\t\tutils.addCommasToNumbers(cmp);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction updatePostIndices(posts) {\r\n\t\tif (config.topicPostSort === 'newest_to_oldest') {\r\n\t\t\tposts[0].index = 1;\r\n\t\t\tcomponents.get('post').not('[data-index=0]').each(function () {\r\n\t\t\t\tvar newIndex = parseInt($(this).attr('data-index'), 10) + 1;\r\n\t\t\t\t$(this).attr('data-index', newIndex);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tfunction onNewPostPagination(data) {\r\n\t\tfunction scrollToPost() {\r\n\t\t\tscrollToPostIfSelf(data.posts[0]);\r\n\t\t}\r\n\r\n\t\tvar posts = data.posts;\r\n\r\n\t\tajaxify.data.pagination.pageCount = Math.max(1, Math.ceil(posts[0].topic.postcount / config.postsPerPage));\r\n\t\tvar direction = config.topicPostSort === 'oldest_to_newest' || config.topicPostSort === 'most_votes' ? 1 : -1;\r\n\r\n\t\tvar isPostVisible = (\r\n\t\t\tajaxify.data.pagination.currentPage === ajaxify.data.pagination.pageCount &&\r\n\t\t\tdirection === 1\r\n\t\t) || (ajaxify.data.pagination.currentPage === 1 && direction === -1);\r\n\r\n\t\tif (isPostVisible) {\r\n\t\t\tcreateNewPosts(data, components.get('post').not('[data-index=0]'), direction, false, scrollToPost);\r\n\t\t} else if (ajaxify.data.scrollToMyPost && parseInt(posts[0].uid, 10) === parseInt(app.user.uid, 10)) {\r\n\t\t\t// https://github.com/NodeBB/NodeBB/issues/5004#issuecomment-247157441\r\n\t\t\tsetTimeout(function () {\r\n\t\t\t\tpagination.loadPage(ajaxify.data.pagination.pageCount, scrollToPost);\r\n\t\t\t}, 250);\r\n\t\t} else {\r\n\t\t\tupdatePagination();\r\n\t\t}\r\n\t}\r\n\r\n\tfunction updatePagination() {\r\n\t\t$.get(config.relative_path + '/api/topic/pagination/' + ajaxify.data.tid, { page: ajaxify.data.pagination.currentPage }, function (paginationData) {\r\n\t\t\tapp.parseAndTranslate('partials/paginator', paginationData, function (html) {\r\n\t\t\t\t$('[component=\"pagination\"]').after(html).remove();\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tfunction onNewPostInfiniteScroll(data) {\r\n\t\tvar direction = (config.topicPostSort === 'oldest_to_newest' || config.topicPostSort === 'most_votes') ? 1 : -1;\r\n\r\n\t\tvar isPreviousPostAdded = $('[component=\"post\"][data-index=\"' + (data.posts[0].index - 1) + '\"]').length;\r\n\t\tif (!isPreviousPostAdded && (!data.posts[0].selfPost || !ajaxify.data.scrollToMyPost)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (!isPreviousPostAdded && data.posts[0].selfPost) {\r\n\t\t\treturn ajaxify.go('post/' + data.posts[0].pid);\r\n\t\t}\r\n\r\n\t\tcreateNewPosts(data, components.get('post').not('[data-index=0]'), direction, false, function (html) {\r\n\t\t\tif (html) {\r\n\t\t\t\thtml.addClass('new');\r\n\t\t\t}\r\n\t\t\tscrollToPostIfSelf(data.posts[0]);\r\n\t\t});\r\n\t}\r\n\r\n\tfunction scrollToPostIfSelf(post) {\r\n\t\tif (post.selfPost && ajaxify.data.scrollToMyPost) {\r\n\t\t\tnavigator.scrollBottom(post.index);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction createNewPosts(data, repliesSelector, direction, userScrolled, callback) {\r\n\t\tcallback = callback || function () {};\r\n\t\tif (!data || (data.posts && !data.posts.length)) {\r\n\t\t\treturn callback();\r\n\t\t}\r\n\r\n\t\tfunction removeAlreadyAddedPosts() {\r\n\t\t\tvar newPosts = $('[component=\"post\"].new');\r\n\r\n\t\t\tif (newPosts.length === data.posts.length) {\r\n\t\t\t\tvar allSamePids = true;\r\n\t\t\t\tnewPosts.each(function (index, el) {\r\n\t\t\t\t\tif (parseInt($(el).attr('data-pid'), 10) !== parseInt(data.posts[index].pid, 10)) {\r\n\t\t\t\t\t\tallSamePids = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (allSamePids) {\r\n\t\t\t\t\tnewPosts.each(function () {\r\n\t\t\t\t\t\t$(this).removeClass('new');\r\n\t\t\t\t\t});\r\n\t\t\t\t\tdata.posts.length = 0;\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (newPosts.length && data.posts.length > 1) {\r\n\t\t\t\tdata.posts.forEach(function (post) {\r\n\t\t\t\t\tvar p = components.get('post', 'pid', post.pid);\r\n\t\t\t\t\tif (p.hasClass('new')) {\r\n\t\t\t\t\t\tp.remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tdata.posts = data.posts.filter(function (post) {\r\n\t\t\t\treturn $('[component=\"post\"][data-pid=\"' + post.pid + '\"]').length === 0;\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tremoveAlreadyAddedPosts();\r\n\r\n\t\tif (!data.posts.length) {\r\n\t\t\treturn callback();\r\n\t\t}\r\n\r\n\t\tvar after;\r\n\t\tvar before;\r\n\r\n\t\tif (direction > 0 && repliesSelector.length) {\r\n\t\t\tafter = repliesSelector.last();\r\n\t\t} else if (direction < 0 && repliesSelector.length) {\r\n\t\t\tbefore = repliesSelector.first();\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:posts.loading', { posts: data.posts, after: after, before: before });\r\n\r\n\t\tapp.parseAndTranslate('topic', 'posts', Object.assign({}, ajaxify.data, data), function (html) {\r\n\t\t\thtml = html.filter(function () {\r\n\t\t\t\tvar pid = $(this).attr('data-pid');\r\n\t\t\t\treturn pid && $('[component=\"post\"][data-pid=\"' + pid + '\"]').length === 0;\r\n\t\t\t});\r\n\r\n\t\t\tif (after) {\r\n\t\t\t\thtml.insertAfter(after);\r\n\t\t\t} else if (before) {\r\n\t\t\t\t// Save document height and position for future reference (about 5 lines down)\r\n\t\t\t\tvar height = $(document).height();\r\n\t\t\t\tvar scrollTop = $(window).scrollTop();\r\n\r\n\t\t\t\thtml.insertBefore(before);\r\n\r\n\t\t\t\t// Now restore the relative position the user was on prior to new post insertion\r\n\t\t\t\tif (userScrolled || scrollTop > 0) {\r\n\t\t\t\t\t$(window).scrollTop(scrollTop + ($(document).height() - height));\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tcomponents.get('topic').append(html);\r\n\t\t\t}\r\n\r\n\t\t\tinfinitescroll.removeExtra($('[component=\"post\"]'), direction, Math.max(20, config.postsPerPage * 2));\r\n\r\n\t\t\t$(window).trigger('action:posts.loaded', { posts: data.posts });\r\n\r\n\t\t\tPosts.onNewPostsAddedToDom(html);\r\n\r\n\t\t\tcallback(html);\r\n\t\t});\r\n\t}\r\n\r\n\tPosts.loadMorePosts = function (direction) {\r\n\t\tif (!components.get('topic').length || navigator.scrollActive) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar replies = components.get('topic').find(components.get('post').not('[data-index=0]').not('.new'));\r\n\t\tvar afterEl = direction > 0 ? replies.last() : replies.first();\r\n\t\tvar after = parseInt(afterEl.attr('data-index'), 10) || 0;\r\n\r\n\t\tvar tid = ajaxify.data.tid;\r\n\t\tif (!utils.isNumber(tid) || !utils.isNumber(after) || (direction < 0 && components.get('post', 'index', 0).length)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar indicatorEl = $('.loading-indicator');\r\n\t\tif (!indicatorEl.is(':animated')) {\r\n\t\t\tindicatorEl.fadeIn();\r\n\t\t}\r\n\r\n\t\tinfinitescroll.loadMore('topics.loadMore', {\r\n\t\t\ttid: tid,\r\n\t\t\tafter: after,\r\n\t\t\tcount: config.postsPerPage,\r\n\t\t\tdirection: direction,\r\n\t\t\ttopicPostSort: config.topicPostSort,\r\n\t\t}, function (data, done) {\r\n\t\t\tindicatorEl.fadeOut();\r\n\r\n\t\t\tif (data && data.posts && data.posts.length) {\r\n\t\t\t\tcreateNewPosts(data, replies, direction, true, done);\r\n\t\t\t} else {\r\n\t\t\t\tnavigator.update();\r\n\t\t\t\tdone();\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tPosts.onTopicPageLoad = function (posts) {\r\n\t\thandlePrivateUploads(posts);\r\n\t\timages.wrapImagesInLinks(posts);\r\n\t\tPosts.showBottomPostBar();\r\n\t\tposts.find('[component=\"post/content\"] img:not(.not-responsive)').addClass('img-responsive');\r\n\t\tPosts.addBlockquoteEllipses(posts);\r\n\t\thidePostToolsForDeletedPosts(posts);\r\n\t\tPosts.addTopicEvents();\r\n\t\taddNecroPostMessage();\r\n\t};\r\n\r\n\tPosts.addTopicEvents = function (events) {\r\n\t\tevents = events || ajaxify.data.events;\r\n\t\tif (!events || !Array.isArray(events)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (config.topicPostSort !== 'newest_to_oldest' && config.topicPostSort !== 'oldest_to_newest') {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Filter out events already in DOM\r\n\t\tconst eventIdsInDOM = Array.from(document.querySelectorAll('[component=\"topic/event\"]')).map(el => parseInt(el.getAttribute('data-topic-event-id'), 10));\r\n\t\tevents = events.filter(event => !eventIdsInDOM.includes(event.id));\r\n\r\n\t\tlet postTimestamps = ajaxify.data.posts.map(post => post.timestamp);\r\n\r\n\t\tconst reverse = config.topicPostSort === 'newest_to_oldest';\r\n\t\tevents = events.slice(0);\r\n\t\tif (reverse) {\r\n\t\t\tevents.reverse();\r\n\t\t\tpostTimestamps = postTimestamps.slice(1);\t// OP is always at top, so exclude from calculations\r\n\t\t}\r\n\r\n\t\tPromise.all(events.map((event) => {\r\n\t\t\tconst beforeIdx = postTimestamps.findIndex(\r\n\t\t\t\ttimestamp => (reverse ? (timestamp < event.timestamp) : (timestamp > event.timestamp))\r\n\t\t\t);\r\n\t\t\tlet postEl;\r\n\t\t\tif (beforeIdx > -1) {\r\n\t\t\t\tpostEl = document.querySelector(`[component=\"post\"][data-pid=\"${ajaxify.data.posts[beforeIdx + (reverse ? 1 : 0)].pid}\"]`);\r\n\t\t\t}\r\n\r\n\t\t\treturn new Promise((resolve) => {\r\n\t\t\t\tapp.parseAndTranslate('partials/topic/event', event, function (html) {\r\n\t\t\t\t\thtml = html.get(0);\r\n\r\n\t\t\t\t\tif (postEl) {\r\n\t\t\t\t\t\tdocument.querySelector('[component=\"topic\"]').insertBefore(html, postEl);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdocument.querySelector('[component=\"topic\"]').append(html);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tresolve();\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t})).then(() => {\r\n\t\t\t$('[component=\"topic/event\"] .timeago').timeago();\r\n\t\t});\r\n\t};\r\n\r\n\tfunction addNecroPostMessage() {\r\n\t\tvar necroThreshold = ajaxify.data.necroThreshold * 24 * 60 * 60 * 1000;\r\n\t\tif (!necroThreshold || (config.topicPostSort !== 'newest_to_oldest' && config.topicPostSort !== 'oldest_to_newest')) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$('[component=\"post\"]').each(function () {\r\n\t\t\tvar post = $(this);\r\n\t\t\tvar prev = post.prev('[component=\"post\"]');\r\n\t\t\tif (post.is(':has(.necro-post)') || !prev.length) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (config.topicPostSort === 'newest_to_oldest' && parseInt(prev.attr('data-index'), 10) === 0) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tvar diff = post.attr('data-timestamp') - prev.attr('data-timestamp');\r\n\t\t\tif (Math.abs(diff) >= necroThreshold) {\r\n\t\t\t\tvar suffixAgo = $.timeago.settings.strings.suffixAgo;\r\n\t\t\t\tvar prefixAgo = $.timeago.settings.strings.prefixAgo;\r\n\t\t\t\tvar suffixFromNow = $.timeago.settings.strings.suffixFromNow;\r\n\t\t\t\tvar prefixFromNow = $.timeago.settings.strings.prefixFromNow;\r\n\r\n\t\t\t\t$.timeago.settings.strings.suffixAgo = '';\r\n\t\t\t\t$.timeago.settings.strings.prefixAgo = '';\r\n\t\t\t\t$.timeago.settings.strings.suffixFromNow = '';\r\n\t\t\t\t$.timeago.settings.strings.prefixFromNow = '';\r\n\r\n\t\t\t\tvar translationText = (diff > 0 ? '[[topic:timeago_later,' : '[[topic:timeago_earlier,') + $.timeago.inWords(diff) + ']]';\r\n\r\n\t\t\t\t$.timeago.settings.strings.suffixAgo = suffixAgo;\r\n\t\t\t\t$.timeago.settings.strings.prefixAgo = prefixAgo;\r\n\t\t\t\t$.timeago.settings.strings.suffixFromNow = suffixFromNow;\r\n\t\t\t\t$.timeago.settings.strings.prefixFromNow = prefixFromNow;\r\n\t\t\t\tapp.parseAndTranslate('partials/topic/necro-post', { text: translationText }, function (html) {\r\n\t\t\t\t\thtml.insertBefore(post);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction handlePrivateUploads(posts) {\r\n\t\tif (app.user.uid || !ajaxify.data.privateUploads) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Replace all requests for uploaded images/files with a login link\r\n\t\tvar loginEl = document.createElement('a');\r\n\t\tloginEl.className = 'login-required';\r\n\t\tloginEl.href = config.relative_path + '/login';\r\n\r\n\t\ttranslator.translate('[[topic:login-to-view]]', function (translated) {\r\n\t\t\tloginEl.appendChild(document.createTextNode(translated));\r\n\t\t\tposts.each(function (idx, postEl) {\r\n\t\t\t\t$(postEl).find('[component=\"post/content\"] img').each(function (idx, imgEl) {\r\n\t\t\t\t\timgEl = $(imgEl);\r\n\t\t\t\t\tif (imgEl.attr('src').startsWith(config.relative_path + config.upload_url)) {\r\n\t\t\t\t\t\timgEl.replaceWith(loginEl.cloneNode(true));\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tPosts.onNewPostsAddedToDom = function (posts) {\r\n\t\tPosts.onTopicPageLoad(posts);\r\n\r\n\t\tapp.createUserTooltips(posts);\r\n\r\n\t\tutils.addCommasToNumbers(posts.find('.formatted-number'));\r\n\t\tutils.makeNumbersHumanReadable(posts.find('.human-readable-number'));\r\n\t\tposts.find('.timeago').timeago();\r\n\t};\r\n\r\n\tPosts.showBottomPostBar = function () {\r\n\t\tvar mainPost = components.get('post', 'index', 0);\r\n\t\tvar placeHolder = $('.post-bar-placeholder');\r\n\t\tvar posts = $('[component=\"post\"]');\r\n\t\tif (!!mainPost.length && posts.length > 1 && $('.post-bar').length < 2 && placeHolder.length) {\r\n\t\t\t$('.post-bar').clone().insertAfter(placeHolder);\r\n\t\t\tplaceHolder.remove();\r\n\t\t} else if (mainPost.length && posts.length < 2) {\r\n\t\t\tmainPost.find('.post-bar').remove();\r\n\t\t}\r\n\t};\r\n\r\n\tfunction hidePostToolsForDeletedPosts(posts) {\r\n\t\tposts.each(function () {\r\n\t\t\tif ($(this).hasClass('deleted')) {\r\n\t\t\t\tpostTools.toggle($(this).attr('data-pid'), true);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tPosts.addBlockquoteEllipses = function (posts) {\r\n\t\tvar blockquotes = posts.find('[component=\"post/content\"] > blockquote > blockquote');\r\n\t\tblockquotes.each(function () {\r\n\t\t\tvar $this = $(this);\r\n\t\t\tif ($this.find(':hidden:not(br)').length && !$this.find('.toggle').length) {\r\n\t\t\t\t$this.append('<i class=\"fa fa-angle-down pointer toggle\"></i>');\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\treturn Posts;\r\n});\r\n"]}