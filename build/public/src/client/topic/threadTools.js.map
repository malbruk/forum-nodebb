{"version":3,"sources":["public/src/client/topic/threadTools.js"],"names":["define","components","translator","handleBack","posts","api","ThreadTools","init","tid","topicContainer","renderMenu","on","topicCommand","socket","emit","err","app","alertError","previousUrl","match","ajaxify","go","onBackClicked","data","category","slug","alertSuccess","btn","$","this","message","parents","find","trigger","require","move","cid","deletePosts","fork","movePosts","changeWatching","type","state","method","setFollowState","alert","alert_id","timeout","window","title","container","$this","dropdownMenu","html","parseAndTranslate","element","path","command","onComplete","body","execute","ok","then","catch","bootbox","confirm","requestPinExpiry","bind","onSuccess","modal","dialog","onEscape","size","buttons","cancel","label","className","save","callback","expiryEl","get","querySelector","expiry","value","Date","getTime","now","setLockedState","threadEl","parseInt","attr","isLocked","privileges","isAdminOrMod","toggleClass","parent","hideReply","deleted","user","uid","locked","addTopicEvents","events","setDeleteState","isDelete","deleter","deletedTimestampISO","utils","toISOString","replaceWith","timeago","setPinnedState","pinned","icon","translateAttr","pinExpiry","pinExpiryISO","titles","follow","unfollow","ignore","translate","translatedTitle","tooltip","menu"],"mappings":"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","file":"public/src/client/topic/threadTools.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/topic/threadTools', [\r\n\t'components',\r\n\t'translator',\r\n\t'handleBack',\r\n\t'forum/topic/posts',\r\n\t'api',\r\n], function (components, translator, handleBack, posts, api) {\r\n\tvar ThreadTools = {};\r\n\r\n\tThreadTools.init = function (tid, topicContainer) {\r\n\t\trenderMenu(topicContainer);\r\n\r\n\t\t// function topicCommand(method, path, command, onComplete) {\r\n\t\ttopicContainer.on('click', '[component=\"topic/delete\"]', function () {\r\n\t\t\ttopicCommand('del', '/state', 'delete');\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/restore\"]', function () {\r\n\t\t\ttopicCommand('put', '/state', 'restore');\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/purge\"]', function () {\r\n\t\t\ttopicCommand('del', '', 'purge');\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/lock\"]', function () {\r\n\t\t\ttopicCommand('put', '/lock', 'lock');\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/unlock\"]', function () {\r\n\t\t\ttopicCommand('del', '/lock', 'unlock');\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/pin\"]', function () {\r\n\t\t\ttopicCommand('put', '/pin', 'pin');\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/unpin\"]', function () {\r\n\t\t\ttopicCommand('del', '/pin', 'unpin');\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\t// todo: should also use topicCommand, but no write api call exists for this yet\r\n\t\ttopicContainer.on('click', '[component=\"topic/mark-unread\"]', function () {\r\n\t\t\tsocket.emit('topics.markUnread', tid, function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (app.previousUrl && !app.previousUrl.match('^/topic')) {\r\n\t\t\t\t\tajaxify.go(app.previousUrl, function () {\r\n\t\t\t\t\t\thandleBack.onBackClicked(true);\r\n\t\t\t\t\t});\r\n\t\t\t\t} else if (ajaxify.data.category) {\r\n\t\t\t\t\tajaxify.go('category/' + ajaxify.data.category.slug, handleBack.onBackClicked);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tapp.alertSuccess('[[topic:mark_unread.success]]');\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/mark-unread-for-all\"]', function () {\r\n\t\t\tvar btn = $(this);\r\n\t\t\tsocket.emit('topics.markAsUnreadForAll', [tid], function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\t\t\t\tapp.alertSuccess('[[topic:markAsUnreadForAll.success]]');\r\n\t\t\t\tbtn.parents('.thread-tools.open').find('.dropdown-toggle').trigger('click');\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/move\"]', function () {\r\n\t\t\trequire(['forum/topic/move'], function (move) {\r\n\t\t\t\tmove.init([tid], ajaxify.data.cid);\r\n\t\t\t});\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/delete/posts\"]', function () {\r\n\t\t\trequire(['forum/topic/delete-posts'], function (deletePosts) {\r\n\t\t\t\tdeletePosts.init();\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/fork\"]', function () {\r\n\t\t\trequire(['forum/topic/fork'], function (fork) {\r\n\t\t\t\tfork.init();\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/move-posts\"]', function () {\r\n\t\t\trequire(['forum/topic/move-post'], function (movePosts) {\r\n\t\t\t\tmovePosts.init();\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\ttopicContainer.on('click', '[component=\"topic/following\"]', function () {\r\n\t\t\tchangeWatching('follow');\r\n\t\t});\r\n\t\ttopicContainer.on('click', '[component=\"topic/not-following\"]', function () {\r\n\t\t\tchangeWatching('follow', 0);\r\n\t\t});\r\n\t\ttopicContainer.on('click', '[component=\"topic/ignoring\"]', function () {\r\n\t\t\tchangeWatching('ignore');\r\n\t\t});\r\n\r\n\t\tfunction changeWatching(type, state = 1) {\r\n\t\t\tconst method = state ? 'put' : 'del';\r\n\t\t\tapi[method](`/topics/${tid}/${type}`, {}, () => {\r\n\t\t\t\tvar message = '';\r\n\t\t\t\tif (type === 'follow') {\r\n\t\t\t\t\tmessage = state ? '[[topic:following_topic.message]]' : '[[topic:not_following_topic.message]]';\r\n\t\t\t\t} else if (type === 'ignore') {\r\n\t\t\t\t\tmessage = state ? '[[topic:ignoring_topic.message]]' : '[[topic:not_following_topic.message]]';\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// From here on out, type changes to 'unfollow' if state is falsy\r\n\t\t\t\tif (!state) {\r\n\t\t\t\t\ttype = 'unfollow';\r\n\t\t\t\t}\r\n\r\n\t\t\t\tsetFollowState(type);\r\n\r\n\t\t\t\tapp.alert({\r\n\t\t\t\t\talert_id: 'follow_thread',\r\n\t\t\t\t\tmessage: message,\r\n\t\t\t\t\ttype: 'success',\r\n\t\t\t\t\ttimeout: 5000,\r\n\t\t\t\t});\r\n\r\n\t\t\t\t$(window).trigger('action:topics.changeWatching', { tid: tid, type: type });\r\n\t\t\t}, () => {\r\n\t\t\t\tapp.alert({\r\n\t\t\t\t\ttype: 'danger',\r\n\t\t\t\t\talert_id: 'topic_follow',\r\n\t\t\t\t\ttitle: '[[global:please_log_in]]',\r\n\t\t\t\t\tmessage: '[[topic:login_to_subscribe]]',\r\n\t\t\t\t\ttimeout: 5000,\r\n\t\t\t\t});\r\n\t\t\t});\r\n\r\n\t\t\treturn false;\r\n\t\t}\r\n\t};\r\n\r\n\tfunction renderMenu(container) {\r\n\t\tcontainer.on('show.bs.dropdown', '.thread-tools', function () {\r\n\t\t\tvar $this = $(this);\r\n\t\t\tvar dropdownMenu = $this.find('.dropdown-menu');\r\n\t\t\tif (dropdownMenu.html()) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tsocket.emit('topics.loadTopicTools', { tid: ajaxify.data.tid, cid: ajaxify.data.cid }, function (err, data) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err);\r\n\t\t\t\t}\r\n\t\t\t\tapp.parseAndTranslate('partials/topic/topic-menu-list', data, function (html) {\r\n\t\t\t\t\tdropdownMenu.html(html);\r\n\t\t\t\t\t$(window).trigger('action:topic.tools.load', {\r\n\t\t\t\t\t\telement: dropdownMenu,\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tfunction topicCommand(method, path, command, onComplete) {\r\n\t\tif (!onComplete) {\r\n\t\t\tonComplete = function () {};\r\n\t\t}\r\n\t\tconst tid = ajaxify.data.tid;\r\n\t\tconst body = {};\r\n\t\tconst execute = function (ok) {\r\n\t\t\tif (ok) {\r\n\t\t\t\tapi[method](`/topics/${tid}${path}`, body)\r\n\t\t\t\t\t.then(onComplete)\r\n\t\t\t\t\t.catch(app.alertError);\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tswitch (command) {\r\n\t\t\tcase 'delete':\r\n\t\t\tcase 'restore':\r\n\t\t\tcase 'purge':\r\n\t\t\t\tbootbox.confirm(`[[topic:thread_tools.${command}_confirm]]`, execute);\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tcase 'pin':\r\n\t\t\t\tThreadTools.requestPinExpiry(body, execute.bind(null, true));\r\n\t\t\t\tbreak;\r\n\r\n\t\t\tdefault:\r\n\t\t\t\texecute(true);\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\tThreadTools.requestPinExpiry = function (body, onSuccess) {\r\n\t\tapp.parseAndTranslate('modals/set-pin-expiry', {}, function (html) {\r\n\t\t\tconst modal = bootbox.dialog({\r\n\t\t\t\ttitle: '[[topic:thread_tools.pin]]',\r\n\t\t\t\tmessage: html,\r\n\t\t\t\tonEscape: true,\r\n\t\t\t\tsize: 'small',\r\n\t\t\t\tbuttons: {\r\n\t\t\t\t\tcancel: {\r\n\t\t\t\t\t\tlabel: '[[modules:bootbox.cancel]]',\r\n\t\t\t\t\t\tclassName: 'btn-link',\r\n\t\t\t\t\t},\r\n\t\t\t\t\tsave: {\r\n\t\t\t\t\t\tlabel: '[[global:save]]',\r\n\t\t\t\t\t\tclassName: 'btn-primary',\r\n\t\t\t\t\t\tcallback: function () {\r\n\t\t\t\t\t\t\tconst expiryEl = modal.get(0).querySelector('#expiry');\r\n\t\t\t\t\t\t\tlet expiry = expiryEl.value;\r\n\r\n\t\t\t\t\t\t\t// No expiry set\r\n\t\t\t\t\t\t\tif (expiry === '') {\r\n\t\t\t\t\t\t\t\treturn onSuccess();\r\n\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t// Expiration date set\r\n\t\t\t\t\t\t\texpiry = new Date(expiry);\r\n\r\n\t\t\t\t\t\t\tif (expiry && expiry.getTime() > Date.now()) {\r\n\t\t\t\t\t\t\t\tbody.expiry = expiry.getTime();\r\n\t\t\t\t\t\t\t\tonSuccess();\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tapp.alertError('[[error:invalid-date]]');\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tThreadTools.setLockedState = function (data) {\r\n\t\tvar threadEl = components.get('topic');\r\n\t\tif (parseInt(data.tid, 10) !== parseInt(threadEl.attr('data-tid'), 10)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar isLocked = data.isLocked && !ajaxify.data.privileges.isAdminOrMod;\r\n\r\n\t\tcomponents.get('topic/lock').toggleClass('hidden', data.isLocked).parent().attr('hidden', data.isLocked ? '' : null);\r\n\t\tcomponents.get('topic/unlock').toggleClass('hidden', !data.isLocked).parent().attr('hidden', !data.isLocked ? '' : null);\r\n\r\n\t\tvar hideReply = !!((data.isLocked || ajaxify.data.deleted) && !ajaxify.data.privileges.isAdminOrMod);\r\n\r\n\t\tcomponents.get('topic/reply/container').toggleClass('hidden', hideReply);\r\n\t\tcomponents.get('topic/reply/locked').toggleClass('hidden', ajaxify.data.privileges.isAdminOrMod || !data.isLocked || ajaxify.data.deleted);\r\n\r\n\t\tthreadEl.find('[component=\"post\"]:not(.deleted) [component=\"post/reply\"], [component=\"post\"]:not(.deleted) [component=\"post/quote\"]').toggleClass('hidden', hideReply);\r\n\t\tthreadEl.find('[component=\"post/edit\"], [component=\"post/delete\"]').toggleClass('hidden', isLocked);\r\n\r\n\t\tthreadEl.find('[component=\"post\"][data-uid=\"' + app.user.uid + '\"].deleted [component=\"post/tools\"]').toggleClass('hidden', isLocked);\r\n\r\n\t\t$('.topic-header [component=\"topic/locked\"]').toggleClass('hidden', !data.isLocked);\r\n\t\t$('[component=\"post/tools\"] .dropdown-menu').html('');\r\n\t\tajaxify.data.locked = data.isLocked;\r\n\r\n\t\tposts.addTopicEvents(data.events);\r\n\t};\r\n\r\n\tThreadTools.setDeleteState = function (data) {\r\n\t\tvar threadEl = components.get('topic');\r\n\t\tif (parseInt(data.tid, 10) !== parseInt(threadEl.attr('data-tid'), 10)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tcomponents.get('topic/delete').toggleClass('hidden', data.isDelete).parent().attr('hidden', data.isDelete ? '' : null);\r\n\t\tcomponents.get('topic/restore').toggleClass('hidden', !data.isDelete).parent().attr('hidden', !data.isDelete ? '' : null);\r\n\t\tcomponents.get('topic/purge').toggleClass('hidden', !data.isDelete).parent().attr('hidden', !data.isDelete ? '' : null);\r\n\t\tcomponents.get('topic/deleted/message').toggleClass('hidden', !data.isDelete);\r\n\r\n\t\tif (data.isDelete) {\r\n\t\t\tapp.parseAndTranslate('partials/topic/deleted-message', {\r\n\t\t\t\tdeleter: data.user,\r\n\t\t\t\tdeleted: true,\r\n\t\t\t\tdeletedTimestampISO: utils.toISOString(Date.now()),\r\n\t\t\t}, function (html) {\r\n\t\t\t\tcomponents.get('topic/deleted/message').replaceWith(html);\r\n\t\t\t\thtml.find('.timeago').timeago();\r\n\t\t\t});\r\n\t\t}\r\n\t\tvar hideReply = data.isDelete && !ajaxify.data.privileges.isAdminOrMod;\r\n\r\n\t\tcomponents.get('topic/reply/container').toggleClass('hidden', hideReply);\r\n\t\tcomponents.get('topic/reply/locked').toggleClass('hidden', ajaxify.data.privileges.isAdminOrMod || !ajaxify.data.locked || data.isDelete);\r\n\t\tthreadEl.find('[component=\"post\"]:not(.deleted) [component=\"post/reply\"], [component=\"post\"]:not(.deleted) [component=\"post/quote\"]').toggleClass('hidden', hideReply);\r\n\r\n\t\tthreadEl.toggleClass('deleted', data.isDelete);\r\n\t\tajaxify.data.deleted = data.isDelete ? 1 : 0;\r\n\r\n\t\tposts.addTopicEvents(data.events);\r\n\t};\r\n\r\n\r\n\tThreadTools.setPinnedState = function (data) {\r\n\t\tvar threadEl = components.get('topic');\r\n\t\tif (parseInt(data.tid, 10) !== parseInt(threadEl.attr('data-tid'), 10)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tcomponents.get('topic/pin').toggleClass('hidden', data.pinned).parent().attr('hidden', data.pinned ? '' : null);\r\n\t\tcomponents.get('topic/unpin').toggleClass('hidden', !data.pinned).parent().attr('hidden', !data.pinned ? '' : null);\r\n\t\tvar icon = $('.topic-header [component=\"topic/pinned\"]');\r\n\t\ticon.toggleClass('hidden', !data.pinned);\r\n\t\tif (data.pinned) {\r\n\t\t\ticon.translateAttr('title', (\r\n\t\t\t\tdata.pinExpiry && data.pinExpiryISO ?\r\n\t\t\t\t\t'[[topic:pinned-with-expiry, ' + data.pinExpiryISO + ']]' :\r\n\t\t\t\t\t'[[topic:pinned]]'\r\n\t\t\t));\r\n\t\t}\r\n\t\tajaxify.data.pinned = data.pinned;\r\n\r\n\t\tposts.addTopicEvents(data.events);\r\n\t};\r\n\r\n\tfunction setFollowState(state) {\r\n\t\tvar titles = {\r\n\t\t\tfollow: '[[topic:watching]]',\r\n\t\t\tunfollow: '[[topic:not-watching]]',\r\n\t\t\tignore: '[[topic:ignoring]]',\r\n\t\t};\r\n\t\ttranslator.translate(titles[state], function (translatedTitle) {\r\n\t\t\t$('[component=\"topic/watch\"] button')\r\n\t\t\t\t.attr('title', translatedTitle)\r\n\t\t\t\t.tooltip('fixTitle');\r\n\t\t});\r\n\r\n\t\tvar menu = components.get('topic/following/menu');\r\n\t\tmenu.toggleClass('hidden', state !== 'follow');\r\n\t\tcomponents.get('topic/following/check').toggleClass('fa-check', state === 'follow');\r\n\r\n\t\tmenu = components.get('topic/not-following/menu');\r\n\t\tmenu.toggleClass('hidden', state !== 'unfollow');\r\n\t\tcomponents.get('topic/not-following/check').toggleClass('fa-check', state === 'unfollow');\r\n\r\n\t\tmenu = components.get('topic/ignoring/menu');\r\n\t\tmenu.toggleClass('hidden', state !== 'ignore');\r\n\t\tcomponents.get('topic/ignoring/check').toggleClass('fa-check', state === 'ignore');\r\n\t}\r\n\r\n\r\n\treturn ThreadTools;\r\n});\r\n"]}