{"version":3,"sources":["public/src/client/topic/postTools.js"],"names":["define","share","navigator","components","translator","votes","api","bootbox","PostTools","staleReplyAnyway","init","tid","renderMenu","addPostHandlers","addShareHandlers","ajaxify","data","titleRaw","addVoteHandler","updatePostCount","postcount","$","on","$this","this","dropdownMenu","find","html","postEl","parents","pid","attr","index","parseInt","socket","emit","cid","err","app","alertError","message","posts","display_move_tools","parseAndTranslate","require","clipboard","window","trigger","toggle","isDeleted","get","toggleClass","parent","removeMenu","postCount","postCountEl","utils","makeNumbersHumanReadable","setCount","postContainer","onQuoteClicked","onReplyClicked","e","preventDefault","translate","config","relative_path","slug","body","bookmarkPost","getData","toggleVote","showVotes","flags","showFlagModal","type","id","uid","flagId","resolve","btn","timestamp","postEditDuration","checkDuration","enablePostHistory","privileges","diffs","open","postDeleteDuration","togglePostDelete","duration","postTimestamp","languageKey","isAdminOrMod","Date","now","numDays","Math","floor","numHours","numMinutes","numSeconds","msg","purgePost","movePost","changeOwner","ip","alertSuccess","openChat","button","selectedNode","getSelectedNode","showStaleWarning","username","getUserSlug","toPid","is","text","topicName","selectedPid","val","quote","post","selectedText","selection","getSelection","document","createRange","postContents","content","each","el","containsNode","bounds","selectNodeContents","range","getRangeAt","cloneRange","compareBoundaryPoints","Range","START_TO_START","setStart","startContainer","startOffset","END_TO_END","setEnd","endContainer","endOffset","detach","toString","method","undefined","length","action","hasClass","postAction","confirm","route","catch","newChat","click","callback","staleThreshold","min","topicStaleDays","lastposttime","warning","dialog","title","buttons","reply","label","className","create","fromStaleTopic","modal"],"mappings":"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","file":"public/src/client/topic/postTools.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/topic/postTools', [\r\n\t'share',\r\n\t'navigator',\r\n\t'components',\r\n\t'translator',\r\n\t'forum/topic/votes',\r\n\t'api',\r\n\t'bootbox',\r\n], function (share, navigator, components, translator, votes, api, bootbox) {\r\n\tvar PostTools = {};\r\n\r\n\tvar staleReplyAnyway = false;\r\n\r\n\tPostTools.init = function (tid) {\r\n\t\tstaleReplyAnyway = false;\r\n\r\n\t\trenderMenu();\r\n\r\n\t\taddPostHandlers(tid);\r\n\r\n\t\tshare.addShareHandlers(ajaxify.data.titleRaw);\r\n\r\n\t\tvotes.addVoteHandler();\r\n\r\n\t\tPostTools.updatePostCount(ajaxify.data.postcount);\r\n\t};\r\n\r\n\tfunction renderMenu() {\r\n\t\t$('[component=\"topic\"]').on('show.bs.dropdown', '.moderator-tools', function () {\r\n\t\t\tvar $this = $(this);\r\n\t\t\tvar dropdownMenu = $this.find('.dropdown-menu');\r\n\t\t\tif (dropdownMenu.html()) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tvar postEl = $this.parents('[data-pid]');\r\n\t\t\tvar pid = postEl.attr('data-pid');\r\n\t\t\tvar index = parseInt(postEl.attr('data-index'), 10);\r\n\r\n\t\t\tsocket.emit('posts.loadPostTools', { pid: pid, cid: ajaxify.data.cid }, function (err, data) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\t\t\t\tdata.posts.display_move_tools = data.posts.display_move_tools && index !== 0;\r\n\r\n\t\t\t\tapp.parseAndTranslate('partials/topic/post-menu-list', data, function (html) {\r\n\t\t\t\t\tdropdownMenu.html(html);\r\n\t\t\t\t\trequire(['clipboard'], function (clipboard) {\r\n\t\t\t\t\t\tnew clipboard('[data-clipboard-text]');\r\n\t\t\t\t\t});\r\n\t\t\t\t\t$(window).trigger('action:post.tools.load');\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tPostTools.toggle = function (pid, isDeleted) {\r\n\t\tvar postEl = components.get('post', 'pid', pid);\r\n\r\n\t\tpostEl.find('[component=\"post/quote\"], [component=\"post/bookmark\"], [component=\"post/reply\"], [component=\"post/flag\"], [component=\"user/chat\"]')\r\n\t\t\t.toggleClass('hidden', isDeleted);\r\n\r\n\t\tpostEl.find('[component=\"post/delete\"]').toggleClass('hidden', isDeleted).parent().attr('hidden', isDeleted ? '' : null);\r\n\t\tpostEl.find('[component=\"post/restore\"]').toggleClass('hidden', !isDeleted).parent().attr('hidden', !isDeleted ? '' : null);\r\n\t\tpostEl.find('[component=\"post/purge\"]').toggleClass('hidden', !isDeleted).parent().attr('hidden', !isDeleted ? '' : null);\r\n\r\n\t\tPostTools.removeMenu(postEl);\r\n\t};\r\n\r\n\tPostTools.removeMenu = function (postEl) {\r\n\t\tpostEl.find('[component=\"post/tools\"] .dropdown-menu').html('');\r\n\t};\r\n\r\n\tPostTools.updatePostCount = function (postCount) {\r\n\t\tvar postCountEl = components.get('topic/post-count');\r\n\t\tpostCountEl.html(postCount).attr('title', postCount);\r\n\t\tutils.makeNumbersHumanReadable(postCountEl);\r\n\t\tnavigator.setCount(postCount);\r\n\t};\r\n\r\n\tfunction addPostHandlers(tid) {\r\n\t\tvar postContainer = components.get('topic');\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/quote\"]', function () {\r\n\t\t\tonQuoteClicked($(this), tid);\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/reply\"]', function () {\r\n\t\t\tonReplyClicked($(this), tid);\r\n\t\t});\r\n\r\n\t\t$('.topic').on('click', '[component=\"topic/reply\"]', function (e) {\r\n\t\t\te.preventDefault();\r\n\t\t\tonReplyClicked($(this), tid);\r\n\t\t});\r\n\r\n\t\t$('.topic').on('click', '[component=\"topic/reply-as-topic\"]', function () {\r\n\t\t\ttranslator.translate('[[topic:link_back, ' + ajaxify.data.titleRaw + ', ' + config.relative_path + '/topic/' + ajaxify.data.slug + ']]', function (body) {\r\n\t\t\t\t$(window).trigger('action:composer.topic.new', {\r\n\t\t\t\t\tcid: ajaxify.data.cid,\r\n\t\t\t\t\tbody: body,\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/bookmark\"]', function () {\r\n\t\t\treturn bookmarkPost($(this), getData($(this), 'data-pid'));\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/upvote\"]', function () {\r\n\t\t\treturn votes.toggleVote($(this), '.upvoted', 1);\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/downvote\"]', function () {\r\n\t\t\treturn votes.toggleVote($(this), '.downvoted', -1);\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/vote-count\"]', function () {\r\n\t\t\tvotes.showVotes(getData($(this), 'data-pid'));\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/flag\"]', function () {\r\n\t\t\tvar pid = getData($(this), 'data-pid');\r\n\t\t\trequire(['flags'], function (flags) {\r\n\t\t\t\tflags.showFlagModal({\r\n\t\t\t\t\ttype: 'post',\r\n\t\t\t\t\tid: pid,\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/flagUser\"]', function () {\r\n\t\t\tvar uid = getData($(this), 'data-uid');\r\n\t\t\trequire(['flags'], function (flags) {\r\n\t\t\t\tflags.showFlagModal({\r\n\t\t\t\t\ttype: 'user',\r\n\t\t\t\t\tid: uid,\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/flagResolve\"]', function () {\r\n\t\t\tvar flagId = $(this).attr('data-flagId');\r\n\t\t\trequire(['flags'], function (flags) {\r\n\t\t\t\tflags.resolve(flagId);\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/edit\"]', function () {\r\n\t\t\tvar btn = $(this);\r\n\r\n\t\t\tvar timestamp = parseInt(getData(btn, 'data-timestamp'), 10);\r\n\t\t\tvar postEditDuration = parseInt(ajaxify.data.postEditDuration, 10);\r\n\r\n\t\t\tif (checkDuration(postEditDuration, timestamp, 'post-edit-duration-expired')) {\r\n\t\t\t\t$(window).trigger('action:composer.post.edit', {\r\n\t\t\t\t\tpid: getData(btn, 'data-pid'),\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tif (config.enablePostHistory && ajaxify.data.privileges['posts:history']) {\r\n\t\t\tpostContainer.on('click', '[component=\"post/view-history\"], [component=\"post/edit-indicator\"]', function () {\r\n\t\t\t\tvar btn = $(this);\r\n\t\t\t\trequire(['forum/topic/diffs'], function (diffs) {\r\n\t\t\t\t\tdiffs.open(getData(btn, 'data-pid'));\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/delete\"]', function () {\r\n\t\t\tvar btn = $(this);\r\n\t\t\tvar timestamp = parseInt(getData(btn, 'data-timestamp'), 10);\r\n\t\t\tvar postDeleteDuration = parseInt(ajaxify.data.postDeleteDuration, 10);\r\n\t\t\tif (checkDuration(postDeleteDuration, timestamp, 'post-delete-duration-expired')) {\r\n\t\t\t\ttogglePostDelete($(this));\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tfunction checkDuration(duration, postTimestamp, languageKey) {\r\n\t\t\tif (!ajaxify.data.privileges.isAdminOrMod && duration && Date.now() - postTimestamp > duration * 1000) {\r\n\t\t\t\tvar numDays = Math.floor(duration / 86400);\r\n\t\t\t\tvar numHours = Math.floor((duration % 86400) / 3600);\r\n\t\t\t\tvar numMinutes = Math.floor(((duration % 86400) % 3600) / 60);\r\n\t\t\t\tvar numSeconds = ((duration % 86400) % 3600) % 60;\r\n\t\t\t\tvar msg = '[[error:' + languageKey + ', ' + duration + ']]';\r\n\t\t\t\tif (numDays) {\r\n\t\t\t\t\tif (numHours) {\r\n\t\t\t\t\t\tmsg = '[[error:' + languageKey + '-days-hours, ' + numDays + ', ' + numHours + ']]';\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tmsg = '[[error:' + languageKey + '-days, ' + numDays + ']]';\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (numHours) {\r\n\t\t\t\t\tif (numMinutes) {\r\n\t\t\t\t\t\tmsg = '[[error:' + languageKey + '-hours-minutes, ' + numHours + ', ' + numMinutes + ']]';\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tmsg = '[[error:' + languageKey + '-hours, ' + numHours + ']]';\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if (numMinutes) {\r\n\t\t\t\t\tif (numSeconds) {\r\n\t\t\t\t\t\tmsg = '[[error:' + languageKey + '-minutes-seconds, ' + numMinutes + ', ' + numSeconds + ']]';\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tmsg = '[[error:' + languageKey + '-minutes, ' + numMinutes + ']]';\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tapp.alertError(msg);\r\n\t\t\t\treturn false;\r\n\t\t\t}\r\n\t\t\treturn true;\r\n\t\t}\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/restore\"]', function () {\r\n\t\t\ttogglePostDelete($(this));\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/purge\"]', function () {\r\n\t\t\tpurgePost($(this));\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/move\"]', function () {\r\n\t\t\tvar btn = $(this);\r\n\t\t\trequire(['forum/topic/move-post'], function (movePost) {\r\n\t\t\t\tmovePost.init(btn.parents('[data-pid]'));\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/change-owner\"]', function () {\r\n\t\t\tvar btn = $(this);\r\n\t\t\trequire(['forum/topic/change-owner'], function (changeOwner) {\r\n\t\t\t\tchangeOwner.init(btn.parents('[data-pid]'));\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/ban-ip\"]', function () {\r\n\t\t\tvar ip = $(this).attr('data-ip');\r\n\t\t\tsocket.emit('blacklist.addRule', ip, function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\t\t\t\tapp.alertSuccess('[[admin/manage/blacklist:ban-ip]]');\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\tpostContainer.on('click', '[component=\"post/chat\"]', function () {\r\n\t\t\topenChat($(this));\r\n\t\t});\r\n\t}\r\n\r\n\tfunction onReplyClicked(button, tid) {\r\n\t\tvar selectedNode = getSelectedNode();\r\n\r\n\t\tshowStaleWarning(function () {\r\n\t\t\tvar username = getUserSlug(button);\r\n\t\t\tif (getData(button, 'data-uid') === '0' || !getData(button, 'data-userslug')) {\r\n\t\t\t\tusername = '';\r\n\t\t\t}\r\n\r\n\t\t\tvar toPid = button.is('[component=\"post/reply\"]') ? getData(button, 'data-pid') : null;\r\n\r\n\t\t\tif (selectedNode.text && (!toPid || !selectedNode.pid || toPid === selectedNode.pid)) {\r\n\t\t\t\tusername = username || selectedNode.username;\r\n\t\t\t\t$(window).trigger('action:composer.addQuote', {\r\n\t\t\t\t\ttid: tid,\r\n\t\t\t\t\tpid: toPid,\r\n\t\t\t\t\ttopicName: ajaxify.data.titleRaw,\r\n\t\t\t\t\tusername: username,\r\n\t\t\t\t\ttext: selectedNode.text,\r\n\t\t\t\t\tselectedPid: selectedNode.pid,\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\t$(window).trigger('action:composer.post.new', {\r\n\t\t\t\t\ttid: tid,\r\n\t\t\t\t\tpid: toPid,\r\n\t\t\t\t\ttopicName: ajaxify.data.titleRaw,\r\n\t\t\t\t\ttext: username ? username + ' ' : ($('[component=\"topic/quickreply/text\"]').val() || ''),\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction onQuoteClicked(button, tid) {\r\n\t\tvar selectedNode = getSelectedNode();\r\n\r\n\t\tshowStaleWarning(function () {\r\n\t\t\tvar username = getUserSlug(button);\r\n\t\t\tvar toPid = getData(button, 'data-pid');\r\n\r\n\t\t\tfunction quote(text) {\r\n\t\t\t\t$(window).trigger('action:composer.addQuote', {\r\n\t\t\t\t\ttid: tid,\r\n\t\t\t\t\tpid: toPid,\r\n\t\t\t\t\tusername: username,\r\n\t\t\t\t\ttopicName: ajaxify.data.titleRaw,\r\n\t\t\t\t\ttext: text,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tif (selectedNode.text && toPid && toPid === selectedNode.pid) {\r\n\t\t\t\treturn quote(selectedNode.text);\r\n\t\t\t}\r\n\t\t\tsocket.emit('posts.getRawPost', toPid, function (err, post) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tquote(post);\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tfunction getSelectedNode() {\r\n\t\tvar selectedText = '';\r\n\t\tvar selectedPid;\r\n\t\tvar username = '';\r\n\t\tvar selection = window.getSelection ? window.getSelection() : document.selection.createRange();\r\n\t\tvar postContents = $('[component=\"post\"] [component=\"post/content\"]');\r\n\t\tvar content;\r\n\t\tpostContents.each(function (index, el) {\r\n\t\t\tif (selection && selection.containsNode && el && selection.containsNode(el, true)) {\r\n\t\t\t\tcontent = el;\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\tif (content) {\r\n\t\t\tvar bounds = document.createRange();\r\n\t\t\tbounds.selectNodeContents(content);\r\n\t\t\tvar range = selection.getRangeAt(0).cloneRange();\r\n\t\t\tif (range.compareBoundaryPoints(Range.START_TO_START, bounds) < 0) {\r\n\t\t\t\trange.setStart(bounds.startContainer, bounds.startOffset);\r\n\t\t\t}\r\n\t\t\tif (range.compareBoundaryPoints(Range.END_TO_END, bounds) > 0) {\r\n\t\t\t\trange.setEnd(bounds.endContainer, bounds.endOffset);\r\n\t\t\t}\r\n\t\t\tbounds.detach();\r\n\t\t\tselectedText = range.toString();\r\n\t\t\tvar postEl = $(content).parents('[component=\"post\"]');\r\n\t\t\tselectedPid = postEl.attr('data-pid');\r\n\t\t\tusername = getUserSlug($(content));\r\n\t\t\trange.detach();\r\n\t\t}\r\n\t\treturn { text: selectedText, pid: selectedPid, username: username };\r\n\t}\r\n\r\n\tfunction bookmarkPost(button, pid) {\r\n\t\tvar method = button.attr('data-bookmarked') === 'false' ? 'put' : 'del';\r\n\r\n\t\tapi[method](`/posts/${pid}/bookmark`, undefined, function (err) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err);\r\n\t\t\t}\r\n\t\t\tvar type = method === 'put' ? 'bookmark' : 'unbookmark';\r\n\t\t\t$(window).trigger('action:post.' + type, { pid: pid });\r\n\t\t});\r\n\t\treturn false;\r\n\t}\r\n\r\n\tfunction getData(button, data) {\r\n\t\treturn button.parents('[data-pid]').attr(data);\r\n\t}\r\n\r\n\tfunction getUserSlug(button) {\r\n\t\tvar slug = '';\r\n\t\tvar post = button.parents('[data-pid]');\r\n\r\n\t\tif (button.attr('component') === 'topic/reply') {\r\n\t\t\treturn slug;\r\n\t\t}\r\n\r\n\t\tif (post.length) {\r\n\t\t\tslug = post.attr('data-userslug');\r\n\t\t\tif (!slug) {\r\n\t\t\t\tif (post.attr('data-uid') !== '0') {\r\n\t\t\t\t\tslug = '[[global:former_user]]';\r\n\t\t\t\t} else {\r\n\t\t\t\t\tslug = '[[global:guest]]';\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (post.length && post.attr('data-uid') !== '0') {\r\n\t\t\tslug = '@' + slug;\r\n\t\t}\r\n\r\n\t\treturn slug;\r\n\t}\r\n\r\n\tfunction togglePostDelete(button) {\r\n\t\tvar pid = getData(button, 'data-pid');\r\n\t\tvar postEl = components.get('post', 'pid', pid);\r\n\t\tvar action = !postEl.hasClass('deleted') ? 'delete' : 'restore';\r\n\r\n\t\tpostAction(action, pid);\r\n\t}\r\n\r\n\tfunction purgePost(button) {\r\n\t\tpostAction('purge', getData(button, 'data-pid'));\r\n\t}\r\n\r\n\tfunction postAction(action, pid) {\r\n\t\tbootbox.confirm('[[topic:post_' + action + '_confirm]]', function (confirm) {\r\n\t\t\tif (!confirm) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst route = action === 'purge' ? '' : '/state';\r\n\t\t\tconst method = action === 'restore' ? 'put' : 'del';\r\n\t\t\tapi[method](`/posts/${pid}${route}`).catch(app.alertError);\r\n\t\t});\r\n\t}\r\n\r\n\tfunction openChat(button) {\r\n\t\tvar post = button.parents('[data-pid]');\r\n\r\n\t\tapp.newChat(post.attr('data-uid'));\r\n\t\tbutton.parents('.btn-group').find('.dropdown-toggle').click();\r\n\t\treturn false;\r\n\t}\r\n\r\n\tfunction showStaleWarning(callback) {\r\n\t\tvar staleThreshold = Math.min(Date.now() - (1000 * 60 * 60 * 24 * ajaxify.data.topicStaleDays), 8640000000000000);\r\n\t\tif (staleReplyAnyway || ajaxify.data.lastposttime >= staleThreshold) {\r\n\t\t\treturn callback();\r\n\t\t}\r\n\r\n\t\tvar warning = bootbox.dialog({\r\n\t\t\ttitle: '[[topic:stale.title]]',\r\n\t\t\tmessage: '[[topic:stale.warning]]',\r\n\t\t\tbuttons: {\r\n\t\t\t\treply: {\r\n\t\t\t\t\tlabel: '[[topic:stale.reply_anyway]]',\r\n\t\t\t\t\tclassName: 'btn-link',\r\n\t\t\t\t\tcallback: function () {\r\n\t\t\t\t\t\tstaleReplyAnyway = true;\r\n\t\t\t\t\t\tcallback();\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t\tcreate: {\r\n\t\t\t\t\tlabel: '[[topic:stale.create]]',\r\n\t\t\t\t\tclassName: 'btn-primary',\r\n\t\t\t\t\tcallback: function () {\r\n\t\t\t\t\t\ttranslator.translate('[[topic:link_back, ' + ajaxify.data.title + ', ' + config.relative_path + '/topic/' + ajaxify.data.slug + ']]', function (body) {\r\n\t\t\t\t\t\t\t$(window).trigger('action:composer.topic.new', {\r\n\t\t\t\t\t\t\t\tcid: ajaxify.data.cid,\r\n\t\t\t\t\t\t\t\tbody: body,\r\n\t\t\t\t\t\t\t\tfromStaleTopic: true,\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t},\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\twarning.modal();\r\n\t}\r\n\r\n\treturn PostTools;\r\n});\r\n"]}