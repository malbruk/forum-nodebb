{"version":3,"sources":["public/src/client/groups/memberlist.js"],"names":["define","api","MemberList","searchInterval","groupName","templateName","init","_templateName","ajaxify","data","group","name","handleMemberAdd","handleMemberSearch","handleMemberInfiniteScroll","$","on","app","parseAndTranslate","html","foundUsers","modal","bootbox","dialog","title","message","buttons","ok","callback","users","find","each","index","el","push","attr","addUserToGroup","isSelected","this","removeAttr","toggleClass","get","query","val","paginate","err","result","alertError","forEach","user","uid","done","filter","length","prepend","uids","map","socket","emit","Promise","all","put","slug","then","catch","clearInterval","setTimeout","results","$this","bottom","scrollHeight","innerHeight","scrollTop","loadMoreMembers","members","after","onMembersLoaded","nextStart","append","isOwner"],"mappings":"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","file":"public/src/client/groups/memberlist.js","sourcesContent":["'use strict';\r\n\r\ndefine('forum/groups/memberlist', ['api'], function (api) {\r\n\tvar MemberList = {};\r\n\tvar searchInterval;\r\n\tvar groupName;\r\n\tvar templateName;\r\n\r\n\tMemberList.init = function (_templateName) {\r\n\t\ttemplateName = _templateName || 'groups/details';\r\n\t\tgroupName = ajaxify.data.group.name;\r\n\r\n\t\thandleMemberAdd();\r\n\t\thandleMemberSearch();\r\n\t\thandleMemberInfiniteScroll();\r\n\t};\r\n\r\n\tfunction handleMemberAdd() {\r\n\t\t$('[component=\"groups/members/add\"]').on('click', function () {\r\n\t\t\tapp.parseAndTranslate('admin/partials/groups/add-members', {}, function (html) {\r\n\t\t\t\tvar foundUsers = [];\r\n\t\t\t\tvar modal = bootbox.dialog({\r\n\t\t\t\t\ttitle: '[[groups:details.add-member]]',\r\n\t\t\t\t\tmessage: html,\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\tok: {\r\n\t\t\t\t\t\t\tcallback: function () {\r\n\t\t\t\t\t\t\t\tvar users = [];\r\n\t\t\t\t\t\t\t\tmodal.find('[data-uid][data-selected]').each(function (index, el) {\r\n\t\t\t\t\t\t\t\t\tusers.push(foundUsers[$(el).attr('data-uid')]);\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\taddUserToGroup(users, function () {\r\n\t\t\t\t\t\t\t\t\tmodal.modal('hide');\r\n\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t\tmodal.on('click', '[data-username]', function () {\r\n\t\t\t\t\tvar isSelected = $(this).attr('data-selected') === '1';\r\n\t\t\t\t\tif (isSelected) {\r\n\t\t\t\t\t\t$(this).removeAttr('data-selected');\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t$(this).attr('data-selected', 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t\t$(this).find('i').toggleClass('invisible');\r\n\t\t\t\t});\r\n\t\t\t\tmodal.find('input').on('keyup', function () {\r\n\t\t\t\t\tapi.get('/api/users', {\r\n\t\t\t\t\t\tquery: $(this).val(),\r\n\t\t\t\t\t\tpaginate: false,\r\n\t\t\t\t\t}, function (err, result) {\r\n\t\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tresult.users.forEach(function (user) {\r\n\t\t\t\t\t\t\tfoundUsers[user.uid] = user;\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\tapp.parseAndTranslate('admin/partials/groups/add-members', 'users', { users: result.users }, function (html) {\r\n\t\t\t\t\t\t\tmodal.find('#search-result').html(html);\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tfunction addUserToGroup(users, callback) {\r\n\t\tfunction done() {\r\n\t\t\tusers = users.filter(function (user) {\r\n\t\t\t\treturn !$('[component=\"groups/members\"] [data-uid=\"' + user.uid + '\"]').length;\r\n\t\t\t});\r\n\t\t\tparseAndTranslate(users, function (html) {\r\n\t\t\t\t$('[component=\"groups/members\"] tbody').prepend(html);\r\n\t\t\t});\r\n\t\t\tcallback();\r\n\t\t}\r\n\t\tvar uids = users.map(function (user) { return user.uid; });\r\n\t\tif (groupName === 'administrators') {\r\n\t\t\tsocket.emit('admin.user.makeAdmins', uids, function (err) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err);\r\n\t\t\t\t}\r\n\t\t\t\tdone();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tPromise.all(uids.map(uid => api.put('/groups/' + ajaxify.data.group.slug + '/membership/' + uid))).then(done).catch(app.alertError);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction handleMemberSearch() {\r\n\t\t$('[component=\"groups/members/search\"]').on('keyup', function () {\r\n\t\t\tvar query = $(this).val();\r\n\t\t\tif (searchInterval) {\r\n\t\t\t\tclearInterval(searchInterval);\r\n\t\t\t\tsearchInterval = 0;\r\n\t\t\t}\r\n\r\n\t\t\tsearchInterval = setTimeout(function () {\r\n\t\t\t\tsocket.emit('groups.searchMembers', { groupName: groupName, query: query }, function (err, results) {\r\n\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tparseAndTranslate(results.users, function (html) {\r\n\t\t\t\t\t\t$('[component=\"groups/members\"] tbody').html(html);\r\n\t\t\t\t\t\t$('[component=\"groups/members\"]').attr('data-nextstart', 20);\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t}, 250);\r\n\t\t});\r\n\t}\r\n\r\n\tfunction handleMemberInfiniteScroll() {\r\n\t\t$('[component=\"groups/members\"] tbody').on('scroll', function () {\r\n\t\t\tvar $this = $(this);\r\n\t\t\tvar bottom = ($this[0].scrollHeight - $this.innerHeight()) * 0.9;\r\n\r\n\t\t\tif ($this.scrollTop() > bottom && !$('[component=\"groups/members/search\"]').val()) {\r\n\t\t\t\tloadMoreMembers();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction loadMoreMembers() {\r\n\t\tvar members = $('[component=\"groups/members\"]');\r\n\t\tif (members.attr('loading')) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tmembers.attr('loading', 1);\r\n\t\tsocket.emit('groups.loadMoreMembers', {\r\n\t\t\tgroupName: groupName,\r\n\t\t\tafter: members.attr('data-nextstart'),\r\n\t\t}, function (err, data) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tif (data && data.users.length) {\r\n\t\t\t\tonMembersLoaded(data.users, function () {\r\n\t\t\t\t\tmembers.removeAttr('loading');\r\n\t\t\t\t\tmembers.attr('data-nextstart', data.nextStart);\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tmembers.removeAttr('loading');\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction onMembersLoaded(users, callback) {\r\n\t\tusers = users.filter(function (user) {\r\n\t\t\treturn !$('[component=\"groups/members\"] [data-uid=\"' + user.uid + '\"]').length;\r\n\t\t});\r\n\r\n\t\tparseAndTranslate(users, function (html) {\r\n\t\t\t$('[component=\"groups/members\"] tbody').append(html);\r\n\t\t\tcallback();\r\n\t\t});\r\n\t}\r\n\r\n\tfunction parseAndTranslate(users, callback) {\r\n\t\tapp.parseAndTranslate(templateName, 'group.members', {\r\n\t\t\tgroup: {\r\n\t\t\t\tmembers: users,\r\n\t\t\t\tisOwner: ajaxify.data.group.isOwner,\r\n\t\t\t},\r\n\t\t}, callback);\r\n\t}\r\n\r\n\treturn MemberList;\r\n});\r\n"]}