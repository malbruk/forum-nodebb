"use strict";define("composer",["taskbar","translator","composer/uploads","composer/formatting","composer/drafts","composer/tags","composer/categoryList","composer/preview","composer/resize","composer/autocomplete","composer/scheduler","scrollStop","topicThumbs","api","bootbox","hooks"],function(t,e,i,a,o,n,r,s,d,c,p,l,m,u,f,g){var v={active:undefined,posts:{},bsEnvironment:undefined,formatting:undefined};$(window).off("resize",b).on("resize",b);b();$(window).on("action:composer.topics.post",function(t,e){localStorage.removeItem("category:"+e.data.cid+":bookmark");localStorage.removeItem("category:"+e.data.cid+":bookmark:clicked")});$(window).on("popstate",function(){var t=utils.findBootstrapEnvironment();if(v.active&&(t==="xs"||t==="sm")){if(!v.posts[v.active].modified){v.discard(v.active);if(v.discardConfirm&&v.discardConfirm.length){v.discardConfirm.modal("hide");delete v.discardConfirm}return}e.translate("[[modules:composer.discard]]",function(t){v.discardConfirm=f.confirm(t,function(t){if(t){v.discard(v.active)}else{v.posts[v.active].modified=true}});v.posts[v.active].modified=false})}});function h(){var t=v.bsEnvironment;if(ajaxify.data.template.compose===true||t==="xs"||t==="sm"){history.back()}}function b(){var t=utils.findBootstrapEnvironment();var e=t==="xs"||t==="sm";if(s.toggle){if(s.env!==t&&e){s.env=t;s.toggle(false)}s.env=t}if(v.active!==undefined){d.reposition($('.composer[data-uuid="'+v.active+'"]'));if(!e&&window.location.pathname.startsWith(config.relative_path+"/compose")){history.back()}else if(e&&!window.location.pathname.startsWith(config.relative_path+"/compose")){E()}}v.bsEnvironment=t}function y(t){var e;var i;if(t.hasOwnProperty("cid")){e="cid"}else if(t.hasOwnProperty("tid")){e="tid"}else if(t.hasOwnProperty("pid")){e="pid"}i=t[e];for(var a in v.posts){if(v.posts[a].hasOwnProperty(e)&&i===v.posts[a][e]){return a}}return false}function w(i){var a=utils.generateUUID();var o=y(i);if(o){t.updateActive(o);return v.load(o)}var n="[[topic:composer.new_topic]]";if(i.action==="posts.reply"){n="[[topic:composer.replying_to]]"}else if(i.action==="posts.edit"){n="[[topic:composer.editing]]"}e.translate(n,function(e){t.push("composer",a,{title:e.replace("%1",'"'+i.title+'"')})});if(i.hasOwnProperty("cid")){i.save_id=["composer",app.user.uid,"cid",i.cid].join(":")}else if(i.hasOwnProperty("tid")){i.save_id=["composer",app.user.uid,"tid",i.tid].join(":")}else if(i.hasOwnProperty("pid")){i.save_id=["composer",app.user.uid,"pid",i.pid].join(":")}v.posts[a]=i;v.load(a)}async function x(t,e){$('.composer[data-uuid="'+t+'"]').find(".composer-submit").removeAttr("disabled");const{showAlert:i}=await g.fire("filter:composer.error",{post_uuid:t,message:e,showAlert:true});if(i){app.alert({type:"danger",timeout:3e3,title:"",message:e,alert_id:"post_error"})}}v.findByTid=function(t){for(var e in v.posts){if(v.posts.hasOwnProperty(e)&&v.posts[e].hasOwnProperty("tid")&&parseInt(v.posts[e].tid,10)===parseInt(t,10)){return e}}return null};v.addButton=function(t,e,i){a.addButton(t,e,i)};v.newTopic=function(t){var e={action:"topics.post",cid:t.cid,title:t.title||"",body:t.body||"",tags:t.tags||[],modified:!!(t.title&&t.title.length||t.body&&t.body.length),isMain:true};$(window).trigger("filter:composer.topic.push",{data:t,pushData:e});w(e)};v.addQuote=function(t,i,a,o,n,r,d){d=d||v.active;var c=(o||"").replace(/([\\`*_{}\[\]()#+\-.!])/g,"\\$1").replace(/\[/g,"&#91;").replace(/\]/g,"&#93;").replace(/%/g,"&#37;").replace(/,/g,"&#44;");if(r){r="> "+r.replace(/\n/g,"\n> ")+"\n\n"}var p="["+c+"]("+config.relative_path+"/post/"+(a||i)+")";if(d===undefined){if(o&&(a||i)){v.newReply(t,i,o,"[[modules:composer.user_said_in, "+n+", "+p+"]]\n"+r)}else{v.newReply(t,i,o,"[[modules:composer.user_said, "+n+"]]\n"+r)}return}else if(d!==v.active){v.load(d)}var l=$('.composer[data-uuid="'+d+'"]');var m=l.find("textarea");var u=m.val();if(o&&(a||i)){e.translate("[[modules:composer.user_said_in, "+n+", "+p+"]]\n",config.defaultLang,f)}else{e.translate("[[modules:composer.user_said, "+n+"]]\n",config.defaultLang,f)}function f(t){v.posts[d].body=(u.length?u+"\n\n":"")+t+r;m.val(v.posts[d].body);C(l);s.render(l)}};v.newReply=function(t,i,a,o){e.translate(o,config.defaultLang,function(e){w({action:"posts.reply",tid:t,toPid:i,title:a,body:e,modified:!!(a&&a.length||e&&e.length),isMain:false})})};v.editPost=function(t){socket.emit("plugins.composer.push",t,function(e,i){if(e){return app.alertError(e.message)}i.action="posts.edit";i.pid=t;i.modified=false;w(i)})};v.load=function(t){var e=$('.composer[data-uuid="'+t+'"]');if(e.length){L(t);d.reposition(e);C(e);j()}else if(v.formatting){_(t)}else{socket.emit("plugins.composer.getFormattingOptions",function(e,i){if(e){return app.alertError(e)}v.formatting=i;_(t)})}};v.enhance=function(t,d,l){if(!d&&!l){d=utils.generateUUID();v.posts[d]=ajaxify.data;l=ajaxify.data;t.attr("data-uuid",d)}var m=t.find("input.title");var u=t.find("input.handle");var b=t.find("input.tags");var y=t.find("textarea");var w=t.find(".composer-submit");r.init(t,v.posts[d]);p.init(t,v.posts);a.addHandler(t);a.addComposerButtons();s.handleToggler(t);i.initialize(d);n.init(t,v.posts[d]);c.init(t,d);t.on("change","input, textarea",function(){v.posts[d].modified=true;o.updateVisibility("available",v.posts[d].save_id,true);o.updateVisibility("open",v.posts[d].save_id,true)});w.on("click",function(t){t.preventDefault();t.stopPropagation();$(this).attr("disabled",true);k(d)});require(["mousetrap"],function(e){e(t.get(0)).bind("mod+enter",function(){w.attr("disabled",true);k(d)})});t.find(".composer-discard").on("click",function(t){t.preventDefault();if(!v.posts[d].modified){v.discard(d);return h()}if(screenfull.isEnabled&&screenfull.isFullscreen){screenfull.exit()}var i=$(this).prop("disabled",true);e.translate("[[modules:composer.discard]]",function(t){f.confirm(t,function(t){if(t){v.discard(d);h()}i.prop("disabled",false)})})});t.find(".composer-minimize, .minimize .trigger").on("click",function(t){t.preventDefault();t.stopPropagation();v.minimize(d)});y.on("input propertychange",function(){s.render(t)});y.on("scroll",function(){s.matchScroll(t)});s.render(t,function(){s.matchScroll(t)});o.init(t,l);var x=o.get(l.save_id);if(x&&x.title){m.val(x.title)}if(x&&x.handle){u.val(x.handle)}if(x&&x.tags){const t=x.tags.split(",");t.forEach(function(t){b.tagsinput("add",t)})}y.val(x.text?x.text:l.body);P(t);T(t);C(t);if(l.action==="posts.edit"){v.updateThumbCount(d,t)}if(!screenfull.isEnabled){$('[data-format="zen"]').addClass("hidden")}g.fire("action:composer.enhanced",{postContainer:t,postData:l,draft:x})};async function _(i){var a=v.posts[i];var o=a?a.hasOwnProperty("cid"):false;var n=a?!!a.isMain:false;var r=a?!!a.pid:false;var s=a?parseInt(a.uid,10)===0:false;const c=a.timestamp>Date.now();var p=a.title.replace(/%/g,"&#37;").replace(/,/g,"&#44;");var m={title:p,titleLength:p.length,mobile:v.bsEnvironment==="xs"||v.bsEnvironment==="sm",resizable:true,thumb:a.thumb,isTopicOrMain:o||n,maximumTitleLength:config.maximumTitleLength,maximumPostLength:config.maximumPostLength,minimumTagLength:config.minimumTagLength,maximumTagLength:config.maximumTagLength,isTopic:o,isEditing:r,canSchedule:!!(ajaxify.data.privileges&&(ajaxify.data.privileges["topics:schedule"]||n&&c&&ajaxify.data.privileges.view_scheduled)),showHandleInput:config.allowGuestHandles&&(app.user.uid===0||r&&s&&app.user.isAdmin),handle:a?a.handle||"":undefined,formatting:v.formatting,tagWhitelist:ajaxify.data.tagWhitelist,privileges:app.user.privileges,selectedCategory:ajaxify.data.template.category?{icon:ajaxify.data.icon,color:ajaxify.data.color,bgColor:ajaxify.data.bgColor,backgroundImage:ajaxify.data.backgroundImage,imageClass:ajaxify.data.imageClass,name:ajaxify.data.name}:null};if(m.mobile){E();app.toggleNavbar(false)}a.mobile=v.bsEnvironment==="xs"||v.bsEnvironment==="sm";({postData:a,createData:m}=await g.fire("filter:composer.create",{postData:a,createData:m}));app.parseAndTranslate("composer",m,function(o){if($('.composer.composer[data-uuid="'+i+'"]').length){return}o=$(o);o.find(".title").each(function(){$(this).text(e.unescape($(this).text()))});o.attr("data-uuid",i);$(document.body).append(o);var n=$(o[0]);d.reposition(n);v.enhance(n,i,a);L(i);n.on("click",function(){if(!t.isActive(i)){t.updateActive(i)}});d.handleResize(n);if(v.bsEnvironment==="xs"||v.bsEnvironment==="sm"){var r=n.find(".composer-submit");var s=n.find(".mobile-navbar .composer-submit");var c=n.find(".write");var p=c.attr("tabindex");r.removeAttr("tabindex");s.attr("tabindex",parseInt(p,10)+1);$(".category-name-container").on("click",function(){$(".category-selector").toggleClass("open")})}$(window).trigger("action:composer.loaded",{post_uuid:i,composerData:v.posts[i],formatting:v.formatting});l.apply(n.find(".write"));C(n);j()})}function E(){var t="compose?p="+window.location.pathname;var e=window.location.pathname.slice(1)+window.location.search;if(e.startsWith(config.relative_path.slice(1))){e=e.slice(config.relative_path.length)}window.history.replaceState({url:null,returnPath:e},e,config.relative_path+"/"+e);window.history.pushState({url:t},t,`${config.relative_path}/${e}`)}function P(t){var e=t.find(".help");socket.emit("plugins.composer.renderHelp",function(t,i){if(!t&&i&&i.length>0){e.removeClass("hidden");e.on("click",function(){f.alert(i)})}})}function T(t){var e=t.attr("data-uuid");var i=v.posts[e]&&v.posts[e].action==="posts.edit";var a=utils.findBootstrapEnvironment();var o=a==="xs"||a==="sm";if(i||o){return}app.enableTopicSearch({searchElements:{inputEl:t.find("input.title"),resultEl:t.find(".quick-search-container")},hideOnNoMatches:true})}function L(t){if(v.active&&v.active!==t){v.minimize(v.active)}v.active=t;$(window).trigger("action:composer.activate",{post_uuid:t})}function C(t){setTimeout(function(){var e=t.find("input.title");if(e.length){e.focus()}else{t.find("textarea").focus().putCursorAtEnd()}},20)}function k(t){var e=v.posts[t];var a=$('.composer[data-uuid="'+t+'"]');var s=a.find(".handle");var d=a.find(".title");var c=a.find("textarea");var l=a.find("input#topic-thumb-url");var m=e.hasOwnProperty("template")&&e.template.compose===true;const b=a.find(".composer-submit");d.val(d.val().trim());c.val(utils.rtrim(c.val()));if(l.length){l.val(l.val().trim())}var y=e.action;var w=(e.hasOwnProperty("cid")||parseInt(e.pid,10))&&a.find("input.title").length;var _=!w||w&&parseInt(e.cid,10);var E={post_uuid:t,postData:e,postContainer:a,titleEl:d,titleLen:d.val().length,bodyEl:c,bodyLen:c.val().length};g.fire("action:composer.check",E);if(E.error){return x(t,E.error)}if(i.inProgress[t]&&i.inProgress[t].length){return x(t,"[[error:still-uploading]]")}else if(w&&E.titleLen<parseInt(config.minimumTitleLength,10)){return x(t,"[[error:title-too-short, "+config.minimumTitleLength+"]]")}else if(w&&E.titleLen>parseInt(config.maximumTitleLength,10)){return x(t,"[[error:title-too-long, "+config.maximumTitleLength+"]]")}else if(y==="topics.post"&&!_){return x(t,"[[error:category-not-selected]]")}else if(E.bodyLen<parseInt(config.minimumPostLength,10)){return x(t,"[[error:content-too-short, "+config.minimumPostLength+"]]")}else if(E.bodyLen>parseInt(config.maximumPostLength,10)){return x(t,"[[error:content-too-long, "+config.maximumPostLength+"]]")}else if(w&&!n.isEnoughTags(t)){return x(t,"[[error:not-enough-tags, "+n.minTagCount()+"]]")}else if(p.isActive()&&p.getTimestamp()<=Date.now()){return x(t,"[[error:scheduling-to-past]]")}let P={uuid:t};let T="post";let L="";if(y==="topics.post"){L="/topics";P={...P,handle:s?s.val():undefined,title:d.val(),content:c.val(),thumb:l.val()||"",cid:r.getSelectedCid(),tags:n.getTags(t),timestamp:p.getTimestamp()}}else if(y==="posts.reply"){L=`/topics/${e.tid}`;P={...P,tid:e.tid,handle:s?s.val():undefined,content:c.val(),toPid:e.toPid}}else if(y==="posts.edit"){T="put";L=`/posts/${e.pid}`;P={...P,pid:e.pid,handle:s?s.val():undefined,content:c.val(),title:d.val(),thumb:l.val()||"",tags:n.getTags(t),timestamp:p.getTimestamp()}}var C={composerEl:a,action:y,composerData:P,postData:e,redirect:true};g.fire("action:composer.submit",C);var k=$('#taskbar .composer[data-uuid="'+t+'"] i');var j=a.find(".write");k.removeClass("fa-plus").addClass("fa-circle-o-notch fa-spin");v.minimize(t);j.prop("readonly",true);u[T](L,P).then(i=>{b.removeAttr("disabled");e.submitted=true;v.discard(t);o.removeDraft(e.save_id);if(i.queued){f.alert(i.message)}else if(y==="topics.post"){if(C.redirect){ajaxify.go("topic/"+i.slug,undefined,m||v.bsEnvironment==="xs"||v.bsEnvironment==="sm")}}else if(y==="posts.reply"){if(m||v.bsEnvironment==="xs"||v.bsEnvironment==="sm"){window.history.back()}else if(C.redirect&&(ajaxify.data.template.name!=="topic"||ajaxify.data.template.topic&&parseInt(e.tid,10)!==parseInt(ajaxify.data.tid,10))){ajaxify.go("post/"+i.pid)}}else{h()}$(window).trigger("action:composer."+y,{composerData:P,data:i})}).catch(e=>{v.load(t);j.prop("readonly",false);if(e.message==="[[error:email-not-confirmed]]"){return app.showEmailConfirmWarning(e)}x(t,e.message)})}function j(){$("html").addClass("composing")}function D(){$("body").css({paddingBottom:0});$("html").removeClass("composing");app.toggleNavbar(true)}v.discard=function(e){if(v.posts[e]){var i=v.posts[e];var a=$('.composer[data-uuid="'+e+'"]');a.remove();o.removeDraft(i.save_id);m.deleteAll(e);t.discard("composer",e);$('[data-action="post"]').removeAttr("disabled");g.fire("action:composer.discard",{post_uuid:e,postData:i});delete v.posts[e];v.active=undefined}p.reset();D()};v.close=v.discard;v.minimize=function(e){var i=$('.composer[data-uuid="'+e+'"]');i.css("visibility","hidden");v.active=undefined;t.minimize("composer",e);$(window).trigger("action:composer.minimize",{post_uuid:e});D()};v.updateThumbCount=function(t,e){const i=v.posts[t];if(i.action==="topics.post"||i.action==="posts.edit"&&i.isMain){const a=[m.get(t)];if(i.pid){a.push(m.getByPid(i.pid))}Promise.all(a).then(t=>{t=t.reduce((t,e)=>{t=t.concat(e);return t});if(t.length){const i=e.find('[data-format="thumbs"]');i.attr("data-count",t.length)}})}};return v});
//# sourceMappingURL=composer.js.map