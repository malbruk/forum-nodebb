{"version":3,"sources":["public/src/modules/hooks.js"],"names":["define","Hooks","loaded","temporary","Set","deprecated","action:script.load","register","hookName","method","add","hasOwnProperty","console","groupCollapsed","info","groupEnd","debug","on","registerPage","onPage","forEach","pair","unregister","delete","has","off","hasListeners","size","_onHookError","e","listener","data","warn","name","error","Promise","resolve","_fireFilterHook","listeners","Array","from","reduce","promise","then","result","utils","isPromise","catch","_fireActionHook","$","window","trigger","_fireStaticHook","allSettled","map","fire","type","split","shift"],"mappings":"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","file":"public/src/modules/hooks.js","sourcesContent":["'use strict';\r\n\r\ndefine('hooks', [], () => {\r\n\tconst Hooks = {\r\n\t\tloaded: {},\r\n\t\ttemporary: new Set(),\r\n\t\tdeprecated: {\r\n\t\t\t'action:script.load': 'filter:script.load',\t// ðŸ‘‹ @ 1.18.0\r\n\t\t},\r\n\t};\r\n\r\n\tHooks.register = (hookName, method) => {\r\n\t\tHooks.loaded[hookName] = Hooks.loaded[hookName] || new Set();\r\n\t\tHooks.loaded[hookName].add(method);\r\n\r\n\t\tif (Hooks.deprecated.hasOwnProperty(hookName)) {\r\n\t\t\tconst deprecated = Hooks.deprecated[hookName];\r\n\r\n\t\t\tif (deprecated) {\r\n\t\t\t\tconsole.groupCollapsed(`[hooks] Hook \"${hookName}\" is deprecated, please use \"${deprecated}\" instead.`);\r\n\t\t\t} else {\r\n\t\t\t\tconsole.groupCollapsed(`[hooks] Hook \"${hookName}\" is deprecated, there is no alternative.`);\r\n\t\t\t}\r\n\r\n\t\t\tconsole.info(method);\r\n\t\t\tconsole.groupEnd();\r\n\t\t}\r\n\r\n\t\tconsole.debug(`[hooks] Registered ${hookName}`, method);\r\n\t};\r\n\tHooks.on = Hooks.register;\r\n\r\n\t// registerPage/onPage takes care of unregistering the listener on ajaxify\r\n\tHooks.registerPage = (hookName, method) => {\r\n\t\tHooks.temporary.add({ hookName, method });\r\n\t\tHooks.register(hookName, method);\r\n\t};\r\n\tHooks.onPage = Hooks.registerPage;\r\n\tHooks.register('action:ajaxify.start', () => {\r\n\t\tHooks.temporary.forEach((pair) => {\r\n\t\t\tHooks.unregister(pair.hookName, pair.method);\r\n\t\t\tHooks.temporary.delete(pair);\r\n\t\t});\r\n\t});\r\n\r\n\tHooks.unregister = (hookName, method) => {\r\n\t\tif (Hooks.loaded[hookName] && Hooks.loaded[hookName].has(method)) {\r\n\t\t\tHooks.loaded[hookName].delete(method);\r\n\t\t\tconsole.debug(`[hooks] Unregistered ${hookName}`, method);\r\n\t\t} else {\r\n\t\t\tconsole.debug(`[hooks] Unregistration of ${hookName} failed, passed-in method is not a registered listener or the hook itself has no listeners, currently.`);\r\n\t\t}\r\n\t};\r\n\tHooks.off = Hooks.unregister;\r\n\r\n\tHooks.hasListeners = hookName => Hooks.loaded[hookName] && Hooks.loaded[hookName].size > 0;\r\n\r\n\tconst _onHookError = (e, listener, data) => {\r\n\t\tconsole.warn(`[hooks] Exception encountered in ${listener.name ? listener.name : 'anonymous function'}, stack trace follows.`);\r\n\t\tconsole.error(e);\r\n\t\treturn Promise.resolve(data);\r\n\t};\r\n\r\n\tconst _fireFilterHook = (hookName, data) => {\r\n\t\tif (!Hooks.hasListeners(hookName)) {\r\n\t\t\treturn Promise.resolve(data);\r\n\t\t}\r\n\r\n\t\tconst listeners = Array.from(Hooks.loaded[hookName]);\r\n\t\treturn listeners.reduce((promise, listener) => promise.then((data) => {\r\n\t\t\ttry {\r\n\t\t\t\tconst result = listener(data);\r\n\t\t\t\treturn utils.isPromise(result) ?\r\n\t\t\t\t\tresult.then(data => Promise.resolve(data)).catch(e => _onHookError(e, listener, data)) :\r\n\t\t\t\t\tresult;\r\n\t\t\t} catch (e) {\r\n\t\t\t\treturn _onHookError(e, listener, data);\r\n\t\t\t}\r\n\t\t}), Promise.resolve(data));\r\n\t};\r\n\r\n\tconst _fireActionHook = (hookName, data) => {\r\n\t\tif (Hooks.hasListeners(hookName)) {\r\n\t\t\tHooks.loaded[hookName].forEach(listener => listener(data));\r\n\t\t}\r\n\r\n\t\t// Backwards compatibility (remove this when we eventually remove jQuery from NodeBB core)\r\n\t\t$(window).trigger(hookName, data);\r\n\t};\r\n\r\n\tconst _fireStaticHook = (hookName, data) => {\r\n\t\tif (!Hooks.hasListeners(hookName)) {\r\n\t\t\treturn Promise.resolve(data);\r\n\t\t}\r\n\r\n\t\tconst listeners = Array.from(Hooks.loaded[hookName]);\r\n\t\treturn Promise.allSettled(listeners.map((listener) => {\r\n\t\t\ttry {\r\n\t\t\t\treturn listener(data);\r\n\t\t\t} catch (e) {\r\n\t\t\t\treturn _onHookError(e, listener);\r\n\t\t\t}\r\n\t\t})).then(() => Promise.resolve(data));\r\n\t};\r\n\r\n\tHooks.fire = (hookName, data) => {\r\n\t\tconst type = hookName.split(':').shift();\r\n\r\n\t\tswitch (type) {\r\n\t\t\tcase 'filter':\r\n\t\t\t\treturn _fireFilterHook(hookName, data);\r\n\r\n\t\t\tcase 'action':\r\n\t\t\t\treturn _fireActionHook(hookName, data);\r\n\r\n\t\t\tcase 'static':\r\n\t\t\t\treturn _fireStaticHook(hookName, data);\r\n\t\t}\r\n\t};\r\n\r\n\treturn Hooks;\r\n});\r\n"]}