{"version":3,"sources":["public/src/modules/translator.js"],"names":["factory","loadClient","language","namespace","Promise","resolve","reject","jQuery","getJSON","config","assetBaseUrl","join","data","payload","$","window","trigger","promise","fail","jqxhr","textStatus","error","Error","warn","console","apply","arguments","define","amd","utils","module","exports","languages","require","global","env","winston","a","get","load","assign","Object","extend","escapeHTML","str","decodeHTMLEntities","String","replace","Translator","self","this","TypeError","modules","keys","moduleFactories","map","reduce","prev","elem","lang","translations","prototype","translate","validText","validTextRegex","RegExp","invalidTextRegex","cursor","lastBreak","len","length","toTranslate","inToken","split","text","arr","i","brk","level","push","slice","trim","indexOf","char0","char1","textBeforeColonFound","colonFound","textAfterColonFound","commaAfterNameFound","test","currentSlice","result","name","args","backup","translateKey","last","all","then","translated","key","translation","getTranslation","argsToTranslate","arg","translatedArgs","out","forEach","escaped","catch","x","keyParts","undefined","descendantTextNodes","node","textNodes","helper","nodeType","c","childNodes","l","translateInPlace","element","attributes","nodes","nodeValue","attrNodes","attr","tuples","Array","call","querySelectorAll","el","concat","attrText","getAttribute","ref","translatedAttrs","html","replaceWith","setAttribute","getLanguage","params","userLang","defaultLang","meta","create","cache","registerModule","translator","removePatterns","sub","escape","unescape","compile","adaptor","flush","code","flushNamespace","callback","cb","setTimeout","output","err","stack","addTranslation","getTranslations","toggleTimeagoShorthand","toggle","tmp","timeago","settings","strings","timeagoShort","languageCode","userLangToTimeagoCode","timeagoCodes","includes","originalSettings","switchTimeagoLanguage","langCode","stringsModule","undef","prepareDOM","value","css"],"mappings":"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","file":"public/src/modules/translator.js","sourcesContent":["'use strict';\r\n\r\n(function (factory) {\r\n\tfunction loadClient(language, namespace) {\r\n\t\treturn new Promise(function (resolve, reject) {\r\n\t\t\tjQuery.getJSON([config.assetBaseUrl, 'language', language, namespace].join('/') + '.json?' + config['cache-buster'], function (data) {\r\n\t\t\t\tconst payload = {\r\n\t\t\t\t\tlanguage: language,\r\n\t\t\t\t\tnamespace: namespace,\r\n\t\t\t\t\tdata: data,\r\n\t\t\t\t};\r\n\t\t\t\t$(window).trigger('action:translator.loadClient', payload);\r\n\t\t\t\tresolve(payload.promise ? Promise.resolve(payload.promise) : data);\r\n\t\t\t}).fail(function (jqxhr, textStatus, error) {\r\n\t\t\t\treject(new Error(textStatus + ', ' + error));\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\tvar warn = function () { console.warn.apply(console, arguments); };\r\n\tif (typeof define === 'function' && define.amd) {\r\n\t\t// AMD. Register as a named module\r\n\t\tdefine('translator', [], function () {\r\n\t\t\treturn factory(utils, loadClient, warn);\r\n\t\t});\r\n\t} else if (typeof module === 'object' && module.exports) {\r\n\t\t// Node\r\n\t\t(function () {\r\n\t\t\tvar languages = require('../../../src/languages');\r\n\r\n\t\t\tif (global.env === 'development') {\r\n\t\t\t\tvar winston = require('winston');\r\n\t\t\t\twarn = function (a) {\r\n\t\t\t\t\twinston.warn(a);\r\n\t\t\t\t};\r\n\t\t\t}\r\n\r\n\t\t\tmodule.exports = factory(require('../utils'), languages.get, warn);\r\n\t\t}());\r\n\t}\r\n}(function (utils, load, warn) {\r\n\tvar assign = Object.assign || jQuery.extend;\r\n\r\n\tfunction escapeHTML(str) {\r\n\t\treturn utils.escapeHTML(utils.decodeHTMLEntities(\r\n\t\t\tString(str)\r\n\t\t\t\t.replace(/[\\s\\xa0]+/g, ' ')\r\n\t\t\t\t.replace(/^\\s+|\\s+$/g, '')\r\n\t\t));\r\n\t}\r\n\r\n\tvar Translator = (function () {\r\n\t\t/**\r\n\t\t * Construct a new Translator object\r\n\t\t * @param {string} language - Language code for this translator instance\r\n\t\t * @exports translator.Translator\r\n\t\t */\r\n\t\tfunction Translator(language) {\r\n\t\t\tvar self = this;\r\n\r\n\t\t\tif (!language) {\r\n\t\t\t\tthrow new TypeError('Parameter `language` must be a language string. Received ' + language + (language === '' ? '(empty string)' : ''));\r\n\t\t\t}\r\n\r\n\t\t\tself.modules = Object.keys(Translator.moduleFactories).map(function (namespace) {\r\n\t\t\t\tvar factory = Translator.moduleFactories[namespace];\r\n\t\t\t\treturn [namespace, factory(language)];\r\n\t\t\t}).reduce(function (prev, elem) {\r\n\t\t\t\tvar namespace = elem[0];\r\n\t\t\t\tvar module = elem[1];\r\n\t\t\t\tprev[namespace] = module;\r\n\r\n\t\t\t\treturn prev;\r\n\t\t\t}, {});\r\n\r\n\t\t\tself.lang = language;\r\n\t\t\tself.translations = {};\r\n\t\t}\r\n\r\n\t\tTranslator.prototype.load = load;\r\n\r\n\t\t/**\r\n\t\t * Parse the translation instructions into the language of the Translator instance\r\n\t\t * @param {string} str - Source string\r\n\t\t * @returns {Promise<string>}\r\n\t\t */\r\n\t\tTranslator.prototype.translate = function translate(str) {\r\n\t\t\t// regex for valid text in namespace / key\r\n\t\t\tvar validText = 'a-zA-Z0-9\\\\-_.\\\\/';\r\n\t\t\tvar validTextRegex = new RegExp('[' + validText + ']');\r\n\t\t\tvar invalidTextRegex = new RegExp('[^' + validText + '\\\\]]');\r\n\r\n\t\t\t// current cursor position\r\n\t\t\tvar cursor = 0;\r\n\t\t\t// last break of the input string\r\n\t\t\tvar lastBreak = 0;\r\n\t\t\t// length of the input string\r\n\t\t\tvar len = str.length;\r\n\t\t\t// array to hold the promises for the translations\r\n\t\t\t// and the strings of untranslated text in between\r\n\t\t\tvar toTranslate = [];\r\n\r\n\t\t\t// to store the state of if we're currently in a top-level token for later\r\n\t\t\tvar inToken = false;\r\n\r\n\t\t\t// split a translator string into an array of tokens\r\n\t\t\t// but don't split by commas inside other translator strings\r\n\t\t\tfunction split(text) {\r\n\t\t\t\tvar len = text.length;\r\n\t\t\t\tvar arr = [];\r\n\t\t\t\tvar i = 0;\r\n\t\t\t\tvar brk = 0;\r\n\t\t\t\tvar level = 0;\r\n\r\n\t\t\t\twhile (i + 2 <= len) {\r\n\t\t\t\t\tif (text[i] === '[' && text[i + 1] === '[') {\r\n\t\t\t\t\t\tlevel += 1;\r\n\t\t\t\t\t\ti += 1;\r\n\t\t\t\t\t} else if (text[i] === ']' && text[i + 1] === ']') {\r\n\t\t\t\t\t\tlevel -= 1;\r\n\t\t\t\t\t\ti += 1;\r\n\t\t\t\t\t} else if (level === 0 && text[i] === ',' && text[i - 1] !== '\\\\') {\r\n\t\t\t\t\t\tarr.push(text.slice(brk, i).trim());\r\n\t\t\t\t\t\ti += 1;\r\n\t\t\t\t\t\tbrk = i;\r\n\t\t\t\t\t}\r\n\t\t\t\t\ti += 1;\r\n\t\t\t\t}\r\n\t\t\t\tarr.push(text.slice(brk, i + 1).trim());\r\n\t\t\t\treturn arr;\r\n\t\t\t}\r\n\r\n\t\t\t// move to the first [[\r\n\t\t\tcursor = str.indexOf('[[', cursor);\r\n\r\n\t\t\t// the loooop, we'll go to where the cursor\r\n\t\t\t// is equal to the length of the string since\r\n\t\t\t// slice doesn't include the ending index\r\n\t\t\twhile (cursor + 2 <= len && cursor !== -1) {\r\n\t\t\t\t// split the string from the last break\r\n\t\t\t\t// to the character before the cursor\r\n\t\t\t\t// add that to the result array\r\n\t\t\t\ttoTranslate.push(str.slice(lastBreak, cursor));\r\n\t\t\t\t// set the cursor position past the beginning\r\n\t\t\t\t// brackets of the translation string\r\n\t\t\t\tcursor += 2;\r\n\t\t\t\t// set the last break to our current\r\n\t\t\t\t// spot since we just broke the string\r\n\t\t\t\tlastBreak = cursor;\r\n\t\t\t\t// we're in a token now\r\n\t\t\t\tinToken = true;\r\n\r\n\t\t\t\t// the current level of nesting of the translation strings\r\n\t\t\t\tvar level = 0;\r\n\t\t\t\tvar char0;\r\n\t\t\t\tvar char1;\r\n\t\t\t\t// validating the current string is actually a translation\r\n\t\t\t\tvar textBeforeColonFound = false;\r\n\t\t\t\tvar colonFound = false;\r\n\t\t\t\tvar textAfterColonFound = false;\r\n\t\t\t\tvar commaAfterNameFound = false;\r\n\r\n\t\t\t\twhile (cursor + 2 <= len) {\r\n\t\t\t\t\tchar0 = str[cursor];\r\n\t\t\t\t\tchar1 = str[cursor + 1];\r\n\t\t\t\t\t// found some text after the double bracket,\r\n\t\t\t\t\t// so this is probably a translation string\r\n\t\t\t\t\tif (!textBeforeColonFound && validTextRegex.test(char0)) {\r\n\t\t\t\t\t\ttextBeforeColonFound = true;\r\n\t\t\t\t\t\tcursor += 1;\r\n\t\t\t\t\t// found a colon, so this is probably a translation string\r\n\t\t\t\t\t} else if (textBeforeColonFound && !colonFound && char0 === ':') {\r\n\t\t\t\t\t\tcolonFound = true;\r\n\t\t\t\t\t\tcursor += 1;\r\n\t\t\t\t\t// found some text after the colon,\r\n\t\t\t\t\t// so this is probably a translation string\r\n\t\t\t\t\t} else if (colonFound && !textAfterColonFound && validTextRegex.test(char0)) {\r\n\t\t\t\t\t\ttextAfterColonFound = true;\r\n\t\t\t\t\t\tcursor += 1;\r\n\t\t\t\t\t} else if (textAfterColonFound && !commaAfterNameFound && char0 === ',') {\r\n\t\t\t\t\t\tcommaAfterNameFound = true;\r\n\t\t\t\t\t\tcursor += 1;\r\n\t\t\t\t\t// a space or comma was found before the name\r\n\t\t\t\t\t// this isn't a translation string, so back out\r\n\t\t\t\t\t} else if (!(textBeforeColonFound && colonFound && textAfterColonFound && commaAfterNameFound) &&\r\n\t\t\t\t\t\t\tinvalidTextRegex.test(char0)) {\r\n\t\t\t\t\t\tcursor += 1;\r\n\t\t\t\t\t\tlastBreak -= 2;\r\n\t\t\t\t\t\t// no longer in a token\r\n\t\t\t\t\t\tinToken = false;\r\n\t\t\t\t\t\tif (level > 0) {\r\n\t\t\t\t\t\t\tlevel -= 1;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t// if we're at the beginning of another translation string,\r\n\t\t\t\t\t// we're nested, so add to our level\r\n\t\t\t\t\t} else if (char0 === '[' && char1 === '[') {\r\n\t\t\t\t\t\tlevel += 1;\r\n\t\t\t\t\t\tcursor += 2;\r\n\t\t\t\t\t// if we're at the end of a translation string\r\n\t\t\t\t\t} else if (char0 === ']' && char1 === ']') {\r\n\t\t\t\t\t\t// if we're at the base level, then this is the end\r\n\t\t\t\t\t\tif (level === 0) {\r\n\t\t\t\t\t\t\t// so grab the name and args\r\n\t\t\t\t\t\t\tvar currentSlice = str.slice(lastBreak, cursor);\r\n\t\t\t\t\t\t\tvar result = split(currentSlice);\r\n\t\t\t\t\t\t\tvar name = result[0];\r\n\t\t\t\t\t\t\tvar args = result.slice(1);\r\n\r\n\t\t\t\t\t\t\t// make a backup based on the raw string of the token\r\n\t\t\t\t\t\t\t// if there are arguments to the token\r\n\t\t\t\t\t\t\tvar backup = '';\r\n\t\t\t\t\t\t\tif (args && args.length) {\r\n\t\t\t\t\t\t\t\tbackup = this.translate(currentSlice);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t// add the translation promise to the array\r\n\t\t\t\t\t\t\ttoTranslate.push(this.translateKey(name, args, backup));\r\n\t\t\t\t\t\t\t// skip past the ending brackets\r\n\t\t\t\t\t\t\tcursor += 2;\r\n\t\t\t\t\t\t\t// set this as our last break\r\n\t\t\t\t\t\t\tlastBreak = cursor;\r\n\t\t\t\t\t\t\t// and we're no longer in a translation string,\r\n\t\t\t\t\t\t\t// so continue with the main loop\r\n\t\t\t\t\t\t\tinToken = false;\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// otherwise we lower the level\r\n\t\t\t\t\t\tlevel -= 1;\r\n\t\t\t\t\t\t// and skip past the ending brackets\r\n\t\t\t\t\t\tcursor += 2;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// otherwise just move to the next character\r\n\t\t\t\t\t\tcursor += 1;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// skip to the next [[\r\n\t\t\t\tcursor = str.indexOf('[[', cursor);\r\n\t\t\t}\r\n\r\n\t\t\t// ending string of source\r\n\t\t\tvar last = str.slice(lastBreak);\r\n\r\n\t\t\t// if we were mid-token, treat it as invalid\r\n\t\t\tif (inToken) {\r\n\t\t\t\tlast = this.translate(last);\r\n\t\t\t}\r\n\r\n\t\t\t// add the remaining text after the last translation string\r\n\t\t\ttoTranslate.push(last);\r\n\r\n\t\t\t// and return a promise for the concatenated translated string\r\n\t\t\treturn Promise.all(toTranslate).then(function (translated) {\r\n\t\t\t\treturn translated.join('');\r\n\t\t\t});\r\n\t\t};\r\n\r\n\t\t/**\r\n\t\t * Translates a specific key and array of arguments\r\n\t\t * @param {string} name - Translation key (ex. 'global:home')\r\n\t\t * @param {string[]} args - Arguments for `%1`, `%2`, etc\r\n\t\t * @param {string|Promise<string>} backup - Text to use in case the key can't be found\r\n\t\t * @returns {Promise<string>}\r\n\t\t */\r\n\t\tTranslator.prototype.translateKey = function translateKey(name, args, backup) {\r\n\t\t\tvar self = this;\r\n\r\n\t\t\tvar result = name.split(':', 2);\r\n\t\t\tvar namespace = result[0];\r\n\t\t\tvar key = result[1];\r\n\r\n\t\t\tif (self.modules[namespace]) {\r\n\t\t\t\treturn Promise.resolve(self.modules[namespace](key, args));\r\n\t\t\t}\r\n\r\n\t\t\tif (namespace && result.length === 1) {\r\n\t\t\t\treturn Promise.resolve('[[' + namespace + ']]');\r\n\t\t\t}\r\n\r\n\t\t\tif (namespace && !key) {\r\n\t\t\t\twarn('Missing key in translation token \"' + name + '\" for language \"' + self.lang + '\"');\r\n\t\t\t\treturn Promise.resolve('[[' + namespace + ']]');\r\n\t\t\t}\r\n\r\n\t\t\tvar translation = this.getTranslation(namespace, key);\r\n\t\t\treturn translation.then(function (translated) {\r\n\t\t\t\t// check if the translation is missing first\r\n\t\t\t\tif (!translated) {\r\n\t\t\t\t\twarn('Missing translation \"' + name + '\" for language \"' + self.lang + '\"');\r\n\t\t\t\t\treturn backup || key;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar argsToTranslate = args.map(function (arg) {\r\n\t\t\t\t\treturn self.translate(escapeHTML(arg));\r\n\t\t\t\t});\r\n\r\n\t\t\t\treturn Promise.all(argsToTranslate).then(function (translatedArgs) {\r\n\t\t\t\t\tvar out = translated;\r\n\t\t\t\t\ttranslatedArgs.forEach(function (arg, i) {\r\n\t\t\t\t\t\tvar escaped = arg.replace(/%(?=\\d)/g, '&#37;').replace(/\\\\,/g, '&#44;');\r\n\t\t\t\t\t\t// fix double escaped translation keys, see https://github.com/NodeBB/NodeBB/issues/9206\r\n\t\t\t\t\t\tescaped = escaped.replace(/&amp;lsqb;/g, '&lsqb;')\r\n\t\t\t\t\t\t\t.replace(/&amp;rsqb;/g, '&rsqb;');\r\n\t\t\t\t\t\tout = out.replace(new RegExp('%' + (i + 1), 'g'), escaped);\r\n\t\t\t\t\t});\r\n\t\t\t\t\treturn out;\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t};\r\n\r\n\t\t/**\r\n\t\t * Load translation file (or use a cached version), and optionally return the translation of a certain key\r\n\t\t * @param {string} namespace - The file name of the translation namespace\r\n\t\t * @param {string} [key] - The key of the specific translation to getJSON\r\n\t\t * @returns {Promise<{ [key: string]: string } | string>}\r\n\t\t */\r\n\t\tTranslator.prototype.getTranslation = function getTranslation(namespace, key) {\r\n\t\t\tvar translation;\r\n\t\t\tif (!namespace) {\r\n\t\t\t\twarn('[translator] Parameter `namespace` is ' + namespace + (namespace === '' ? '(empty string)' : ''));\r\n\t\t\t\ttranslation = Promise.resolve({});\r\n\t\t\t} else {\r\n\t\t\t\tthis.translations[namespace] = this.translations[namespace] ||\r\n\t\t\t\t\tthis.load(this.lang, namespace).catch(function () { return {}; });\r\n\t\t\t\ttranslation = this.translations[namespace];\r\n\t\t\t}\r\n\r\n\t\t\tif (key) {\r\n\t\t\t\treturn translation.then(function (x) {\r\n\t\t\t\t\tif (typeof x[key] === 'string') return x[key];\r\n\t\t\t\t\tconst keyParts = key.split('.');\r\n\t\t\t\t\tfor (let i = 0; i <= keyParts.length; i++) {\r\n\t\t\t\t\t\tif (i === keyParts.length) {\r\n\t\t\t\t\t\t\t// default to trying to find key with the same name as parent or equal to empty string\r\n\t\t\t\t\t\t\treturn x[keyParts[i - 1]] !== undefined ? x[keyParts[i - 1]] : x[''];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tswitch (typeof x[keyParts[i]]) {\r\n\t\t\t\t\t\t\tcase 'object':\r\n\t\t\t\t\t\t\t\tx = x[keyParts[i]];\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase 'string':\r\n\t\t\t\t\t\t\t\tif (i === keyParts.length - 1) {\r\n\t\t\t\t\t\t\t\t\treturn x[keyParts[i]];\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\treturn false;\r\n\r\n\t\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\treturn translation;\r\n\t\t};\r\n\r\n\t\t/**\r\n\t\t * @param {Node} node\r\n\t\t * @returns {Node[]}\r\n\t\t */\r\n\t\tfunction descendantTextNodes(node) {\r\n\t\t\tvar textNodes = [];\r\n\r\n\t\t\tfunction helper(node) {\r\n\t\t\t\tif (node.nodeType === 3) {\r\n\t\t\t\t\ttextNodes.push(node);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tfor (var i = 0, c = node.childNodes, l = c.length; i < l; i += 1) {\r\n\t\t\t\t\t\thelper(c[i]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\thelper(node);\r\n\t\t\treturn textNodes;\r\n\t\t}\r\n\r\n\t\t/**\r\n\t\t * Recursively translate a DOM element in place\r\n\t\t * @param {Element} element - Root element to translate\r\n\t\t * @param {string[]} [attributes] - Array of node attributes to translate\r\n\t\t * @returns {Promise<void>}\r\n\t\t */\r\n\t\tTranslator.prototype.translateInPlace = function translateInPlace(element, attributes) {\r\n\t\t\tattributes = attributes || ['placeholder', 'title'];\r\n\r\n\t\t\tvar nodes = descendantTextNodes(element);\r\n\t\t\tvar text = nodes.map(function (node) {\r\n\t\t\t\treturn utils.escapeHTML(node.nodeValue);\r\n\t\t\t}).join('  ||  ');\r\n\r\n\t\t\tvar attrNodes = attributes.reduce(function (prev, attr) {\r\n\t\t\t\tvar tuples = Array.prototype.map.call(element.querySelectorAll('[' + attr + '*=\"[[\"]'), function (el) {\r\n\t\t\t\t\treturn [attr, el];\r\n\t\t\t\t});\r\n\t\t\t\treturn prev.concat(tuples);\r\n\t\t\t}, []);\r\n\t\t\tvar attrText = attrNodes.map(function (node) {\r\n\t\t\t\treturn node[1].getAttribute(node[0]);\r\n\t\t\t}).join('  ||  ');\r\n\r\n\t\t\treturn Promise.all([\r\n\t\t\t\tthis.translate(text),\r\n\t\t\t\tthis.translate(attrText),\r\n\t\t\t]).then(function (ref) {\r\n\t\t\t\tvar translated = ref[0];\r\n\t\t\t\tvar translatedAttrs = ref[1];\r\n\t\t\t\tif (translated) {\r\n\t\t\t\t\ttranslated.split('  ||  ').forEach(function (html, i) {\r\n\t\t\t\t\t\t$(nodes[i]).replaceWith(html);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\tif (translatedAttrs) {\r\n\t\t\t\t\ttranslatedAttrs.split('  ||  ').forEach(function (text, i) {\r\n\t\t\t\t\t\tattrNodes[i][1].setAttribute(attrNodes[i][0], text);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t};\r\n\r\n\t\t/**\r\n\t\t * Get the language of the current environment, falling back to defaults\r\n\t\t * @returns {string}\r\n\t\t */\r\n\t\tTranslator.getLanguage = function getLanguage() {\r\n\t\t\tvar lang;\r\n\r\n\t\t\tif (typeof window === 'object' && window.config && window.utils) {\r\n\t\t\t\tlang = utils.params().lang || config.userLang || config.defaultLang || 'en-GB';\r\n\t\t\t} else {\r\n\t\t\t\tvar meta = require('../../../src/meta');\r\n\t\t\t\tlang = meta.config && meta.config.defaultLang ? meta.config.defaultLang : 'en-GB';\r\n\t\t\t}\r\n\r\n\t\t\treturn lang;\r\n\t\t};\r\n\r\n\t\t/**\r\n\t\t * Create and cache a new Translator instance, or return a cached one\r\n\t\t * @param {string} [language] - ('en-GB') Language string\r\n\t\t * @returns {Translator}\r\n\t\t */\r\n\t\tTranslator.create = function create(language) {\r\n\t\t\tif (!language) {\r\n\t\t\t\tlanguage = Translator.getLanguage();\r\n\t\t\t}\r\n\r\n\t\t\tTranslator.cache[language] = Translator.cache[language] || new Translator(language);\r\n\r\n\t\t\treturn Translator.cache[language];\r\n\t\t};\r\n\r\n\t\tTranslator.cache = {};\r\n\r\n\t\t/**\r\n\t\t * Register a custom module to handle translations\r\n\t\t * @param {string} namespace - Namespace to handle translation for\r\n\t\t * @param {Function} factory - Function to return the translation function for this namespace\r\n\t\t */\r\n\t\tTranslator.registerModule = function registerModule(namespace, factory) {\r\n\t\t\tTranslator.moduleFactories[namespace] = factory;\r\n\r\n\t\t\tObject.keys(Translator.cache).forEach(function (key) {\r\n\t\t\t\tvar translator = Translator.cache[key];\r\n\t\t\t\ttranslator.modules[namespace] = factory(translator.lang);\r\n\t\t\t});\r\n\t\t};\r\n\r\n\t\tTranslator.moduleFactories = {};\r\n\r\n\t\t/**\r\n\t\t * Remove the translator patterns from text\r\n\t\t * @param {string} text\r\n\t\t * @returns {string}\r\n\t\t */\r\n\t\tTranslator.removePatterns = function removePatterns(text) {\r\n\t\t\tvar len = text.length;\r\n\t\t\tvar cursor = 0;\r\n\t\t\tvar lastBreak = 0;\r\n\t\t\tvar level = 0;\r\n\t\t\tvar out = '';\r\n\t\t\tvar sub;\r\n\r\n\t\t\twhile (cursor < len) {\r\n\t\t\t\tsub = text.slice(cursor, cursor + 2);\r\n\t\t\t\tif (sub === '[[') {\r\n\t\t\t\t\tif (level === 0) {\r\n\t\t\t\t\t\tout += text.slice(lastBreak, cursor);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tlevel += 1;\r\n\t\t\t\t\tcursor += 2;\r\n\t\t\t\t} else if (sub === ']]') {\r\n\t\t\t\t\tlevel -= 1;\r\n\t\t\t\t\tcursor += 2;\r\n\t\t\t\t\tif (level === 0) {\r\n\t\t\t\t\t\tlastBreak = cursor;\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tcursor += 1;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tout += text.slice(lastBreak, cursor);\r\n\t\t\treturn out;\r\n\t\t};\r\n\r\n\t\t/**\r\n\t\t * Escape translator patterns in text\r\n\t\t * @param {string} text\r\n\t\t * @returns {string}\r\n\t\t */\r\n\t\tTranslator.escape = function escape(text) {\r\n\t\t\treturn typeof text === 'string' ? text.replace(/\\[\\[/g, '&lsqb;&lsqb;').replace(/\\]\\]/g, '&rsqb;&rsqb;') : text;\r\n\t\t};\r\n\r\n\t\t/**\r\n\t\t * Unescape escaped translator patterns in text\r\n\t\t * @param {string} text\r\n\t\t * @returns {string}\r\n\t\t */\r\n\t\tTranslator.unescape = function unescape(text) {\r\n\t\t\treturn typeof text === 'string' ?\r\n\t\t\t\ttext.replace(/&lsqb;/g, '[').replace(/\\\\\\[/g, '[')\r\n\t\t\t\t\t.replace(/&rsqb;/g, ']').replace(/\\\\\\]/g, ']') :\r\n\t\t\t\ttext;\r\n\t\t};\r\n\r\n\t\t/**\r\n\t\t * Construct a translator pattern\r\n\t\t * @param {string} name - Translation name\r\n\t\t * @param {...string} arg - Optional argument for the pattern\r\n\t\t */\r\n\t\tTranslator.compile = function compile() {\r\n\t\t\tvar args = Array.prototype.slice.call(arguments, 0).map(function (text) {\r\n\t\t\t\t// escape commas and percent signs in arguments\r\n\t\t\t\treturn String(text).replace(/%/g, '&#37;').replace(/,/g, '&#44;');\r\n\t\t\t});\r\n\r\n\t\t\treturn '[[' + args.join(', ') + ']]';\r\n\t\t};\r\n\r\n\t\treturn Translator;\r\n\t}());\r\n\r\n\t/**\r\n\t * @exports translator\r\n\t */\r\n\tvar adaptor = {\r\n\t\t/**\r\n\t\t * The Translator class\r\n\t\t */\r\n\t\tTranslator: Translator,\r\n\r\n\t\tcompile: Translator.compile,\r\n\t\tescape: Translator.escape,\r\n\t\tunescape: Translator.unescape,\r\n\t\tgetLanguage: Translator.getLanguage,\r\n\r\n\t\tflush: function () {\r\n\t\t\tObject.keys(Translator.cache).forEach(function (code) {\r\n\t\t\t\tTranslator.cache[code].translations = {};\r\n\t\t\t});\r\n\t\t},\r\n\r\n\t\tflushNamespace: function (namespace) {\r\n\t\t\tObject.keys(Translator.cache).forEach(function (code) {\r\n\t\t\t\tif (Translator.cache[code] &&\r\n\t\t\t\t\tTranslator.cache[code].translations &&\r\n\t\t\t\t\tTranslator.cache[code].translations[namespace]\r\n\t\t\t\t) {\r\n\t\t\t\t\tTranslator.cache[code].translations[namespace] = null;\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t},\r\n\r\n\r\n\t\t/**\r\n\t\t * Legacy translator function for backwards compatibility\r\n\t\t */\r\n\t\ttranslate: function translate(text, language, callback) {\r\n\t\t\t// TODO: deprecate?\r\n\r\n\t\t\tvar cb = callback;\r\n\t\t\tvar lang = language;\r\n\t\t\tif (typeof language === 'function') {\r\n\t\t\t\tcb = language;\r\n\t\t\t\tlang = null;\r\n\t\t\t}\r\n\r\n\t\t\tif (!(typeof text === 'string' || text instanceof String) || text === '') {\r\n\t\t\t\tif (cb) {\r\n\t\t\t\t\treturn setTimeout(cb, 0, '');\r\n\t\t\t\t}\r\n\t\t\t\treturn '';\r\n\t\t\t}\r\n\r\n\t\t\treturn Translator.create(lang).translate(text).then(function (output) {\r\n\t\t\t\tif (cb) {\r\n\t\t\t\t\tsetTimeout(cb, 0, output);\r\n\t\t\t\t}\r\n\t\t\t\treturn output;\r\n\t\t\t}, function (err) {\r\n\t\t\t\twarn('Translation failed: ' + err.stack);\r\n\t\t\t});\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * Add translations to the cache\r\n\t\t */\r\n\t\taddTranslation: function addTranslation(language, namespace, translation) {\r\n\t\t\tTranslator.create(language).getTranslation(namespace).then(function (translations) {\r\n\t\t\t\tassign(translations, translation);\r\n\t\t\t});\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * Get the translations object\r\n\t\t */\r\n\t\tgetTranslations: function getTranslations(language, namespace, callback) {\r\n\t\t\tcallback = callback || function () {};\r\n\t\t\tTranslator.create(language).getTranslation(namespace).then(callback);\r\n\t\t},\r\n\r\n\t\t/**\r\n\t\t * Alias of getTranslations\r\n\t\t */\r\n\t\tload: function load(language, namespace, callback) {\r\n\t\t\tadaptor.getTranslations(language, namespace, callback);\r\n\t\t},\r\n\r\n\t\ttoggleTimeagoShorthand: function toggleTimeagoShorthand(callback) {\r\n\t\t\t/* eslint \"prefer-object-spread\": \"off\" */\r\n\t\t\tfunction toggle() {\r\n\t\t\t\tvar tmp = assign({}, jQuery.timeago.settings.strings);\r\n\t\t\t\tjQuery.timeago.settings.strings = assign({}, adaptor.timeagoShort);\r\n\t\t\t\tadaptor.timeagoShort = assign({}, tmp);\r\n\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\tcallback();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!adaptor.timeagoShort) {\r\n\t\t\t\tvar languageCode = utils.userLangToTimeagoCode(config.userLang);\r\n\t\t\t\tif (!config.timeagoCodes.includes(languageCode + '-short')) {\r\n\t\t\t\t\tlanguageCode = 'en';\r\n\t\t\t\t}\r\n\r\n\t\t\t\tvar originalSettings = assign({}, jQuery.timeago.settings.strings);\r\n\t\t\t\tadaptor.switchTimeagoLanguage(languageCode + '-short', function () {\r\n\t\t\t\t\tadaptor.timeagoShort = assign({}, jQuery.timeago.settings.strings);\r\n\t\t\t\t\tjQuery.timeago.settings.strings = assign({}, originalSettings);\r\n\t\t\t\t\ttoggle();\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\ttoggle();\r\n\t\t\t}\r\n\t\t},\r\n\r\n\t\tswitchTimeagoLanguage: function switchTimeagoLanguage(langCode, callback) {\r\n\t\t\t// Delete the cached shorthand strings if present\r\n\t\t\tdelete adaptor.timeagoShort;\r\n\r\n\t\t\tvar stringsModule = 'timeago/locales/jquery.timeago.' + langCode;\r\n\t\t\t// without undef, requirejs won't load the strings a second time\r\n\t\t\trequire.undef(stringsModule);\r\n\t\t\trequire([stringsModule], function () {\r\n\t\t\t\tcallback();\r\n\t\t\t});\r\n\t\t},\r\n\r\n\t\tprepareDOM: function prepareDOM() {\r\n\t\t\t// Add directional code if necessary\r\n\t\t\tadaptor.translate('[[language:dir]]', function (value) {\r\n\t\t\t\tif (value && !$('html').attr('data-dir')) {\r\n\t\t\t\t\tjQuery('html').css('direction', value).attr('data-dir', value);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t},\r\n\t};\r\n\r\n\treturn adaptor;\r\n}));\r\n"]}