{"version":3,"sources":["node_modules/nodebb-plugin-composer-default/static/lib/composer/uploads.js"],"names":["define","preview","categoryList","translator","uploads","inProgress","uploadingText","initialize","post_uuid","initializeDragAndDrop","initializePaste","addChangeHandlers","addTopicThumbHandlers","translate","translated","postContainer","$","find","on","e","files","target","this","val","name","type","utils","fileMimeType","uploadContentFiles","route","trigger","resetInputFile","addClass","preventDefault","urlEl","setTimeout","url","removeClass","attr","$el","wrap","closest","get","reset","unwrap","draggingDocument","drop","onDragEnter","css","height","show","hide","off","onDragDrop","originalEvent","dataTransfer","fd","length","window","FormData","i","append","formData","cancel","document","event","items","clipboardData","some","call","item","blob","getAsFile","blobName","generateUUID","fileNames","escapeRegExp","text","replace","insertText","str","index","insert","slice","params","textarea","uploadForm","doneUploading","config","relative_path","cid","getSelectedCid","ajaxify","data","isImage","match","app","user","privileges","alertError","filenameMapping","push","Date","now","size","parseInt","maximumFileSize","getCursorPosition","prop","map","filename","test","submit","updateTextArea","trim","newFilename","current","re","RegExp","ajaxSubmit","headers","x-csrf-token","csrf_token","resetForm","clearForm","error","xhr","onUploadError","uploadProgress","position","total","percent","success","res","response","images","render","focus","complete","pop","msg","responseJSON","status","message","statusText"],"mappings":"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","file":"node_modules/nodebb-plugin-composer-default/static/lib/composer/uploads.js","sourcesContent":["'use strict';\n\n/* globals $, window, document, ajaxify, FormData, define, utils, config, app */\n\ndefine('composer/uploads', [\n\t'composer/preview',\n\t'composer/categoryList',\n\t'translator',\n\t'jquery-form',\n], function (preview, categoryList, translator) {\n\tvar uploads = {\n\t\tinProgress: {},\n\t};\n\n\tvar uploadingText = '';\n\n\tuploads.initialize = function (post_uuid) {\n\t\tinitializeDragAndDrop(post_uuid);\n\t\tinitializePaste(post_uuid);\n\n\t\taddChangeHandlers(post_uuid);\n\t\taddTopicThumbHandlers(post_uuid);\n\t\ttranslator.translate('[[modules:composer.uploading, ' + 0 + '%]]', function (translated) {\n\t\t\tuploadingText = translated;\n\t\t});\n\t};\n\n\tfunction addChangeHandlers(post_uuid) {\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\n\n\t\tpostContainer.find('#files').on('change', function (e) {\n\t\t\tvar files = (e.target || {}).files ||\n\t\t\t\t($(this).val() ? [{ name: $(this).val(), type: utils.fileMimeType($(this).val()) }] : null);\n\t\t\tif (files) {\n\t\t\t\tuploadContentFiles({ files: files, post_uuid: post_uuid, route: '/api/post/upload' });\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction addTopicThumbHandlers(post_uuid) {\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\n\n\t\tpostContainer.on('click', '.topic-thumb-clear-btn', function (e) {\n\t\t\tpostContainer.find('input#topic-thumb-url').val('').trigger('change');\n\t\t\tresetInputFile(postContainer.find('input#topic-thumb-file'));\n\t\t\t$(this).addClass('hide');\n\t\t\te.preventDefault();\n\t\t});\n\n\t\tpostContainer.on('paste change keypress', 'input#topic-thumb-url', function () {\n\t\t\tvar urlEl = $(this);\n\t\t\tsetTimeout(function () {\n\t\t\t\tvar url = urlEl.val();\n\t\t\t\tif (url) {\n\t\t\t\t\tpostContainer.find('.topic-thumb-clear-btn').removeClass('hide');\n\t\t\t\t} else {\n\t\t\t\t\tresetInputFile(postContainer.find('input#topic-thumb-file'));\n\t\t\t\t\tpostContainer.find('.topic-thumb-clear-btn').addClass('hide');\n\t\t\t\t}\n\t\t\t\tpostContainer.find('img.topic-thumb-preview').attr('src', url);\n\t\t\t}, 100);\n\t\t});\n\t}\n\n\tfunction resetInputFile($el) {\n\t\t$el.wrap('<form />').closest('form').get(0).reset();\n\t\t$el.unwrap();\n\t}\n\n\tfunction initializeDragAndDrop(post_uuid) {\n\t\tvar draggingDocument = false;\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\n\t\tvar drop = postContainer.find('.imagedrop');\n\n\t\tfunction onDragEnter() {\n\t\t\tif (draggingDocument) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tdrop.css('top', '0px');\n\t\t\tdrop.css('height', postContainer.height() + 'px');\n\t\t\tdrop.css('line-height', postContainer.height() + 'px');\n\t\t\tdrop.show();\n\n\t\t\tdrop.on('dragleave', function () {\n\t\t\t\tdrop.hide();\n\t\t\t\tdrop.off('dragleave');\n\t\t\t});\n\t\t}\n\n\t\tfunction onDragDrop(e) {\n\t\t\te.preventDefault();\n\t\t\tvar files = e.originalEvent.dataTransfer.files;\n\t\t\tvar fd;\n\n\t\t\tif (files.length) {\n\t\t\t\tif (window.FormData) {\n\t\t\t\t\tfd = new FormData();\n\t\t\t\t\tfor (var i = 0; i < files.length; ++i) {\n\t\t\t\t\t\tfd.append('files[]', files[i], files[i].name);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tuploadContentFiles({\n\t\t\t\t\tfiles: files,\n\t\t\t\t\tpost_uuid: post_uuid,\n\t\t\t\t\troute: '/api/post/upload',\n\t\t\t\t\tformData: fd,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tdrop.hide();\n\t\t\treturn false;\n\t\t}\n\n\t\tfunction cancel(e) {\n\t\t\te.preventDefault();\n\t\t\treturn false;\n\t\t}\n\n\t\t$(document)\n\t\t\t.off('dragstart')\n\t\t\t.on('dragstart', function () {\n\t\t\t\tdraggingDocument = true;\n\t\t\t})\n\t\t\t.off('dragend')\n\t\t\t.on('dragend', function () {\n\t\t\t\tdraggingDocument = false;\n\t\t\t});\n\n\t\tpostContainer.on('dragenter', onDragEnter);\n\n\t\tdrop.on('dragover', cancel);\n\t\tdrop.on('dragenter', cancel);\n\t\tdrop.on('drop', onDragDrop);\n\t}\n\n\tfunction initializePaste(post_uuid) {\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\n\t\tpostContainer.on('paste', function (event) {\n\t\t\tvar items = (event.clipboardData || event.originalEvent.clipboardData || {}).items;\n\n\t\t\t[].some.call(items, function (item) {\n\t\t\t\tvar blob = item.getAsFile();\n\n\t\t\t\tif (!blob) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar blobName = utils.generateUUID() + '-' + blob.name;\n\n\t\t\t\tvar fd = null;\n\t\t\t\tif (window.FormData) {\n\t\t\t\t\tfd = new FormData();\n\t\t\t\t\tfd.append('files[]', blob, blobName);\n\t\t\t\t}\n\n\t\t\t\tuploadContentFiles({\n\t\t\t\t\tfiles: [blob],\n\t\t\t\t\tfileNames: [blobName],\n\t\t\t\t\tpost_uuid: post_uuid,\n\t\t\t\t\troute: '/api/post/upload',\n\t\t\t\t\tformData: fd,\n\t\t\t\t});\n\n\t\t\t\treturn true;\n\t\t\t});\n\t\t});\n\t}\n\n\tfunction escapeRegExp(text) {\n\t\treturn text.replace(/[-[\\]{}()*+?.,\\\\^$|#\\s]/g, '\\\\$&');\n\t}\n\n\tfunction insertText(str, index, insert) {\n\t\treturn str.slice(0, index) + insert + str.slice(index);\n\t}\n\n\tfunction uploadContentFiles(params) {\n\t\tvar files = [...params.files];\n\t\tvar post_uuid = params.post_uuid;\n\t\tvar postContainer = $('.composer[data-uuid=\"' + post_uuid + '\"]');\n\t\tvar textarea = postContainer.find('textarea');\n\t\tvar text = textarea.val();\n\t\tvar uploadForm = postContainer.find('#fileForm');\n\t\tvar doneUploading = false;\n\t\tuploadForm.attr('action', config.relative_path + params.route);\n\n\t\tvar cid = categoryList.getSelectedCid();\n\t\tif (!cid && ajaxify.data.cid) {\n\t\t\tcid = ajaxify.data.cid;\n\t\t}\n\t\tvar i = 0;\n\t\tvar isImage = false;\n\t\tfor (i = 0; i < files.length; ++i) {\n\t\t\tisImage = files[i].type.match(/image./);\n\t\t\tif ((isImage && !app.user.privileges['upload:post:image']) || (!isImage && !app.user.privileges['upload:post:file'])) {\n\t\t\t\treturn app.alertError('[[error:no-privileges]]');\n\t\t\t}\n\t\t}\n\n\t\tvar filenameMapping = [];\n\n\t\tfor (i = 0; i < files.length; ++i) {\n\t\t\t// The filename map has datetime and iterator prepended so that they can be properly tracked even if the\n\t\t\t// filenames are identical.\n\t\t\tfilenameMapping.push(i + '_' + Date.now() + '_' + (params.fileNames ? params.fileNames[i] : files[i].name));\n\t\t\tisImage = files[i].type.match(/image./);\n\n\t\t\tif (files[i].size > parseInt(config.maximumFileSize, 10) * 1024) {\n\t\t\t\tuploadForm[0].reset();\n\t\t\t\treturn app.alertError('[[error:file-too-big, ' + config.maximumFileSize + ']]');\n\t\t\t}\n\n\t\t\ttext = insertText(text, textarea.getCursorPosition(), (isImage ? '!' : '') + '[' + filenameMapping[i] + '](' + uploadingText + ') ');\n\t\t}\n\t\tif (uploadForm.length) {\n\t\t\tpostContainer.find('[data-action=\"post\"]').prop('disabled', true);\n\t\t}\n\t\ttextarea.val(text);\n\n\t\t$(window).trigger('action:composer.uploadStart', {\n\t\t\tpost_uuid: post_uuid,\n\t\t\tfiles: filenameMapping.map(function (filename, i) {\n\t\t\t\treturn {\n\t\t\t\t\tfilename: filename.replace(/^\\d+_\\d{13}_/, ''),\n\t\t\t\t\tisImage: /image./.test(files[i].type),\n\t\t\t\t};\n\t\t\t}),\n\t\t\ttext: uploadingText,\n\t\t});\n\n\t\tuploadForm.off('submit').submit(function () {\n\t\t\tfunction updateTextArea(filename, text, trim) {\n\t\t\t\tvar newFilename;\n\t\t\t\tif (trim) {\n\t\t\t\t\tnewFilename = filename.replace(/^\\d+_\\d{13}_/, '');\n\t\t\t\t}\n\t\t\t\tvar current = textarea.val();\n\t\t\t\tvar re = new RegExp(escapeRegExp(filename) + ']\\\\([^)]+\\\\)', 'g');\n\t\t\t\ttextarea.val(current.replace(re, (newFilename || filename) + '](' + text + ')'));\n\n\t\t\t\t$(window).trigger('action:composer.uploadUpdate', {\n\t\t\t\t\tpost_uuid: post_uuid,\n\t\t\t\t\tfilename: filename,\n\t\t\t\t\ttext: text,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tuploads.inProgress[post_uuid] = uploads.inProgress[post_uuid] || [];\n\t\t\tuploads.inProgress[post_uuid].push(1);\n\n\t\t\tif (params.formData) {\n\t\t\t\tparams.formData.append('cid', cid);\n\t\t\t}\n\n\t\t\t$(this).ajaxSubmit({\n\t\t\t\theaders: {\n\t\t\t\t\t'x-csrf-token': config.csrf_token,\n\t\t\t\t},\n\t\t\t\tresetForm: true,\n\t\t\t\tclearForm: true,\n\t\t\t\tformData: params.formData,\n\t\t\t\tdata: { cid: cid },\n\n\t\t\t\terror: function (xhr) {\n\t\t\t\t\tpostContainer.find('[data-action=\"post\"]').prop('disabled', false);\n\t\t\t\t\tonUploadError(xhr, post_uuid);\n\t\t\t\t},\n\n\t\t\t\tuploadProgress: function (event, position, total, percent) {\n\t\t\t\t\ttranslator.translate('[[modules:composer.uploading, ' + percent + '%]]', function (translated) {\n\t\t\t\t\t\tif (doneUploading) {\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tfor (var i = 0; i < files.length; ++i) {\n\t\t\t\t\t\t\tupdateTextArea(filenameMapping[i], translated);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t},\n\n\t\t\t\tsuccess: function (res) {\n\t\t\t\t\tconst uploads = res.response.images;\n\t\t\t\t\tdoneUploading = true;\n\t\t\t\t\tif (uploads && uploads.length) {\n\t\t\t\t\t\tfor (var i = 0; i < uploads.length; ++i) {\n\t\t\t\t\t\t\tuploads[i].filename = filenameMapping[i].replace(/^\\d+_\\d{13}_/, '');\n\t\t\t\t\t\t\tuploads[i].isImage = /image./.test(files[i].type);\n\t\t\t\t\t\t\tupdateTextArea(filenameMapping[i], uploads[i].url, true);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tpreview.render(postContainer);\n\t\t\t\t\ttextarea.focus();\n\t\t\t\t\tpostContainer.find('[data-action=\"post\"]').prop('disabled', false);\n\t\t\t\t\t$(window).trigger('action:composer.upload', {\n\t\t\t\t\t\tpost_uuid: post_uuid,\n\t\t\t\t\t\tfiles: uploads,\n\t\t\t\t\t});\n\t\t\t\t},\n\n\t\t\t\tcomplete: function () {\n\t\t\t\t\tuploadForm[0].reset();\n\t\t\t\t\tuploads.inProgress[post_uuid].pop();\n\t\t\t\t},\n\t\t\t});\n\n\t\t\treturn false;\n\t\t});\n\n\t\tuploadForm.submit();\n\t}\n\n\tfunction onUploadError(xhr, post_uuid) {\n\t\tvar msg = (xhr.responseJSON &&\n\t\t\t(xhr.responseJSON.error || (xhr.responseJSON.status && xhr.responseJSON.status.message))) ||\n\t\t\t'[[error:parse-error]]';\n\n\t\tif (xhr && xhr.status === 413) {\n\t\t\tmsg = xhr.statusText || 'Request Entity Too Large';\n\t\t}\n\t\tapp.alertError(msg);\n\t\t$(window).trigger('action:composer.uploadError', {\n\t\t\tpost_uuid: post_uuid,\n\t\t\tmessage: msg,\n\t\t});\n\t}\n\n\treturn uploads;\n});\n\n"]}