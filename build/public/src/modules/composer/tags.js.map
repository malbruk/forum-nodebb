{"version":3,"sources":["node_modules/nodebb-plugin-composer-default/static/lib/composer/tags.js"],"names":["define","tags","minTags","maxTags","init","postContainer","postData","tagEl","find","length","ajaxify","data","hasOwnProperty","config","minimumTagsPerTopic","maximumTagsPerTopic","tagsinput","confirmKeys","trimValue","input","on","event","reachedMaxTags","getTags","attr","cleanTag","utils","cleanUpTag","item","maximumTagLength","different","cancel","minimumTagLength","app","alertError","cid","socket","emit","tag","err","allowed","message","$","window","trigger","autocomplete","toggleTagInput","loadJQueryUI","delay","position","my","at","collision","appendTo","open","this","css","source","request","response","query","term","select","triggerEnter","addTags","isEnoughTags","post_uuid","minTagCount","onChangeCategory","categoryData","tagDropdown","toggleClass","tagWhitelist","parseAndTranslate","html","slice","forEach","indexOf","removeAttr","privileges","tagsInput","e","jQuery","Event","which","keyCode","setTimeout","i"],"mappings":"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","file":"node_modules/nodebb-plugin-composer-default/static/lib/composer/tags.js","sourcesContent":["\n'use strict';\n\n/* globals jQuery, ajaxify, define, config, socket, app, utils, $, window */\n\ndefine('composer/tags', function () {\n\tvar tags = {};\n\n\tvar minTags;\n\tvar maxTags;\n\n\ttags.init = function (postContainer, postData) {\n\t\tvar tagEl = postContainer.find('.tags');\n\t\tif (!tagEl.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tminTags = ajaxify.data.hasOwnProperty('minTags') ? ajaxify.data.minTags : config.minimumTagsPerTopic;\n\t\tmaxTags = ajaxify.data.hasOwnProperty('maxTags') ? ajaxify.data.maxTags : config.maximumTagsPerTopic;\n\n\t\ttagEl.tagsinput({\n\t\t\tconfirmKeys: [13, 44],\n\t\t\ttrimValue: true,\n\t\t});\n\t\tvar input = postContainer.find('.bootstrap-tagsinput input');\n\n\t\ttagEl.on('beforeItemAdd', function (event) {\n\t\t\tvar reachedMaxTags = maxTags && maxTags <= tags.getTags(postContainer.attr('data-uuid')).length;\n\t\t\tvar cleanTag = utils.cleanUpTag(event.item, config.maximumTagLength);\n\t\t\tvar different = cleanTag !== event.item;\n\t\t\tevent.cancel = different ||\n\t\t\t\tevent.item.length < config.minimumTagLength ||\n\t\t\t\tevent.item.length > config.maximumTagLength ||\n\t\t\t\treachedMaxTags;\n\n\t\t\tif (event.item.length < config.minimumTagLength) {\n\t\t\t\treturn app.alertError('[[error:tag-too-short, ' + config.minimumTagLength + ']]');\n\t\t\t} else if (event.item.length > config.maximumTagLength) {\n\t\t\t\treturn app.alertError('[[error:tag-too-long, ' + config.maximumTagLength + ']]');\n\t\t\t} else if (reachedMaxTags) {\n\t\t\t\treturn app.alertError('[[error:too-many-tags, ' + maxTags + ']]');\n\t\t\t}\n\t\t\tif (different) {\n\t\t\t\ttagEl.tagsinput('add', cleanTag);\n\t\t\t}\n\t\t});\n\n\t\ttagEl.on('itemAdded', function (event) {\n\t\t\tvar cid = postData.hasOwnProperty('cid') ? postData.cid : ajaxify.data.cid;\n\t\t\tsocket.emit('topics.isTagAllowed', { tag: event.item, cid: cid || 0 }, function (err, allowed) {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t}\n\t\t\t\tif (!allowed) {\n\t\t\t\t\treturn tagEl.tagsinput('remove', event.item);\n\t\t\t\t}\n\t\t\t\t$(window).trigger('action:tag.added', { cid: cid, tagEl: tagEl, tag: event.item });\n\t\t\t\tif (input.length) {\n\t\t\t\t\tinput.autocomplete('close');\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\n\t\ttoggleTagInput(postContainer, postData, ajaxify.data);\n\n\t\tapp.loadJQueryUI(function () {\n\t\t\tinput.autocomplete({\n\t\t\t\tdelay: 100,\n\t\t\t\tposition: { my: 'left bottom', at: 'left top', collision: 'flip' },\n\t\t\t\tappendTo: postContainer.find('.bootstrap-tagsinput'),\n\t\t\t\topen: function () {\n\t\t\t\t\t$(this).autocomplete('widget').css('z-index', 20000);\n\t\t\t\t},\n\t\t\t\tsource: function (request, response) {\n\t\t\t\t\tsocket.emit('topics.autocompleteTags', {\n\t\t\t\t\t\tquery: request.term,\n\t\t\t\t\t\tcid: postData.cid,\n\t\t\t\t\t}, function (err, tags) {\n\t\t\t\t\t\tif (err) {\n\t\t\t\t\t\t\treturn app.alertError(err.message);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (tags) {\n\t\t\t\t\t\t\tresponse(tags);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t$('.ui-autocomplete a').attr('data-ajaxify', 'false');\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tselect: function (/* event, ui */) {\n\t\t\t\t\t// when autocomplete is selected from the dropdown simulate a enter key down to turn it into a tag\n\t\t\t\t\ttriggerEnter(input);\n\t\t\t\t},\n\t\t\t});\n\n\t\t\taddTags(postData.tags, tagEl);\n\t\t});\n\n\t\tinput.attr('tabIndex', tagEl.attr('tabIndex'));\n\t\tinput.on('blur', function () {\n\t\t\ttriggerEnter(input);\n\t\t});\n\n\t\t$('[component=\"composer/tag/dropdown\"]').on('click', 'li', function () {\n\t\t\tvar tag = $(this).attr('data-tag');\n\t\t\tif (tag) {\n\t\t\t\taddTags([tag], tagEl);\n\t\t\t}\n\t\t\treturn false;\n\t\t});\n\t};\n\n\ttags.isEnoughTags = function (post_uuid) {\n\t\treturn tags.getTags(post_uuid).length >= minTags;\n\t};\n\n\ttags.minTagCount = function () {\n\t\treturn minTags;\n\t};\n\n\ttags.onChangeCategory = function (postContainer, postData, cid, categoryData) {\n\t\tvar tagDropdown = postContainer.find('[component=\"composer/tag/dropdown\"]');\n\t\tif (!tagDropdown.length) {\n\t\t\treturn;\n\t\t}\n\n\t\ttoggleTagInput(postContainer, postData, categoryData);\n\t\ttagDropdown.toggleClass('hidden', !categoryData.tagWhitelist || !categoryData.tagWhitelist.length);\n\t\tif (categoryData.tagWhitelist) {\n\t\t\tapp.parseAndTranslate('composer', 'tagWhitelist', { tagWhitelist: categoryData.tagWhitelist }, function (html) {\n\t\t\t\ttagDropdown.find('.dropdown-menu').html(html);\n\t\t\t});\n\t\t}\n\t};\n\n\tfunction toggleTagInput(postContainer, postData, data) {\n\t\tvar tagEl = postContainer.find('.tags');\n\t\tvar input = postContainer.find('.bootstrap-tagsinput input');\n\t\tif (!input.length) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (data.hasOwnProperty('minTags')) {\n\t\t\tminTags = data.minTags;\n\t\t}\n\t\tif (data.hasOwnProperty('maxTags')) {\n\t\t\tmaxTags = data.maxTags;\n\t\t}\n\n\t\tif (data.tagWhitelist && data.tagWhitelist.length) {\n\t\t\tinput.attr('readonly', '');\n\t\t\tinput.attr('placeholder', '');\n\n\t\t\ttagEl.tagsinput('items').slice().forEach(function (tag) {\n\t\t\t\tif (data.tagWhitelist.indexOf(tag) === -1) {\n\t\t\t\t\ttagEl.tagsinput('remove', tag);\n\t\t\t\t}\n\t\t\t});\n\t\t} else {\n\t\t\tinput.removeAttr('readonly');\n\t\t\tinput.attr('placeholder', postContainer.find('input.tags').attr('placeholder'));\n\t\t}\n\n\t\tpostContainer.find('.tags-container').toggleClass('hidden', (\n\t\t\tdata.privileges && data.privileges.hasOwnProperty('topics:tag') && !data.privileges['topics:tag']) ||\n\t\t\t(maxTags === 0 && !postData.tags.length)\n\t\t);\n\n\t\tif (data.privileges && data.privileges.hasOwnProperty('topics:tag') && !data.privileges['topics:tag']) {\n\t\t\ttagEl.tagsinput('removeAll');\n\t\t}\n\n\t\t$(window).trigger('action:tag.toggleInput', {\n\t\t\tpostContainer: postContainer,\n\t\t\ttagWhitelist: data.tagWhitelist,\n\t\t\ttagsInput: input,\n\t\t});\n\t}\n\n\tfunction triggerEnter(input) {\n\t\t// http://stackoverflow.com/a/3276819/583363\n\t\tvar e = jQuery.Event('keypress');\n\t\te.which = 13;\n\t\te.keyCode = 13;\n\t\tsetTimeout(function () {\n\t\t\tinput.trigger(e);\n\t\t}, 100);\n\t}\n\n\tfunction addTags(tags, tagEl) {\n\t\tif (tags && tags.length) {\n\t\t\tfor (var i = 0; i < tags.length; ++i) {\n\t\t\t\ttagEl.tagsinput('add', tags[i]);\n\t\t\t}\n\t\t}\n\t}\n\n\ttags.getTags = function (post_uuid) {\n\t\treturn $('.composer[data-uuid=\"' + post_uuid + '\"] .tags').tagsinput('items');\n\t};\n\n\treturn tags;\n});\n"]}