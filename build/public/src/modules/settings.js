"use strict";define("settings",["hooks"],function(e){var t=["settings/checkbox","settings/number","settings/textarea","settings/select","settings/array","settings/key","settings/object","settings/sorted-list"];var n;var i=[];var a=0;var r;function s(e,t){var i;var a;if(typeof e!=="string"){e=$(e);e=e.data("type")||e.attr("type")||e.prop("tagName")}a=n.plugins[e.toLowerCase()];if(a==null){return}i=a[t];if(typeof i==="function"){return i}return null}r={deepClone:function(e){if(typeof e==="object"){return JSON.parse(JSON.stringify(e))}return e},createElement:function(e,t,n){var i=document.createElement(e);for(var a in t){if(t.hasOwnProperty(a)){i.setAttribute(a,t[a])}}if(n){i.appendChild(document.createTextNode(n))}return i},initElement:function(e){var t=s(e,"init");if(t!=null){t.call(n,$(e))}},destructElement:function(e){var t=s(e,"destruct");if(t!=null){t.call(n,$(e))}},createElementOfType:function(e,t,i){var a;var l=s(e,"create");if(l!=null){a=$(l.call(n,e,t,i))}else{if(i==null){i={}}if(e!=null){i.type=e}a=$(r.createElement(t||"input",i))}a.data("type",e);r.initElement(a);return a},cleanArray:function(e,t,n){var i=[];if(!t&&n){return e}for(var a=0;a<e.length;a+=1){var r=e[a];if(t){if(r===!!r){r=+r}else if(r&&typeof r.trim==="function"){r=r.trim()}}if(n||r!=null&&r.length){i.push(r)}}return i},isTrue:function(e){return e==="true"||+e===1},isFalse:function(e){return e==="false"||+e===0},readValue:function(e){var t=!r.isFalse(e.data("empty"));var i=!r.isFalse(e.data("trim"));var a=e.data("split");var l=s(e,"get");var f;if(l!=null){return l.call(n,e,i,t)}if(a!=null){t=r.isTrue(e.data("empty"));f=e.val();var u=f!=null&&f.split(a||",")||[];return r.cleanArray(u,i,t)}f=e.val();if(i&&f!=null&&typeof f.trim==="function"){f=f.trim()}if(t||f!==undefined&&(f==null||f.length!==0)){return f}},fillField:function(e,t){var i=s(e,"set");var a=e.data("trim");a=a!=="false"&&+a!==0;if(i!=null){return i.call(n,e,t,a)}if(t instanceof Array){t=t.join(e.data("split")||(a?", ":","))}if(a&&t&&typeof t.trim==="function"){t=t.trim();if(typeof t.toString==="function"){t=t.toString()}}else if(t!=null){if(typeof t.toString==="function"){t=t.toString()}if(a){t=t.trim()}}else{t=""}if(t!==undefined){e.val(t)}},initFields:function(e){$("[data-key]",e).each(function(e,t){t=$(t);var i=s(t,"init");var a=t.data("key").split(".");var l=n.get();if(i!=null){i.call(n,t)}for(var f=0;f<a.length;f+=1){var u=a[f];if(u&&l!=null){l=l[u]}}r.fillField(t,l)})},registerReadyJobs:function(e){a+=e;return a},beforeReadyJobsDecreased:function(e){if(e==null){e=1}if(a>0){a-=e;if(a<=0){for(var t=0;t<i.length;t+=1){i[t]()}i=[]}}},whenReady:function(e){if(a<=0){e()}else{i.push(e)}},serializeForm:function(e){var t=e.serializeObject();e.find('input[type="checkbox"]').each(function(e,n){n=$(n);if(!n.is(":checked")){t[n.attr("name")]="off"}});e.find("select[multiple]").each(function(e,n){n=$(n);t[n.attr("name")]=JSON.stringify(n.val())});return t},persistSettings:function(e,t,n,i){if(t!=null&&t._!=null&&typeof t._!=="string"){t=r.deepClone(t);t._=JSON.stringify(t._)}socket.emit("admin.settings.set",{hash:e,values:t},function(e){if(n){if(e){app.alert({title:"Settings Not Saved",type:"danger",message:"NodeBB failed to save the settings.",timeout:5e3})}else{app.alert({title:"Settings Saved",type:"success",message:"Settings have been successfully saved",timeout:2500})}}if(typeof i==="function"){i(e)}})},use:function(e){try{e._=JSON.parse(e._)}catch(e){}n.cfg=e}};n={helper:r,plugins:{},cfg:{},get:function(){if(n.cfg!=null&&n.cfg._!==undefined){return n.cfg._}return n.cfg},registerPlugin:function(e,t){if(t==null){t=e.types}else{e.types=t}if(typeof e.use==="function"){e.use.call(n)}for(var i=0;i<t.length;i+=1){var a=t[i].toLowerCase();if(n.plugins[a]==null){n.plugins[a]=e}}},set:function(e,t,n,i,a){if(a==null){a=true}r.whenReady(function(){r.use(t);r.initFields(n||"form");r.persistSettings(e,t,a,i)})},sync:function(e,t,n){socket.emit("admin.settings.get",{hash:e},function(e,i){if(e){if(typeof n==="function"){n(e)}}else{r.whenReady(function(){r.use(i);r.initFields(t||"form");if(typeof n==="function"){n()}})}})},persist:function(e,t,i,a){var s=[];var l=$("[data-key]",t||"form").toArray();if(a==null){a=true}for(var f=0;f<l.length;f+=1){var u=$(l[f]);var o=r.readValue(u);var c=n.get();var d=u.data("key").split(".");var g=d[d.length-1];if(d.length>1){for(var p=0;p<d.length-1;p+=1){var v=d[p];if(v&&c!=null){c=c[v]}}}if(c!=null){if(o!=null){c[g]=o}else{delete c[g]}}else{s.push(u.data("key"))}}if(s.length){app.alert({title:"Attributes Not Saved",message:"'"+s.join(", ")+"' could not be saved. Please contact the plugin-author!",type:"danger",timeout:5e3})}r.persistSettings(e,n.cfg,a,i)},load:function(t,i,a){a=a||function(){};var l=i.attr("data-socket-get");socket.emit(l||"admin.settings.get",{hash:t},function(f,u){if(f){return a(f)}$(i).find("select[multiple]").each(function(e,t){var n=$(t).attr("name");if(n&&u.hasOwnProperty(n)){try{u[n]=JSON.parse(u[n])}catch(e){}}});ajaxify.data[l?t:"settings"]=u;r.whenReady(function(){$(i).find("[data-sorted-list]").each(function(e,i){s(i,"get").call(n,$(i),t)})});$(i).deserialize(u);$(i).find('input[type="checkbox"]').each(function(){$(this).parents(".mdl-switch").toggleClass("is-checked",$(this).is(":checked"))});e.fire("action:admin.settingsLoaded");$(i).on("change","input, select, textarea",function(){app.flags=app.flags||{};app.flags._unsaved=true});var o=document.getElementById("save");if(o){require(["mousetrap"],function(e){e.bind("ctrl+s",function(e){o.click();e.preventDefault()})})}a(null,u)})},save:function(e,t,i){t=$(t);if(t.length){var a=r.serializeForm(t);r.whenReady(function(){var e=t.find("[data-sorted-list]");if(e.length){e.each((e,t)=>{s(t,"set").call(n,$(t),a)})}});var l=t.attr("data-socket-set");socket.emit(l||"admin.settings.set",{hash:e,values:a},function(t){app.flags._unsaved=false;ajaxify.data[l?e:"settings"]=a;if(typeof i==="function"){i(t)}else if(t){app.alert({title:"Error while saving settings",type:"error",timeout:2500})}else{app.alert({title:"Settings Saved",type:"success",timeout:2500})}})}}};r.registerReadyJobs(1);require(t,function(){for(var e=0;e<arguments.length;e+=1){n.registerPlugin(arguments[e])}r.beforeReadyJobsDecreased()});return n});
//# sourceMappingURL=settings.js.map