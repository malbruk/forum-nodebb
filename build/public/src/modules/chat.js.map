{"version":3,"sources":["public/src/modules/chat.js"],"names":["define","components","taskbar","translator","module","newMessage","loadChatsDropdown","chatsListEl","socket","emit","uid","app","user","after","err","data","alertError","message","rooms","filter","room","teaser","toggleTimeagoShorthand","i","length","timeago","$","Date","parseInt","timestamp","parseAndTranslate","html","find","not","remove","prepend","createUserTooltips","off","on","ev","target","parents","roomId","this","attr","ajaxify","currentPage","match","openChat","go","userslug","onChatMessageReceived","isSelf","self","modalExists","addMessageToModal","template","chats","roomData","users","silent","createModal","modal","getModal","username","fromUser","require","ChatsMessages","messageId","appendChatMessage","is","updateActive","isAtBottom","scrollToBottom","toggleNew","isFocused","push","title","roomName","touid","onUserStatusChange","updateUserStatus","status","onRoomRename","newTitle","newName","text","update","window","trigger","Object","assign","callback","scrollStop","Chats","chatModal","uuid","utils","generateUUID","dragged","css","appendTo","center","loadJQueryUI","resizable","handles","minHeight","minWidth","event","ui","originalSize","height","size","calculateChatListHeight","draggable","start","stop","focus","distance","handle","apply","close","gotoChats","get","val","one","minimize","e","which","addActionHandlers","addRenameHandler","addLeaveHandler","addSendHandlers","addMemberHandler","createAutoComplete","addScrollHandler","addScrollBottomHandler","addCharactersLeftHandler","addIPHandler","addSocketListeners","icon","state","focusInput","clearInterval","discard","disableMobileBehaviour","closeByUUID","hideAfter","hasClass","removeClass","Math","max","width","outerWidth","scrollLeft","outerHeight","addClass","load","env","findBootstrapEnvironment","enableMobileBehaviour","modalEl","toggleNavbar","messagesEl","resize"],"mappings":"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","file":"public/src/modules/chat.js","sourcesContent":["'use strict';\r\n\r\ndefine('chat', [\r\n\t'components',\r\n\t'taskbar',\r\n\t'translator',\r\n], function (components, taskbar, translator) {\r\n\tvar module = {};\r\n\tvar newMessage = false;\r\n\r\n\tmodule.loadChatsDropdown = function (chatsListEl) {\r\n\t\tsocket.emit('modules.chats.getRecentChats', {\r\n\t\t\tuid: app.user.uid,\r\n\t\t\tafter: 0,\r\n\t\t}, function (err, data) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tvar rooms = data.rooms.filter(function (room) {\r\n\t\t\t\treturn room.teaser;\r\n\t\t\t});\r\n\r\n\t\t\ttranslator.toggleTimeagoShorthand(function () {\r\n\t\t\t\tfor (var i = 0; i < rooms.length; i += 1) {\r\n\t\t\t\t\trooms[i].teaser.timeago = $.timeago(new Date(parseInt(rooms[i].teaser.timestamp, 10)));\r\n\t\t\t\t}\r\n\t\t\t\ttranslator.toggleTimeagoShorthand();\r\n\t\t\t\tapp.parseAndTranslate('partials/chats/dropdown', { rooms: rooms }, function (html) {\r\n\t\t\t\t\tchatsListEl.find('*').not('.navigation-link').remove();\r\n\t\t\t\t\tchatsListEl.prepend(html);\r\n\t\t\t\t\tapp.createUserTooltips(chatsListEl, 'right');\r\n\t\t\t\t\tchatsListEl.off('click').on('click', '[data-roomid]', function (ev) {\r\n\t\t\t\t\t\tif ($(ev.target).parents('.user-link').length) {\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvar roomId = $(this).attr('data-roomid');\r\n\t\t\t\t\t\tif (!ajaxify.currentPage.match(/^chats\\//)) {\r\n\t\t\t\t\t\t\tapp.openChat(roomId);\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tajaxify.go('user/' + app.user.userslug + '/chats/' + roomId);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\t$('[component=\"chats/mark-all-read\"]').off('click').on('click', function () {\r\n\t\t\t\t\t\tsocket.emit('modules.chats.markAllRead', function (err) {\r\n\t\t\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\t\t\treturn app.alertError(err);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\r\n\tmodule.onChatMessageReceived = function (data) {\r\n\t\tvar isSelf = data.self === 1;\r\n\t\tdata.message.self = data.self;\r\n\r\n\t\tnewMessage = data.self === 0;\r\n\t\tif (module.modalExists(data.roomId)) {\r\n\t\t\taddMessageToModal(data);\r\n\t\t} else if (!ajaxify.data.template.chats) {\r\n\t\t\tsocket.emit('modules.chats.loadRoom', {\r\n\t\t\t\troomId: data.roomId,\r\n\t\t\t}, function (err, roomData) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\r\n\t\t\t\troomData.users = roomData.users.filter(function (user) {\r\n\t\t\t\t\treturn user && parseInt(user.uid, 10) !== parseInt(app.user.uid, 10);\r\n\t\t\t\t});\r\n\t\t\t\troomData.silent = true;\r\n\t\t\t\troomData.uid = app.user.uid;\r\n\t\t\t\troomData.isSelf = isSelf;\r\n\t\t\t\tmodule.createModal(roomData);\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n\r\n\tfunction addMessageToModal(data) {\r\n\t\tvar modal = module.getModal(data.roomId);\r\n\t\tvar username = data.message.fromUser.username;\r\n\t\tvar isSelf = data.self === 1;\r\n\t\trequire(['forum/chats/messages'], function (ChatsMessages) {\r\n\t\t\t// don't add if already added\r\n\t\t\tif (!modal.find('[data-mid=\"' + data.message.messageId + '\"]').length) {\r\n\t\t\t\tChatsMessages.appendChatMessage(modal.find('.chat-content'), data.message);\r\n\t\t\t}\r\n\r\n\t\t\tif (modal.is(':visible')) {\r\n\t\t\t\ttaskbar.updateActive(modal.attr('data-uuid'));\r\n\t\t\t\tif (ChatsMessages.isAtBottom(modal.find('.chat-content'))) {\r\n\t\t\t\t\tChatsMessages.scrollToBottom(modal.find('.chat-content'));\r\n\t\t\t\t}\r\n\t\t\t} else if (!ajaxify.data.template.chats) {\r\n\t\t\t\tmodule.toggleNew(modal.attr('data-uuid'), true, true);\r\n\t\t\t}\r\n\r\n\t\t\tif (!isSelf && (!modal.is(':visible') || !app.isFocused)) {\r\n\t\t\t\ttaskbar.push('chat', modal.attr('data-uuid'), {\r\n\t\t\t\t\ttitle: '[[modules:chat.chatting_with]] ' + (data.roomName || username),\r\n\t\t\t\t\ttouid: data.message.fromUser.uid,\r\n\t\t\t\t\troomId: data.roomId,\r\n\t\t\t\t\tisSelf: false,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tmodule.onUserStatusChange = function (data) {\r\n\t\tvar modal = module.getModal(data.uid);\r\n\t\tapp.updateUserStatus(modal.find('[component=\"user/status\"]'), data.status);\r\n\t};\r\n\r\n\tmodule.onRoomRename = function (data) {\r\n\t\tvar newTitle = $('<div></div>').html(data.newName).text();\r\n\t\tvar modal = module.getModal(data.roomId);\r\n\t\tmodal.find('[component=\"chat/room/name\"]').text(newTitle);\r\n\t\ttaskbar.update('chat', modal.attr('data-uuid'), {\r\n\t\t\ttitle: newTitle,\r\n\t\t});\r\n\t\t$(window).trigger('action:chat.renamed', Object.assign(data, {\r\n\t\t\tmodal: modal,\r\n\t\t}));\r\n\t};\r\n\r\n\tmodule.getModal = function (roomId) {\r\n\t\treturn $('#chat-modal-' + roomId);\r\n\t};\r\n\r\n\tmodule.modalExists = function (roomId) {\r\n\t\treturn $('#chat-modal-' + roomId).length !== 0;\r\n\t};\r\n\r\n\tmodule.createModal = function (data, callback) {\r\n\t\tcallback = callback || function () {};\r\n\t\trequire(['scrollStop', 'forum/chats', 'forum/chats/messages'], function (scrollStop, Chats, ChatsMessages) {\r\n\t\t\tapp.parseAndTranslate('chat', data, function (chatModal) {\r\n\t\t\t\tif (module.modalExists(data.roomId)) {\r\n\t\t\t\t\treturn callback(module.getModal(data.roomId));\r\n\t\t\t\t}\r\n\t\t\t\tvar uuid = utils.generateUUID();\r\n\t\t\t\tvar dragged = false;\r\n\r\n\t\t\t\tchatModal.attr('id', 'chat-modal-' + data.roomId);\r\n\t\t\t\tchatModal.attr('data-roomid', data.roomId);\r\n\t\t\t\tchatModal.attr('intervalId', 0);\r\n\t\t\t\tchatModal.attr('data-uuid', uuid);\r\n\t\t\t\tchatModal.css('position', 'fixed');\r\n\t\t\t\tchatModal.appendTo($('body'));\r\n\t\t\t\tchatModal.find('.timeago').timeago();\r\n\t\t\t\tmodule.center(chatModal);\r\n\r\n\t\t\t\tapp.loadJQueryUI(function () {\r\n\t\t\t\t\tchatModal.find('.modal-content').resizable({\r\n\t\t\t\t\t\thandles: 'n, e, s, w, se',\r\n\t\t\t\t\t\tminHeight: 250,\r\n\t\t\t\t\t\tminWidth: 400,\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tchatModal.find('.modal-content').on('resize', function (event, ui) {\r\n\t\t\t\t\t\tif (ui.originalSize.height === ui.size.height) {\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tchatModal.find('.modal-body').css('height', module.calculateChatListHeight(chatModal));\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tchatModal.draggable({\r\n\t\t\t\t\t\tstart: function () {\r\n\t\t\t\t\t\t\ttaskbar.updateActive(uuid);\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tstop: function () {\r\n\t\t\t\t\t\t\tchatModal.find('#chat-message-input').focus();\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tdistance: 10,\r\n\t\t\t\t\t\thandle: '.modal-header',\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\r\n\t\t\t\tscrollStop.apply(chatModal.find('[component=\"chat/messages\"]'));\r\n\r\n\t\t\t\tchatModal.find('#chat-close-btn').on('click', function () {\r\n\t\t\t\t\tmodule.close(chatModal);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tfunction gotoChats() {\r\n\t\t\t\t\tvar text = components.get('chat/input').val();\r\n\t\t\t\t\t$(window).one('action:ajaxify.end', function () {\r\n\t\t\t\t\t\tcomponents.get('chat/input').val(text);\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tajaxify.go('user/' + app.user.userslug + '/chats/' + chatModal.attr('data-roomid'));\r\n\t\t\t\t\tmodule.close(chatModal);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tchatModal.find('.modal-header').on('dblclick', gotoChats);\r\n\t\t\t\tchatModal.find('button[data-action=\"maximize\"]').on('click', gotoChats);\r\n\t\t\t\tchatModal.find('button[data-action=\"minimize\"]').on('click', function () {\r\n\t\t\t\t\tvar uuid = chatModal.attr('data-uuid');\r\n\t\t\t\t\tmodule.minimize(uuid);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tchatModal.on('click', ':not(.close)', function () {\r\n\t\t\t\t\ttaskbar.updateActive(chatModal.attr('data-uuid'));\r\n\r\n\t\t\t\t\tif (dragged) {\r\n\t\t\t\t\t\tdragged = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\tchatModal.on('mousemove', function (e) {\r\n\t\t\t\t\tif (e.which === 1) {\r\n\t\t\t\t\t\tdragged = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\tchatModal.on('mousemove keypress click', function () {\r\n\t\t\t\t\tif (newMessage) {\r\n\t\t\t\t\t\tsocket.emit('modules.chats.markRead', data.roomId);\r\n\t\t\t\t\t\tnewMessage = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\tChats.addActionHandlers(chatModal.find('[component=\"chat/messages\"]'), data.roomId);\r\n\t\t\t\tChats.addRenameHandler(chatModal.attr('data-roomid'), chatModal.find('[data-action=\"rename\"]'), data.roomName);\r\n\t\t\t\tChats.addLeaveHandler(chatModal.attr('data-roomid'), chatModal.find('[data-action=\"leave\"]'));\r\n\t\t\t\tChats.addSendHandlers(chatModal.attr('data-roomid'), chatModal.find('.chat-input'), chatModal.find('[data-action=\"send\"]'));\r\n\t\t\t\tChats.addMemberHandler(chatModal.attr('data-roomid'), chatModal.find('[data-action=\"members\"]'));\r\n\r\n\t\t\t\tChats.createAutoComplete(chatModal.find('[component=\"chat/input\"]'));\r\n\r\n\t\t\t\tChats.addScrollHandler(chatModal.attr('data-roomid'), data.uid, chatModal.find('.chat-content'));\r\n\t\t\t\tChats.addScrollBottomHandler(chatModal.find('.chat-content'));\r\n\r\n\t\t\t\tChats.addCharactersLeftHandler(chatModal);\r\n\t\t\t\tChats.addIPHandler(chatModal);\r\n\t\t\t\tChatsMessages.addSocketListeners();\r\n\r\n\t\t\t\ttaskbar.push('chat', chatModal.attr('data-uuid'), {\r\n\t\t\t\t\ttitle: '[[modules:chat.chatting_with]] ' + (data.roomName || (data.users.length ? data.users[0].username : '')),\r\n\t\t\t\t\troomId: data.roomId,\r\n\t\t\t\t\ticon: 'fa-comment',\r\n\t\t\t\t\tstate: '',\r\n\t\t\t\t\tisSelf: data.isSelf,\r\n\t\t\t\t}, function () {\r\n\t\t\t\t\ttaskbar.toggleNew(chatModal.attr('data-uuid'), !data.isSelf);\r\n\t\t\t\t\t$(window).trigger('action:chat.loaded', chatModal);\r\n\r\n\t\t\t\t\tif (typeof callback === 'function') {\r\n\t\t\t\t\t\tcallback(chatModal);\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tmodule.focusInput = function (chatModal) {\r\n\t\tchatModal.find('[component=\"chat/input\"]').focus();\r\n\t};\r\n\r\n\tmodule.close = function (chatModal) {\r\n\t\tvar uuid = chatModal.attr('data-uuid');\r\n\t\tclearInterval(chatModal.attr('intervalId'));\r\n\t\tchatModal.attr('intervalId', 0);\r\n\t\tchatModal.remove();\r\n\t\tchatModal.data('modal', null);\r\n\t\ttaskbar.discard('chat', uuid);\r\n\r\n\t\tif (chatModal.attr('data-mobile')) {\r\n\t\t\tmodule.disableMobileBehaviour(chatModal);\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:chat.closed', {\r\n\t\t\tuuid: uuid,\r\n\t\t\tmodal: chatModal,\r\n\t\t});\r\n\t};\r\n\r\n\t// TODO: see taskbar.js:44\r\n\tmodule.closeByUUID = function (uuid) {\r\n\t\tvar chatModal = $('.chat-modal[data-uuid=\"' + uuid + '\"]');\r\n\t\tmodule.close(chatModal);\r\n\t};\r\n\r\n\tmodule.center = function (chatModal) {\r\n\t\tvar hideAfter = false;\r\n\t\tif (chatModal.hasClass('hide')) {\r\n\t\t\tchatModal.removeClass('hide');\r\n\t\t\thideAfter = true;\r\n\t\t}\r\n\t\tchatModal.css('left', Math.max(0, (($(window).width() - $(chatModal).outerWidth()) / 2) + $(window).scrollLeft()) + 'px');\r\n\t\tchatModal.css('top', Math.max(0, ($(window).height() / 2) - ($(chatModal).outerHeight() / 2)) + 'px');\r\n\r\n\t\tif (hideAfter) {\r\n\t\t\tchatModal.addClass('hide');\r\n\t\t}\r\n\t\treturn chatModal;\r\n\t};\r\n\r\n\tmodule.load = function (uuid) {\r\n\t\trequire(['forum/chats/messages'], function (ChatsMessages) {\r\n\t\t\tvar chatModal = $('.chat-modal[data-uuid=\"' + uuid + '\"]');\r\n\t\t\tchatModal.removeClass('hide');\r\n\t\t\ttaskbar.updateActive(uuid);\r\n\t\t\tChatsMessages.scrollToBottom(chatModal.find('.chat-content'));\r\n\t\t\tmodule.focusInput(chatModal);\r\n\t\t\tsocket.emit('modules.chats.markRead', chatModal.attr('data-roomid'));\r\n\r\n\t\t\tvar env = utils.findBootstrapEnvironment();\r\n\t\t\tif (env === 'xs' || env === 'sm') {\r\n\t\t\t\tmodule.enableMobileBehaviour(chatModal);\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tmodule.enableMobileBehaviour = function (modalEl) {\r\n\t\tapp.toggleNavbar(false);\r\n\t\tmodalEl.attr('data-mobile', '1');\r\n\t\tvar messagesEl = modalEl.find('.modal-body');\r\n\t\tmessagesEl.css('height', module.calculateChatListHeight(modalEl));\r\n\t\tfunction resize() {\r\n\t\t\tmessagesEl.css('height', module.calculateChatListHeight(modalEl));\r\n\t\t\trequire(['forum/chats/messages'], function (ChatsMessages) {\r\n\t\t\t\tChatsMessages.scrollToBottom(modalEl.find('.chat-content'));\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\t$(window).on('resize', resize);\r\n\t\t$(window).one('action:ajaxify.start', function () {\r\n\t\t\tmodule.close(modalEl);\r\n\t\t\t$(window).off('resize', resize);\r\n\t\t});\r\n\t};\r\n\r\n\tmodule.disableMobileBehaviour = function () {\r\n\t\tapp.toggleNavbar(true);\r\n\t};\r\n\r\n\tmodule.calculateChatListHeight = function (modalEl) {\r\n\t\t// Formula: modal height minus header height. Simple(tm).\r\n\t\treturn modalEl.find('.modal-content').outerHeight() - modalEl.find('.modal-header').outerHeight();\r\n\t};\r\n\r\n\tmodule.minimize = function (uuid) {\r\n\t\tvar chatModal = $('.chat-modal[data-uuid=\"' + uuid + '\"]');\r\n\t\tchatModal.addClass('hide');\r\n\t\ttaskbar.minimize('chat', uuid);\r\n\t\tclearInterval(chatModal.attr('intervalId'));\r\n\t\tchatModal.attr('intervalId', 0);\r\n\t\t$(window).trigger('action:chat.minimized', {\r\n\t\t\tuuid: uuid,\r\n\t\t\tmodal: chatModal,\r\n\t\t});\r\n\t};\r\n\r\n\tmodule.toggleNew = taskbar.toggleNew;\r\n\r\n\treturn module;\r\n});\r\n"]}