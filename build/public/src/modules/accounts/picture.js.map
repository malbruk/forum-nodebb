{"version":3,"sources":["public/src/modules/accounts/picture.js"],"names":["define","pictureCropper","Picture","openChangeModal","socket","emit","uid","ajaxify","data","err","pictures","app","alertError","message","uploaded","reduce","memo","cur","type","parseAndTranslate","icon","text","bgColor","defaultAvatar","allowProfileImageUploads","iconBackgrounds","config","user","username","picture","icon:text","icon:bgColor","html","modal","bootbox","dialog","className","title","show","buttons","close","label","callback","onCloseModal","update","saveSelection","on","updateImages","selectImageType","find","removeClass","$","this","addClass","e","value","target","css","handleImageUpload","parents","each","getAttribute","radioEl","document","querySelector","checked","attr","iconBgColor","changeUserPicture","updateHeader","refresh","parseInt","theirid","yourid","querySelectorAll","forEach","el","style","onUploadComplete","urlOnServer","startsWith","relative_path","Date","now","length","uploadedpicture","onRemoveComplete","socketMethod","route","userslug","aspectRatio","paramName","paramValue","fileSize","maximumProfileImageSize","allowSkippingCrop","description","accept","allowedProfileImageExtensions","url","uploadModal","val","handleImageCrop"],"mappings":"AAAA,aAEAA,OAAO,oBACN,kBACGC,IACH,MAAMC,KAENA,EAAQC,gBAAkB,MACzBC,OAAOC,KAAK,2BACXC,IAAKC,QAAQC,KAAKF,KAChB,SAAUG,EAAKC,GACjB,GAAID,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAI3B,IAAIC,EAAWJ,EAASK,OAAO,SAAUC,EAAMC,GAC9C,OAAOD,GAAQC,EAAIC,OAAS,YAC1B,OAEHP,IAAIQ,kBAAkB,wCACrBT,SAAUA,EACVI,SAAUA,EACVM,MAAQC,KAAMd,QAAQC,KAAK,aAAcc,QAASf,QAAQC,KAAK,iBAC/De,cAAehB,QAAQC,KAAKe,cAC5BC,yBAA0BjB,QAAQC,KAAKgB,yBACvCC,gBAAiBC,OAAOD,gBACxBE,MACCrB,IAAKC,QAAQC,KAAKF,IAClBsB,SAAUrB,QAAQC,KAAKoB,SACvBC,QAAStB,QAAQC,KAAKqB,QACtBC,YAAavB,QAAQC,KAAK,aAC1BuB,eAAgBxB,QAAQC,KAAK,kBAE5B,SAAUwB,GACZ,IAAIC,EAAQC,QAAQC,QACnBC,UAAW,mBACXC,MAAO,0BACPxB,QAASmB,EACTM,KAAM,KACNC,SACCC,OACCC,MAAO,mBACPC,SAAUC,EACVP,UAAW,YAEZQ,QACCH,MAAO,0BACPC,SAAUG,MAKbZ,EAAMa,GAAG,iBAAkBC,GAC3Bd,EAAMa,GAAG,QAAS,mBAAoB,SAASE,IAC9Cf,EAAMgB,KAAK,oBAAoBC,YAAY,UAC3CC,EAAEC,MAAMC,SAAS,YAElBpB,EAAMa,GAAG,SAAU,2CAA6CQ,IAC/D,MAAMC,EAAQD,EAAEE,OAAOD,MACvBtB,EAAMgB,KAAK,cAAcQ,IAAI,mBAAoBF,KAGlDG,EAAkBzB,GAElB,SAASc,IAER,IAAKxC,QAAQC,KAAKqB,QAAS,CAC1BI,EAAMgB,KAAK,+BAA+BU,QAAQ,oBAAoBN,SAAS,cACzE,CACNpB,EAAMgB,KAAK,wBAAwBW,KAAK,WACvC,GAAIR,KAAKS,aAAa,SAAWtD,QAAQC,KAAKqB,QAAS,CACtDsB,EAAEC,MAAMO,QAAQ,oBAAoBN,SAAS,aAMhD,MAAMS,EAAUC,SAASC,mDAAmDzD,QAAQC,KAAK,qBACzF,GAAIsD,EAAS,CACZA,EAAQG,QAAU,SACZ,CAENF,SAASC,cAAc,8BAA8BC,QAAU,MAIjE,SAASpB,IACR,IAAI3B,EAAOe,EAAMgB,KAAK,2BAA2BiB,KAAK,aACtD,MAAMC,EAAcJ,SAASC,cAAc,uDAAuDT,OAAS,cAE3Ga,EAAkBlD,EAAMiD,EAAa,SAAU1D,GAC9C,GAAIA,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAG3BX,EAAQmE,aAAanD,IAAS,UAAY,GAAKe,EAAMgB,KAAK,+BAA+BiB,KAAK,OAAQC,GACtG5D,QAAQ+D,YAIV,SAAS3B,IACRV,EAAMA,MAAM,eAMhB/B,EAAQmE,aAAe,EAACxC,EAASsC,KAChC,GAAII,SAAShE,QAAQC,KAAKgE,QAAS,MAAQD,SAAShE,QAAQC,KAAKiE,OAAQ,IAAK,CAC7E,OAED,IAAK5C,GAAWtB,QAAQC,KAAKe,cAAe,CAC3CM,EAAUtB,QAAQC,KAAKe,cAExB4B,EAAE,wCAAwCtB,EAAU,OAAS,UAC7DsB,EAAE,sCAAsCtB,EAAU,OAAS,UAC3D,GAAIA,EAAS,CACZsB,EAAE,wCAAwCe,KAAK,MAAOrC,GAGvD,GAAIsC,EAAa,CAChBJ,SAASW,iBAAiB,kDAAkDC,QAASC,IACpFA,EAAGC,MAAM,oBAAsBV,OAKlC,SAAST,EAAkBzB,GAC1B,SAAS6C,EAAiBC,GACzBA,IAAgBA,EAAYC,WAAW,QAAUtD,OAAOuD,cAAgB,IAAMF,EAAc,IAAMG,KAAKC,MAEvGjF,EAAQmE,aAAaU,GAErB,GAAIxE,QAAQC,KAAKqB,SAAWtB,QAAQC,KAAKqB,QAAQuD,OAAQ,CACxDjC,EAAE,qCAAqCe,KAAK,MAAOa,GACnDxE,QAAQC,KAAK6E,gBAAkBN,MACzB,CACNxE,QAAQ+D,QAAQ,WACfnB,EAAE,qCAAqCe,KAAK,MAAOa,MAKtD,SAASO,IACR,GAAI/E,QAAQC,KAAK6E,kBAAoB9E,QAAQC,KAAKqB,QAAS,CAC1DtB,QAAQ+D,UACRpE,EAAQmE,gBAIVpC,EAAMgB,KAAK,0BAA0BH,GAAG,QAAS,WAChDb,EAAMA,MAAM,QAEZhC,EAAeqC,MACdiD,aAAc,4BACdC,MAAO9D,OAAOuD,cAAgB,aAAe1E,QAAQC,KAAKiF,SAAW,iBACrEC,YAAa,EAAI,EACjBC,UAAW,MACXC,WAAYrF,QAAQC,KAAKgE,QACzBqB,SAAUtF,QAAQC,KAAKsF,wBACvBC,kBAAmB,MACnB1D,MAAO,0BACP2D,YAAa,4BACbC,OAAQ1F,QAAQC,KAAK0F,+BACnB,SAAUC,GACZrB,EAAiBqB,KAGlB,OAAO,QAGRlE,EAAMgB,KAAK,8BAA8BH,GAAG,QAAS,WACpDb,EAAMA,MAAM,QACZtB,IAAIQ,kBAAkB,mDAAqD,SAAUiF,GACpFA,EAAYnE,MAAM,QAElBmE,EAAYnD,KAAK,eAAeH,GAAG,QAAS,WAC3C,IAAIqD,EAAMC,EAAYnD,KAAK,kBAAkBoD,MAC7C,IAAKF,EAAK,CACT,OAAO,MAGRC,EAAYnE,MAAM,QAElBhC,EAAeqG,iBACdH,IAAKA,EACLZ,aAAc,4BACdG,YAAa,EACbK,kBAAmB,MACnBJ,UAAW,MACXC,WAAYrF,QAAQC,KAAKgE,SACvBM,GAEH,OAAO,UAIT,OAAO,QAGR7C,EAAMgB,KAAK,mCAAmCH,GAAG,QAAS,WACzD1C,OAAOC,KAAK,8BACXC,IAAKC,QAAQC,KAAKgE,SAChB,SAAU/D,GACZwB,EAAMA,MAAM,QACZ,GAAIxB,EAAK,CACR,OAAOE,IAAIC,WAAWH,EAAII,SAE3ByE,QAKH,SAASlB,EAAkBlD,EAAMI,EAASoB,GACzCtC,OAAOC,KAAK,sBACXa,KAAAA,EACAI,QAAAA,EACAhB,IAAKC,QAAQC,KAAKgE,SAChB9B,GAGJ,OAAOxC","file":"public/src/modules/accounts/picture.js","sourcesContent":["'use strict';\r\n\r\ndefine('accounts/picture', [\r\n\t'pictureCropper',\r\n], (pictureCropper) => {\r\n\tconst Picture = {};\r\n\r\n\tPicture.openChangeModal = () => {\r\n\t\tsocket.emit('user.getProfilePictures', {\r\n\t\t\tuid: ajaxify.data.uid,\r\n\t\t}, function (err, pictures) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\t// boolean to signify whether an uploaded picture is present in the pictures list\r\n\t\t\tvar uploaded = pictures.reduce(function (memo, cur) {\r\n\t\t\t\treturn memo || cur.type === 'uploaded';\r\n\t\t\t}, false);\r\n\r\n\t\t\tapp.parseAndTranslate('partials/modals/change_picture_modal', {\r\n\t\t\t\tpictures: pictures,\r\n\t\t\t\tuploaded: uploaded,\r\n\t\t\t\ticon: { text: ajaxify.data['icon:text'], bgColor: ajaxify.data['icon:bgColor'] },\r\n\t\t\t\tdefaultAvatar: ajaxify.data.defaultAvatar,\r\n\t\t\t\tallowProfileImageUploads: ajaxify.data.allowProfileImageUploads,\r\n\t\t\t\ticonBackgrounds: config.iconBackgrounds,\r\n\t\t\t\tuser: {\r\n\t\t\t\t\tuid: ajaxify.data.uid,\r\n\t\t\t\t\tusername: ajaxify.data.username,\r\n\t\t\t\t\tpicture: ajaxify.data.picture,\r\n\t\t\t\t\t'icon:text': ajaxify.data['icon:text'],\r\n\t\t\t\t\t'icon:bgColor': ajaxify.data['icon:bgColor'],\r\n\t\t\t\t},\r\n\t\t\t}, function (html) {\r\n\t\t\t\tvar modal = bootbox.dialog({\r\n\t\t\t\t\tclassName: 'picture-switcher',\r\n\t\t\t\t\ttitle: '[[user:change_picture]]',\r\n\t\t\t\t\tmessage: html,\r\n\t\t\t\t\tshow: true,\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\tclose: {\r\n\t\t\t\t\t\t\tlabel: '[[global:close]]',\r\n\t\t\t\t\t\t\tcallback: onCloseModal,\r\n\t\t\t\t\t\t\tclassName: 'btn-link',\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\tupdate: {\r\n\t\t\t\t\t\t\tlabel: '[[global:save_changes]]',\r\n\t\t\t\t\t\t\tcallback: saveSelection,\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\r\n\t\t\t\tmodal.on('shown.bs.modal', updateImages);\r\n\t\t\t\tmodal.on('click', '.list-group-item', function selectImageType() {\r\n\t\t\t\t\tmodal.find('.list-group-item').removeClass('active');\r\n\t\t\t\t\t$(this).addClass('active');\r\n\t\t\t\t});\r\n\t\t\t\tmodal.on('change', 'input[type=\"radio\"][name=\"icon:bgColor\"]', (e) => {\r\n\t\t\t\t\tconst value = e.target.value;\r\n\t\t\t\t\tmodal.find('.user-icon').css('background-color', value);\r\n\t\t\t\t});\r\n\r\n\t\t\t\thandleImageUpload(modal);\r\n\r\n\t\t\t\tfunction updateImages() {\r\n\t\t\t\t\t// Check to see which one is the active picture\r\n\t\t\t\t\tif (!ajaxify.data.picture) {\r\n\t\t\t\t\t\tmodal.find('.list-group-item .user-icon').parents('.list-group-item').addClass('active');\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tmodal.find('.list-group-item img').each(function () {\r\n\t\t\t\t\t\t\tif (this.getAttribute('src') === ajaxify.data.picture) {\r\n\t\t\t\t\t\t\t\t$(this).parents('.list-group-item').addClass('active');\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// Update avatar background colour\r\n\t\t\t\t\tconst radioEl = document.querySelector(`.modal input[type=\"radio\"][value=\"${ajaxify.data['icon:bgColor']}\"]`);\r\n\t\t\t\t\tif (radioEl) {\r\n\t\t\t\t\t\tradioEl.checked = true;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// Check the first one\r\n\t\t\t\t\t\tdocument.querySelector('.modal input[type=\"radio\"]').checked = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfunction saveSelection() {\r\n\t\t\t\t\tvar type = modal.find('.list-group-item.active').attr('data-type');\r\n\t\t\t\t\tconst iconBgColor = document.querySelector('.modal.picture-switcher input[type=\"radio\"]:checked').value || 'transparent';\r\n\r\n\t\t\t\t\tchangeUserPicture(type, iconBgColor, function (err) {\r\n\t\t\t\t\t\tif (err) {\r\n\t\t\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tPicture.updateHeader(type === 'default' ? '' : modal.find('.list-group-item.active img').attr('src'), iconBgColor);\r\n\t\t\t\t\t\tajaxify.refresh();\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t\tfunction onCloseModal() {\r\n\t\t\t\t\tmodal.modal('hide');\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tPicture.updateHeader = (picture, iconBgColor) => {\r\n\t\tif (parseInt(ajaxify.data.theirid, 10) !== parseInt(ajaxify.data.yourid, 10)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (!picture && ajaxify.data.defaultAvatar) {\r\n\t\t\tpicture = ajaxify.data.defaultAvatar;\r\n\t\t}\r\n\t\t$('#header [component=\"avatar/picture\"]')[picture ? 'show' : 'hide']();\r\n\t\t$('#header [component=\"avatar/icon\"]')[!picture ? 'show' : 'hide']();\r\n\t\tif (picture) {\r\n\t\t\t$('#header [component=\"avatar/picture\"]').attr('src', picture);\r\n\t\t}\r\n\r\n\t\tif (iconBgColor) {\r\n\t\t\tdocument.querySelectorAll('[component=\"navbar\"] [component=\"avatar/icon\"]').forEach((el) => {\r\n\t\t\t\tel.style['background-color'] = iconBgColor;\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n\r\n\tfunction handleImageUpload(modal) {\r\n\t\tfunction onUploadComplete(urlOnServer) {\r\n\t\t\turlOnServer = (!urlOnServer.startsWith('http') ? config.relative_path : '') + urlOnServer + '?' + Date.now();\r\n\r\n\t\t\tPicture.updateHeader(urlOnServer);\r\n\r\n\t\t\tif (ajaxify.data.picture && ajaxify.data.picture.length) {\r\n\t\t\t\t$('#user-current-picture, img.avatar').attr('src', urlOnServer);\r\n\t\t\t\tajaxify.data.uploadedpicture = urlOnServer;\r\n\t\t\t} else {\r\n\t\t\t\tajaxify.refresh(function () {\r\n\t\t\t\t\t$('#user-current-picture, img.avatar').attr('src', urlOnServer);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction onRemoveComplete() {\r\n\t\t\tif (ajaxify.data.uploadedpicture === ajaxify.data.picture) {\r\n\t\t\t\tajaxify.refresh();\r\n\t\t\t\tPicture.updateHeader();\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tmodal.find('[data-action=\"upload\"]').on('click', function () {\r\n\t\t\tmodal.modal('hide');\r\n\r\n\t\t\tpictureCropper.show({\r\n\t\t\t\tsocketMethod: 'user.uploadCroppedPicture',\r\n\t\t\t\troute: config.relative_path + '/api/user/' + ajaxify.data.userslug + '/uploadpicture',\r\n\t\t\t\taspectRatio: 1 / 1,\r\n\t\t\t\tparamName: 'uid',\r\n\t\t\t\tparamValue: ajaxify.data.theirid,\r\n\t\t\t\tfileSize: ajaxify.data.maximumProfileImageSize,\r\n\t\t\t\tallowSkippingCrop: false,\r\n\t\t\t\ttitle: '[[user:upload_picture]]',\r\n\t\t\t\tdescription: '[[user:upload_a_picture]]',\r\n\t\t\t\taccept: ajaxify.data.allowedProfileImageExtensions,\r\n\t\t\t}, function (url) {\r\n\t\t\t\tonUploadComplete(url);\r\n\t\t\t});\r\n\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tmodal.find('[data-action=\"upload-url\"]').on('click', function () {\r\n\t\t\tmodal.modal('hide');\r\n\t\t\tapp.parseAndTranslate('partials/modals/upload_picture_from_url_modal', {}, function (uploadModal) {\r\n\t\t\t\tuploadModal.modal('show');\r\n\r\n\t\t\t\tuploadModal.find('.upload-btn').on('click', function () {\r\n\t\t\t\t\tvar url = uploadModal.find('#uploadFromUrl').val();\r\n\t\t\t\t\tif (!url) {\r\n\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tuploadModal.modal('hide');\r\n\r\n\t\t\t\t\tpictureCropper.handleImageCrop({\r\n\t\t\t\t\t\turl: url,\r\n\t\t\t\t\t\tsocketMethod: 'user.uploadCroppedPicture',\r\n\t\t\t\t\t\taspectRatio: 1,\r\n\t\t\t\t\t\tallowSkippingCrop: false,\r\n\t\t\t\t\t\tparamName: 'uid',\r\n\t\t\t\t\t\tparamValue: ajaxify.data.theirid,\r\n\t\t\t\t\t}, onUploadComplete);\r\n\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t});\r\n\t\t\t});\r\n\r\n\t\t\treturn false;\r\n\t\t});\r\n\r\n\t\tmodal.find('[data-action=\"remove-uploaded\"]').on('click', function () {\r\n\t\t\tsocket.emit('user.removeUploadedPicture', {\r\n\t\t\t\tuid: ajaxify.data.theirid,\r\n\t\t\t}, function (err) {\r\n\t\t\t\tmodal.modal('hide');\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\t\t\t\tonRemoveComplete();\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tfunction changeUserPicture(type, bgColor, callback) {\r\n\t\tsocket.emit('user.changePicture', {\r\n\t\t\ttype,\r\n\t\t\tbgColor,\r\n\t\t\tuid: ajaxify.data.theirid,\r\n\t\t}, callback);\r\n\t}\r\n\r\n\treturn Picture;\r\n});\r\n"]}