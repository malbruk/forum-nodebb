{"version":3,"sources":["public/src/modules/notifications.js"],"names":["define","translator","components","navigator","Benchpress","Tinycon","hooks","Notifications","unreadNotifs","_addShortTimeagoString","notifications","notifs","Promise","resolve","toggleTimeagoShorthand","i","length","timeago","$","Date","parseInt","datetime","on","loadNotifications","notifList","socket","emit","err","data","app","alertError","message","unread","concat","read","sort","a","b","fire","then","parseAndTranslate","html","off","ev","notifEl","this","scrollToPostIndexIfOnPage","stopPropagation","preventDefault","get","dropdown","hasClass","nid","attr","markNotification","markAllRead","liEl","parent","toggleClass","list","onNewNotification","notifData","ajaxify","currentPage","refresh","count","updateNotifCount","callback","pid","path","postEl","startsWith","config","relative_path","template","topic","scrollToIndex","notifIcon","Math","max","removeClass","addClass","payload","updateFavicon","setBubble"],"mappings":"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","file":"public/src/modules/notifications.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('notifications', [\r\n\t'translator',\r\n\t'components',\r\n\t'navigator',\r\n\t'benchpress',\r\n\t'tinycon',\r\n\t'hooks',\r\n], function (translator, components, navigator, Benchpress, Tinycon, hooks) {\r\n\tvar Notifications = {};\r\n\r\n\tvar unreadNotifs = {};\r\n\r\n\tconst _addShortTimeagoString = ({ notifications: notifs }) => new Promise((resolve) => {\r\n\t\ttranslator.toggleTimeagoShorthand(function () {\r\n\t\t\tfor (var i = 0; i < notifs.length; i += 1) {\r\n\t\t\t\tnotifs[i].timeago = $.timeago(new Date(parseInt(notifs[i].datetime, 10)));\r\n\t\t\t}\r\n\t\t\ttranslator.toggleTimeagoShorthand();\r\n\t\t\tresolve({ notifications: notifs });\r\n\t\t});\r\n\t});\r\n\thooks.on('filter:notifications.load', _addShortTimeagoString);\r\n\r\n\tNotifications.loadNotifications = function (notifList) {\r\n\t\tsocket.emit('notifications.get', null, function (err, data) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tvar notifs = data.unread.concat(data.read).sort(function (a, b) {\r\n\t\t\t\treturn parseInt(a.datetime, 10) > parseInt(b.datetime, 10) ? -1 : 1;\r\n\t\t\t});\r\n\r\n\t\t\thooks.fire('filter:notifications.load', { notifications: notifs }).then(({ notifications }) => {\r\n\t\t\t\tapp.parseAndTranslate('partials/notifications_list', { notifications }, function (html) {\r\n\t\t\t\t\tnotifList.html(html);\r\n\t\t\t\t\tnotifList.off('click').on('click', '[data-nid]', function (ev) {\r\n\t\t\t\t\t\tvar notifEl = $(this);\r\n\t\t\t\t\t\tif (scrollToPostIndexIfOnPage(notifEl)) {\r\n\t\t\t\t\t\t\tev.stopPropagation();\r\n\t\t\t\t\t\t\tev.preventDefault();\r\n\t\t\t\t\t\t\tcomponents.get('notifications/list').dropdown('toggle');\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tvar unread = notifEl.hasClass('unread');\r\n\t\t\t\t\t\tif (!unread) {\r\n\t\t\t\t\t\t\treturn;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tvar nid = notifEl.attr('data-nid');\r\n\t\t\t\t\t\tmarkNotification(nid, true);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tcomponents.get('notifications').on('click', '.mark-all-read', Notifications.markAllRead);\r\n\r\n\t\t\t\t\tnotifList.on('click', '.mark-read', function () {\r\n\t\t\t\t\t\tvar liEl = $(this).parent();\r\n\t\t\t\t\t\tvar unread = liEl.hasClass('unread');\r\n\t\t\t\t\t\tvar nid = liEl.attr('data-nid');\r\n\t\t\t\t\t\tmarkNotification(nid, unread, function () {\r\n\t\t\t\t\t\t\tliEl.toggleClass('unread');\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\treturn false;\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\thooks.fire('action:notifications.loaded', {\r\n\t\t\t\t\t\tnotifications: notifs,\r\n\t\t\t\t\t\tlist: notifList,\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t};\r\n\r\n\tNotifications.onNewNotification = function (notifData) {\r\n\t\tif (ajaxify.currentPage === 'notifications') {\r\n\t\t\tajaxify.refresh();\r\n\t\t}\r\n\r\n\t\tsocket.emit('notifications.getCount', function (err, count) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tNotifications.updateNotifCount(count);\r\n\t\t});\r\n\r\n\t\tif (!unreadNotifs[notifData.nid]) {\r\n\t\t\tunreadNotifs[notifData.nid] = true;\r\n\t\t}\r\n\t};\r\n\r\n\tfunction markNotification(nid, read, callback) {\r\n\t\tsocket.emit('notifications.mark' + (read ? 'Read' : 'Unread'), nid, function (err) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tif (read && unreadNotifs[nid]) {\r\n\t\t\t\tdelete unreadNotifs[nid];\r\n\t\t\t}\r\n\t\t\tif (callback) {\r\n\t\t\t\tcallback();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction scrollToPostIndexIfOnPage(notifEl) {\r\n\t\t// Scroll to index if already in topic (gh#5873)\r\n\t\tvar pid = notifEl.attr('data-pid');\r\n\t\tvar path = notifEl.attr('data-path');\r\n\t\tvar postEl = components.get('post', 'pid', pid);\r\n\t\tif (path.startsWith(config.relative_path + '/post/') && pid && postEl.length && ajaxify.data.template.topic) {\r\n\t\t\tnavigator.scrollToIndex(postEl.attr('data-index'), true);\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\treturn false;\r\n\t}\r\n\r\n\tNotifications.updateNotifCount = function (count) {\r\n\t\tvar notifIcon = components.get('notifications/icon');\r\n\t\tcount = Math.max(0, count);\r\n\t\tif (count > 0) {\r\n\t\t\tnotifIcon.removeClass('fa-bell-o').addClass('fa-bell');\r\n\t\t} else {\r\n\t\t\tnotifIcon.removeClass('fa-bell').addClass('fa-bell-o');\r\n\t\t}\r\n\r\n\t\tnotifIcon.toggleClass('unread-count', count > 0);\r\n\t\tnotifIcon.attr('data-content', count > 99 ? '99+' : count);\r\n\r\n\t\tvar payload = {\r\n\t\t\tcount: count,\r\n\t\t\tupdateFavicon: true,\r\n\t\t};\r\n\t\thooks.fire('action:notification.updateCount', payload);\r\n\r\n\t\tif (payload.updateFavicon) {\r\n\t\t\tTinycon.setBubble(count > 99 ? '99+' : count);\r\n\t\t}\r\n\t};\r\n\r\n\tNotifications.markAllRead = function () {\r\n\t\tsocket.emit('notifications.markAllRead', function (err) {\r\n\t\t\tif (err) {\r\n\t\t\t\tapp.alertError(err.message);\r\n\t\t\t}\r\n\t\t\tunreadNotifs = {};\r\n\t\t});\r\n\t};\r\n\r\n\treturn Notifications;\r\n});\r\n"]}